---
title: "SCAG Data Task"
author: "Zack Crowley"
date: "`r format(Sys.Date(), '%B %d, %Y')`"
output: 
    html_document:
        df_print: paged
---

```{r setup, include=FALSE}
# Set R chunk options:
## Set default options for R code chunks:
knitr::opts_chunk$set(
    echo = FALSE, 
    warning = FALSE, 
    message = FALSE,
    rows.print = 20 # display 20 rows inline and in document
    # fig.width = 6.5,
    # fig.height = 4
    )
# Prevents sci notation and sets the output of decimals to 4 (0.0000), suppresses warnings/info for tidyverse:
options(scipen = 999,
        tidyverse.quiet = TRUE,
        dplyr.summarise.inform = FALSE,
        rows.print = 20
        )

# Set here() location- working directory will be based on the project folder that this Rmd file is inside of currently:
here::i_am("SCAG_data_task_ZC.Rmd")

# Load libraries:
library(here) # package to manage file paths
library(fs)  # package to work with system file paths
library(tools) # another package to work with system file paths
library(rstudioapi) # package accessing Rstudio API 
# library(rlang) # package for R helpers
# library(rstatix)
library(magrittr) # pipe function package
library(janitor) # package for functions that help clean data
library(spatstat) # package for weighted.median() function
library(readxl) # reading excel files
library(writexl) # writing excel files
library(data.table) # package for data manipulation and reads in large files faster using fread()
library(tidycensus) # API for US Census- can access ACS PUMS directly from API- key set in .Renviron- to see use: usethis::edit_r_environ()
library(tidyverse) # package loads all tidyverse packages like dplyr, tidyselect, stringR, etc.

# library(survey) # Working with survey data
# library(srvyr) # Working with survey data with pipes

#### Functions ----
### weight_perc_table_filter()
# Function to return full table of weighted percentages by group and filtered to one value of a variable: weight_perc_table_filter()
# For use when you want to return weighted percentages of one value of a variable and by one group- e.g. people with disability (%) by county
# df = dataframe of all data, var = variable to sum over,  weight = weights, group = grouping variable, filter_value = value of a variable to filter output to.
# has and if statement to drop filter_value if NULL, which it is by default
weight_perc_table_filter <- function(df, var, weight, group, filter_value = NULL) {
    # If filter_value is not NULL:
    if (!is.null(filter_value)) {
    # Get var percentages for all:
    overall_perc <- df %>% select({{weight}}, {{var}})  %>% count(!!sym((var)), wt = !!sym((weight))) %>% mutate(total_pop = sum(n)) %>% 
                                            group_by(!!sym((var))) %>% summarize(percentage = round( (n / total_pop)*100, 2)) %>% filter(!!sym((var)) == filter_value) %>% ungroup() %>% 
                                            mutate({{group}} := "SCAG") %>% select({{group}}, percentage)
                                            

    # Get var percentages for by group:
    group_perc <- df %>% select({{weight}}, {{var}}, {{group}}) %>% group_by(!!sym((group))) %>% count(!!sym((var)), wt = !!sym((weight))) %>% mutate(total_pop = sum(n)) %>% 
                                            group_by(!!sym((var)), !!sym((group))) %>% summarize(percentage = round( (n / total_pop)*100, 2)) %>% filter(!!sym((var)) == filter_value) %>% ungroup() %>% 
                                             select({{group}}, percentage)

    # Full join all Self-care difficulty tables, and pivot_longer() to have group three columns: age_categories, group, and corresponding percentages:
    full_table <- full_join(group_perc, overall_perc, by = join_by({{group}}, percentage)) 

    return(full_table)
    
    } else { # else filter_value is NULL:
        
    # Get var percentages for all:
    overall_perc <- df %>% select({{weight}}, {{var}})  %>% count(!!sym((var)), wt = !!sym((weight))) %>% mutate(total_pop = sum(n)) %>% 
                                            group_by(!!sym((var))) %>% summarize(percentage = round( (n / total_pop)*100, 2)) %>% ungroup() %>% 
                                            mutate({{group}} := "SCAG") %>% select({{var}}, {{group}}, percentage)
                                            

    # Get var percentages for by group:
    group_perc <- df %>% select({{weight}}, {{var}}, {{group}}) %>% group_by(!!sym((group))) %>% count(!!sym((var)), wt = !!sym((weight))) %>% mutate(total_pop = sum(n)) %>% 
                                            group_by(!!sym((var)), !!sym((group))) %>% summarize(percentage = round( (n / total_pop)*100, 2)) %>% ungroup() %>% 
                                             select({{var}}, {{group}}, percentage)

    # Full join all Self-care difficulty tables, and pivot_longer() to have group three columns: age_categories, group, and corresponding percentages:
    full_table <- full_join(group_perc, overall_perc, by = join_by({{var}}, {{group}}, percentage)) 

    return(full_table)
    }
}

### 
### weight_perc_2groups() ----
# Function to return full table of weighted percentages by two groups and also able to be filtered to one value of a variable if specified: weight_perc_2groups()
# # For use when you want to return weighted percentages by two groups- e.g. HH without a vehicle (%) by county and race.
# df = dataframe of all data, var = variable to sum over,  weight = weights, group1 = grouping variable 1 (county), group2 = grouping variable 2 (race),
#  filter_value = value of a variable to filter output to, group1_levels = levels (vector) to change group1 to a factor, group2_levels = levels to change group2 to a factor
# has and if statement to drop filter_value if NULL, which it is by default group_by(across(variables_2))
weight_perc_2groups <- function(df, var, weight, group1, group2, filter_value = NULL, group1_levels = NULL, group2_levels = NULL) {
    # If filter_value is not NULL:
    if (!is.null(filter_value)) {
    # Get percent for group1 (usually county):
    group1_total <-  df %>% select({{weight}}, {{var}}, {{group1}}) %>% group_by(!!sym((group1))) %>% count(!!sym((var)), wt = !!sym((weight))) %>% mutate(total_pop = sum(n)) %>% 
                                                group_by(!!sym((var)), !!sym((group1))) %>% summarize(percentage = round( (n / total_pop)*100, 2)) %>% 
                                                filter(!!sym((var)) == filter_value) %>% ungroup() %>% mutate({{group2}} := "SCAG Region") %>% select({{group1}}, {{group2}},  percentage)

    # Get percent for group2 (usually county):
    group2_total <-  df %>% select({{weight}}, {{var}}, {{group2}}) %>% group_by(!!sym((group2))) %>% count(!!sym((var)), wt = !!sym((weight))) %>% mutate(total_pop = sum(n)) %>% 
                                                group_by(!!sym((var)), !!sym((group2))) %>% summarize(percentage = round( (n / total_pop)*100, 2)) %>% 
                                                filter(!!sym((var)) == filter_value) %>% ungroup() %>% mutate({{group1}} := "SCAG") %>% select({{group1}}, {{group2}},  percentage)

    # Get percent for group2 (usually county):
    group1_by_group2_total <-  df %>% select({{weight}}, {{var}}, {{group1}}, {{group2}}) %>% group_by(!!sym((group1)), !!sym((group2))) %>% 
                                              count(!!sym((var)), wt = !!sym((weight))) %>% mutate(total_pop = sum(n)) %>% 
                                                group_by(!!sym((var)), !!sym((group1)), !!sym((group2))) %>% summarize(percentage = round( (n / total_pop)*100, 2)) %>% 
                                                filter(!!sym((var)) == filter_value) %>% ungroup() %>% 
                                                 select({{group1}}, {{group2}},  percentage)

    # Get percent for group2 (usually county):
    total_overall <-  df %>% select({{weight}}, {{var}}) %>% count(!!sym((var)), wt = !!sym((weight))) %>% mutate(total_pop = sum(n)) %>% 
                                              group_by(!!sym((var))) %>%  summarize(percentage = round( (n / total_pop)*100, 2)) %>% 
                                                filter(!!sym((var)) == filter_value) %>% ungroup() %>%  mutate({{group1}} := "SCAG") %>% 
                                                 select({{group1}}, percentage)

    # Full join all scag_total tables:
    group1_total_overall_tbl <- full_join(group1_total, total_overall) %>% mutate(race = "SCAG Region")

    # Full join all scag_race tables, then left join scag_total_no_veh_table by county:
    full_table <- full_join(group1_by_group2_total,group1_total_overall_tbl) %>% full_join(.,group2_total) 
    
    } else { # else filter_value is NULL:
        
    # Get percent for group1 (usually county):
    group1_total <-  df %>% select({{weight}}, {{var}}, {{group1}}) %>% group_by(!!sym((group1))) %>% count(!!sym((var)), wt = !!sym((weight))) %>% mutate(total_pop = sum(n)) %>% 
                                                group_by(!!sym((var)), !!sym((group1))) %>% summarize(percentage = round( (n / total_pop)*100, 2)) %>% ungroup() %>% 
                                                mutate({{group2}} := "SCAG Region") %>% select({{group1}}, {{group2}},  percentage)

    # Get percent for group2 (usually county):
    group2_total <-  df %>% select({{weight}}, {{var}}, {{group2}}) %>% group_by(!!sym((group2))) %>% count(!!sym((var)), wt = !!sym((weight))) %>% mutate(total_pop = sum(n)) %>% 
                                                group_by(!!sym((var)), !!sym((group2))) %>% summarize(percentage = round( (n / total_pop)*100, 2)) %>% ungroup() %>% 
                                                mutate({{group1}} := "SCAG") %>% select({{group1}}, {{group2}},  percentage)

    # Get percent for group2 (usually county):
    group1_by_group2_total <-  df %>% select({{weight}}, {{var}}, {{group1}}, {{group2}}) %>% group_by(!!sym((group1)), !!sym((group2))) %>% 
                                              count(!!sym((var)), wt = !!sym((weight))) %>% mutate(total_pop = sum(n)) %>% 
                                                group_by(!!sym((var)), !!sym((group1)), !!sym((group2))) %>% 
                                                summarize(percentage = round( (n / total_pop)*100, 2)) %>% ungroup() %>% 
                                                 select({{group1}}, {{group2}},  percentage)

    # Get percent for group2 (usually county):
    total_overall <-  df %>% select({{weight}}, {{var}}) %>% count(!!sym((var)), wt = !!sym((weight))) %>% mutate(total_pop = sum(n)) %>% 
                                              group_by(!!sym((var))) %>%  summarize(percentage = round( (n / total_pop)*100, 2)) %>% ungroup() %>%  
                                                mutate({{group1}} := "SCAG") %>% select({{group1}}, percentage)

    # Full join all scag_total tables:
    group1_total_overall_tbl <- full_join(group1_total, total_overall) %>% mutate(race = "SCAG Region")

    # Full join all scag_race tables, then left join scag_total_no_veh_table by county:
    full_table <- full_join(group1_by_group2_total,group1_total_overall_tbl) %>% full_join(.,group2_total)
    
    } # End of main if/else.
    
    if (!is.null(group1_levels) & !is.null(group2_levels)) {
        
    # If levels are provided for both group1_levels and group2_levels- set each as a factor with levels and then arrange by group1,group2:
    full_table <- full_table %>% mutate({{group1}} := factor(!!sym((group1)), levels = group1_levels),
                                        {{group2}} := factor(!!sym((group2)), levels = group2_levels)) %>% 
                                 arrange(!!sym((group1)),!!sym((group2)))
    } 
    
    return(full_table)
} # end of weight_perc_2groups()

##### Variables/lists for functions
# Set up county and race levels to use later on to convert each to factors and arrange tables:
# county_levels:
county_levels <- c("Imperial", "Los Angeles", "Orange", "Riverside", "San Bernardino", "Ventura", "SCAG")

# race_levels:
race_levels <- c("Asian/Pacific Islander", "Black", "Hispanic/Latino", "Multiracial/Other", "Native American", "White", "SCAG Region")

#### Data Dictionaries ----
### 2021 ACS: 
## Get data dictionary as tibble from tidycensus for 2021:
# pums_vars_acs5 <- pums_variables %>%
#   filter(year == 2021, survey == "acs5")
# # person level
# pums_vars_acs5_person <- pums_variables %>%
#   filter(year == 2021, survey == "acs5", level == "person")
# # housing level:
# pums_vars_acs5_housing <- pums_variables %>%
#    filter(year == 2021, survey == "acs5", level == "housing")
# 
# # Write out data dicts for all vars, person and housing vars:
# write_csv(pums_vars_acs5, "data_dicts_ACS_PUMS/pums_vars_acs5.csv")
# write_csv(pums_vars_acs5_person, "data_dicts_ACS_PUMS/pums_vars_acs5_person.csv")
# write_csv(pums_vars_acs5_housing, "data_dicts_ACS_PUMS/pums_vars_acs5_housing.csv")
# 
# Read in data dicts from person and housing level data:
pums_vars_acs5 <- read_csv("data_dicts_ACS_PUMS/pums_vars_acs5.csv")
pums_vars_acs5_person <- read_csv("data_dicts_ACS_PUMS/pums_vars_acs5_person.csv")
pums_vars_acs5_housing <- read_csv("data_dicts_ACS_PUMS/pums_vars_acs5_housing.csv")

### 2022 ACS: Needed to scrape from website 
# library(rvest) # package for webscraping
# # Pull data dictionary from 2018-2022 ACS PUMS from website that has the data dict in a html table:
# acs_data_dict_22 <- "https://api.census.gov/data/2022/acs/acs5/pums/variables.html" %>% 
#   read_html() %>%
#   html_element("table") %>% 
#   html_table(convert = TRUE) %>% 
#   janitor::clean_names() 
# 
# # Drop first row- was incorrectly pulled in from footer of table ("525 variables") :
# acs_data_dict_22 <- acs_data_dict_22 %>% filter(name != "525 variables")
# 
# # write to csv called "acs_data_dict_22.csv:
# acs_data_dict_22 %>% write_csv(file = "data_dicts_ACS_PUMS/acs_data_dict_22.csv")

# Read in acs_data_dict_22
pums_vars_acs5_22 <- read_csv("data_dicts_ACS_PUMS/acs_data_dict_22.csv")

#### Setup file paths ----
# Set up all file paths:
# file path for all raw data:
data_fp <- here('data')
# list.files(data_fp)

### IMPORTS filepaths ---- 
# file path for 2021 5-year ACS PUMS Data:
acs_2021_fp <- here(data_fp, '2017_2021_ACS_PUMS')
# list.files(acs_2021_fp) 

# file path for 2021 person level data
person_2021_fp <- here(acs_2021_fp, "csv_pca", "psam_p06.csv")

# file path for 2021 household level data
hh_2021_fp <- here(acs_2021_fp, "csv_hca", "psam_h06.csv")

# Set up file path for 2022 5-year ACS PUMS Data:
acs_2022_fp <- here(data_fp, '2018_2022_ACS_PUMS')
# list.files(acs_2022_fp)

# file path for 2022 person level data
person_2022_fp <- here(acs_2022_fp, "csv_pca", "psam_p06.csv")

# file path for 2022 household level data
hh_2022_fp <- here(acs_2022_fp, "csv_hca", "psam_h06.csv")

### CLEAN DATA filepaths ---- 
# File paths and directories for clean data- 
# Creates a new folder called "clean_data" if it doesn't already exist in working directory:
if (!dir.exists("clean_data")) {dir.create("clean_data")}
# file path for clean_data
clean_data_fp <- here("clean_data")
# list.files(clean_data_fp)

# Clean 21 data
# Creates a new folder called "acs_data_21" (if it doesn't already exist in working directory)- this will be where the clean data for the 2021 ACS will be stored:
if (!dir.exists(here(clean_data_fp, "acs_data_21"))) {dir.create(here(clean_data_fp, "acs_data_21"))}
# file path for clean_data acs_data_21
acs_data_21_fp <- here(clean_data_fp, "acs_data_21")

# Clean 22 data
# Creates a new folder called "acs_data_22" (if it doesn't already exist in working directory)- this will be where the clean data for the 2022 ACS will be stored:
if (!dir.exists(here(clean_data_fp, 'acs_data_22'))) {dir.create(here(clean_data_fp, 'acs_data_22'))}
# file path for clean_data acs_data_22
acs_data_22_fp <- here(clean_data_fp, "acs_data_22")

# Clean ACS API data
# Creates a new folder called "acs_api" (if it doesn't already exist in working directory)- this will be where the clean data for API datawill be stored:
if (!dir.exists(here(clean_data_fp, 'acs_api'))) {dir.create(here(clean_data_fp, 'acs_api'))}
# file path for clean_data acs_data_22
acs_api_fp <- here(clean_data_fp, "acs_api")

### OUTPUTS filepaths ---- 
# output folder
# Creates a new folder called "output" (if it doesn't already exist in working directory)- this will be where the outputs from the R script will be stored:
if (!dir.exists(here('output'))) {dir.create(here('output'))}
# file path for clean_data acs_data_22
output_fp <- here("output")

# Creates a new folder called "acs_api" (if it doesn't already exist in working directory)- this will be where the individual tables for 
# the tabbed output from the R script will be stored as separate .csv's:
if (!dir.exists(here(output_fp, 'tables'))) {dir.create(here(output_fp, 'tables'))}
# file path for clean_data acs_data_22
tables_fp <- here(output_fp, 'tables')

```

## Load and Clean data from US Census American Community Survey (ACS) Public Use Microdata Sample (PUMS) File Transfer Protocol (FTP) site:

- Both 5 year estimates from 2017-2021 and 2018-2022 ACS data

### 2017-2021 ACS data from US Census ACS PUMS FTP- Load and Clean raw data:

```{r ACS 2021 FTP data}
# Total list of vars to get from ACS PUMS HHT
vars_list_pums <- c("SERIALNO", "PUMA", "ST", "SPORDER", "RELSHIPP", "PWGTP", "WGTP", "SEX", "AGEP", "HHT", "HHT2", "HISP",
                    "RAC1P", "POVPIP", "NATIVITY", "DIS", "DDRS", "DEAR", "DEYE", "DOUT", "DPHY", "DREM", "SCHL", "ESR", "JWMNP",
                    "JWTRNS", "TEN","KIT", "PLM", "WAGP", "WKHP", "ADJINC","HINCP", "VEH","RMSP", "NP", "GRPIP", "OCPIP", "POVPIP", "HICOV")

### Housing level data raw:
# Variables to pull out of raw housing data:
housing_vars_list <- c("SERIALNO", "PUMA", "ST","WGTP", "HHT", "HHT2", "TEN", "KIT", "PLM", "ADJINC", "HINCP", "VEH", "RMSP", "NP", "GRPIP", "OCPIP")

# Read in the housing level data, select only vars from housing_vars_list, convert to tibble:
housing_data <- fread(here(hh_2021_fp), select = housing_vars_list) %>% as_tibble()

### Person level data raw:
# Variables to pull out of raw housing data:
person_vars_list <- c("SERIALNO", "ST", "PUMA", "SPORDER", "RELSHIPP", "PWGTP", "SEX", "AGEP", "HISP", "RAC1P", "ENG", "NATIVITY",
                      "DIS", "DDRS", "DEAR", "DEYE", "DOUT", "DPHY", "DREM", "SCHL", "ESR", "JWMNP", "JWTRNS", "WAGP", "WKHP", "ADJINC", "POVPIP", "HICOV")
# Set up type list for read_csv:

# Read in the person level data:
person_data <- fread(here(person_2021_fp), select = person_vars_list) %>% as_tibble()

# # Merge the person level data and the housing level data- using the variable `SERIALNO`; left_join on person_data- to only keep data in person-level data:
merged_data <- person_data %>% left_join(., housing_data, by = c("SERIALNO", "ST", "PUMA", "ADJINC"))

# Write out to .csv for the raw data from ACS Data call to folder named "clean_data/acs_data_21": 1826332 obs. with 40 variables
write_csv(merged_data, here(acs_data_21_fp, "merged_acs_data.csv"))

# SCAG County list- need to convert PUMA codes to county and then filter whole raw ACS PUMS data set to only these counties:
scag_county_list <- c("Imperial",
                      "Los Angeles",
                      "Orange",
                      "Riverside",
                      "San Bernardino",
                      "Ventura")

# Mutate/case_when to replicate SAS code above for creating "county" var-
# Create couny variable with SCAG counties and filter to only those rows in SCAG Counties using scag_county_list from above:
merged_data_scag <- merged_data %>% mutate(county = case_when(PUMA == 2500 ~ "Imperial", # 25 prefix
                                                              PUMA %in% (3701:3799) ~ "Los Angeles", # 37 prefix
                                                              PUMA %in% (5901:5999) ~ "Orange", # 59 prefix
                                                              PUMA %in% (6501:6599) ~ "Riverside", # 65 prefix
                                                              PUMA %in% (7101:7199) ~ "San Bernardino", # 71 prefix
                                                              PUMA %in% (11101:11199) ~ "Ventura" # 111 prefix
                                                              )) %>%
                                          filter(county %in% scag_county_list) %>%
                                          select(SERIALNO, ST,PUMA,county, everything())

# Write out to .csv for the raw data from ACS Data call to folder named "clean_data/acs_data_21": 879241 obs. (same as API call) with 34 variables
write_csv(merged_data_scag, here(acs_data_21_fp, "merged_acs_data_scag.csv"))

# check variables from the merged_data using str() and summary():
str(merged_data)
#
# Remove all large files if no longer needed:
rm(housing_data, person_data, merged_data_scag, merged_data)

```


### 2018-2022 ACS data from US Census ACS PUMS FTP- Load and Clean raw data:

```{r ACS 2022 FTP data}
# Total list of vars to get from ACS PUMS 22- change from 21 is PUMA is in 2010 and 2020 census columns: "PUMA10" and "PUMA20"
vars_list_pums_22 <- c("SERIALNO", "PUMA10", "PUMA20", "ST", "SPORDER", "RELSHIPP", "PWGTP", "WGTP", "SEX", "AGEP", "HHT", "HHT2", "HISP",
                    "RAC1P", "POVPIP", "NATIVITY", "DIS", "DDRS", "DEAR", "DEYE", "DOUT", "DPHY", "DREM", "SCHL", "ESR", "JWMNP", "JWTRNS",
                    "TEN","KIT", "PLM", "WAGP", "WKHP", "ADJINC","HINCP", "VEH","RMSP", "NP", "GRPIP", "OCPIP", "POVPIP", "HICOV")

### Housing level data raw:
# Variables to pull out of raw housing data:
housing_vars_list_22 <- c("SERIALNO", "PUMA10", "PUMA20", "ST","WGTP", "HHT", "HHT2", "TEN", "KIT", "PLM", "ADJINC", "HINCP", "VEH", "RMSP", "NP", "GRPIP", "OCPIP")

# Read in the housing level data, select only vars from housing_vars_list, convert to tibble:
housing_data_22 <- fread(here(hh_2022_fp), select = housing_vars_list_22) %>% as_tibble()

### Person level data raw:
# Variables to pull out of raw housing data:
person_vars_list_22 <- c("SERIALNO", "ST", "PUMA10", "PUMA20", "SPORDER", "RELSHIPP", "PWGTP", "SEX", "AGEP", "HISP", "RAC1P", "ENG",
                      "NATIVITY", "DIS", "DDRS", "DEAR", "DEYE", "DOUT", "DPHY", "DREM", "SCHL", "ESR", "JWMNP", "JWTRNS", "WAGP", "WKHP", "ADJINC", "POVPIP", "HICOV")
# Set up type list for read_csv:

# Read in the person level data:
person_data_22 <- fread(here(person_2022_fp), select = person_vars_list_22) %>% as_tibble()

# # Merge the person level data and the housing level data- using the variable `SERIALNO`; left_join on person_data- to only keep data in person-level data:
merged_data_22 <- person_data_22 %>% left_join(., housing_data_22, by = c("SERIALNO", "ST", "PUMA10", "PUMA20", "ADJINC"))

# Create single PUMA code that merges the columns "PUMA10" and "PUMA20", use PUMA10 and if -9 then take in PUMA20 to replace:
merged_data_22 <- merged_data_22 %>% mutate(PUMA = case_when(PUMA10 == -9 ~ PUMA20,
                                                                     TRUE ~ PUMA10))

# Write out to .csv for the raw data from ACS Data call to folder named "clean_data/acs_data_22": 1839928 obs. with 31 variables
# write_csv(merged_data_22, here(acs_data_22_fp, "merged_acs_22.csv"))

# SCAG County list- need to convert PUMA codes to county and then filter whole raw ACS PUMS data set to only these counties:
scag_county_list <- c("Imperial",
                      "Los Angeles",
                      "Orange",
                      "Riverside",
                      "San Bernardino",
                      "Ventura")

# Mutate/case_when to replicate SAS code above for creating "county" var-
# Create couny variable with SCAG counties and filter to only those rows in SCAG Counties using scag_county_list from above:
merged_data_22_scag <- merged_data_22 %>% mutate(county = case_when(PUMA == 2500 ~ "Imperial", # 25 prefix
                                                                    PUMA %in% (3701:3799) ~ "Los Angeles", # 37 prefix
                                                                    PUMA %in% (5901:5999) ~ "Orange", # 59 prefix
                                                                    PUMA %in% (6501:6599) ~ "Riverside", # 65 prefix
                                                                    PUMA %in% (7101:7199) ~ "San Bernardino", # 71 prefix
                                                                    PUMA %in% (11101:11199) ~ "Ventura" # 111 prefix
                                                                    )) %>%
                                          filter(county %in% scag_county_list) %>%
                                          select(SERIALNO, ST,PUMA,county, everything())

# Write out to .csv for the raw data from ACS Data call to folder named "clean_data/acs_data_22":  881207 obs.  with 34 variables
# write_csv(merged_data_22_scag, here(acs_data_22_fp, "merged_acs_22_scag.csv"))

# Read in merged_data_22_scag from  here(acs_data_22_fp, "merged_acs_22_scag.csv")
merged_data_22_scag <- read_csv(here(acs_data_22_fp, "merged_acs_22_scag.csv"))

# check variables from the merged_data_22_scag using str() and summary():
# str(merged_data_22_scag)
# 
# # Remove all large files if no longer needed:
# rm(housing_data_22, person_data_22, merged_data_22_scag, merged_data_22)

```


--- 

## API Calls using tidycensus package:
<!-- TODO: Fix API calls to US Census using tidycensus -->
### CA ACS PUMS Data from 2017-2021- 5 year ACS- Census API Call: 

```{r tidycensus CA data 2021}
# pums_vars_acs5_22 <- pums_variables %>% filter(year == 2022, survey == "acs5")
# # List of vars to get from ACS PUMS 
# vars_list_pums <- c("PUMA","RELSHIPP","SEX", "AGEP", "HHT", "HISP", "RAC1P", "ENG", "NATIVITY", "DIS", "SCHL", "ESR", "JWMNP", "JWTRNS",  
#                     "TEN", "KIT", "PLM", "WAGP", "WKHP", "ADJINC", "HINCP", "VEH", 
#                     "RMSP", "NP", "GRPIP", "OCPIP", "POVPIP", "HICOV")
# # Return tibble of var_code and var_label for vars_list_pums, arrange by order of vars_list_pums: 
# pums_data_desc <- pums_vars_acs5 %>%  
#             distinct(var_code, var_label, data_type, level) %>%  
#             filter(var_code %in% vars_list_pums) %>% 
#             mutate(var_code =  factor(var_code, levels = vars_list_pums)) %>% 
#             arrange(var_code)
# # List of vars and labels: 
# #   var_code  var_label                                                                                                                                   data_type   level   
# #    <fct>    <chr>                                                                                                                                         <chr>     <chr>   
# #  1 PUMA     Public use microdata area code (PUMA) based on 2010 Census definition (areas with population of 100,000 or more, use with ST for unique code) chr       NA      
# #  2 RELSHIPP Relationship to reference person                                                                                                              chr       person  
# #  3 SEX      Sex                                                                                                                                           chr       person  
# #  4 AGEP     Age                                                                                                                                           num       person  
# #  5 HHT      Household/family type                                                                                                                         chr       housing 
# #  6 HISP     Recoded detailed Hispanic origin                                                                                                              chr       person  
# #  7 RAC1P    Recoded detailed race code                                                                                                                    chr       person  
# #  8 ENG      Ability to speak English                                                                                                                      chr       person  
# #  9 NATIVITY Nativity                                                                                                                                      chr       person  
# # 10 DIS      Disability recode                                                                                                                             chr       person  
# # 11 SCHL     Educational attainment                                                                                                                        chr       person  
# # 12 ESR      Employment status recode                                                                                                                      chr       person  
# # 13 JWMNP    Travel time to work                                                                                                                           num       person  
# # 14 JWTRNS   Means of transportation to work                                                                                                               chr       person  
# # 15 TEN      Tenure                                                                                                                                        chr       housing 
# # 16 KIT      Complete kitchen facilities                                                                                                                   chr       housing 
# # 17 PLM      Complete plumbing facilities                                                                                                                  chr       housing 
# # 18 WAGP     Wages or salary income past 12 months (use ADJINC to adjust WAGP to constant dollars)                                                         num       person  
# # 19 WKHP     Usual hours worked per week past 12 months                                                                                                    num       person  
# # 20 ADJINC   Adjustment factor for income and earnings dollar amounts (6 implied decimal places)                                                           chr       housing 
# # 21 HINCP    Household income (past 12 months, use ADJINC to adjust HINCP to constant dollars)                                                             num       housing 
# # 22 VEH      Vehicles (1 ton or less) available                                                                                                            chr       housing 
# # 23 RMSP     Number of rooms                                                                                                                               num       housing 
# # 24 NP       Number of persons associated with this housing record                                                                                         num       housing 
# # 25 GRPIP    Gross rent as a percentage of household income past 12 months                                                                                 num       housing 
# # 26 OCPIP    Selected monthly owner costs as a percentage of household income during the past 12 months                                                    num       housing 
# # 27 POVPIP   Income-to-poverty ratio recode                                                                                                                num       person 
# # Vector of PUMA codes to get from CA- ACS PUMS API Call below: 
# puma_codes_scag <- c("02500", "03701", "03702", "03703", "03704", "03705", "03706", "03707", "03708", "03709", "03710", "03711", "03712", "03713",  
#                      "03714", "03715", "03716", "03717", "03718", "03719", "03720", "03721", "03722", "03723", "03724", "03725", "03726", "03727",  
#                      "03728", "03729", "03730", "03731", "03732", "03733", "03734", "03735", "03736", "03737", "03738", "03739", "03740", "03741",  
#                      "03742", "03743", "03744", "03745", "03746", "03747", "03748", "03749", "03750", "03751", "03752", "03753", "03754", "03755",  
#                      "03756", "03757", "03758", "03759", "03760", "03761", "03762", "03763", "03764", "03765", "03766", "03767", "03768", "03769",  
#                      "05901", "05902", "05903", "05904", "05905", "05906", "05907", "05908", "05909", "05910", "05911", "05912", "05913", "05914",  
#                      "05915", "05916", "05917", "05918", "06501", "06502", "06503", "06504", "06505", "06506", "06507", "06508", "06509", "06510",  
#                      "06511", "06512","06513", "06514", "06515", "07101", "07102", "07103", "07104", "07105", "07106", "07107", "07108", "07109",  
#                      "07110", "07111", "07112", "07113", "07114", "07115", "11101", "11102", "11103", "11104", "11105", "11106")
# ### 
# # Run API call to get all California ACS PUMS data from 2017-2021- 5 year ACS: CA FIPS is 06- took about 8 minutes to download API call. 
# ca_pums <- get_pums( 
#   variables = vars_list_pums, 
#   state = "CA", # California 
#   puma = puma_codes_scag, 
#   survey = "acs5", # acs5 is the 5 year ACS PUMS 
#   year = 2021, # Gets 2017-2021 ACS PUMS if acs5 set in survey option. 
#   recode = TRUE, # recode variable values using Census data dictionary and creates a new *_label column for each variable that is recoded. 
#   show_call  = TRUE # If TRUE, display call made to Census API. 
# )
# # API CALL: Census API call: https://api.census.gov/data/2021/acs/acs5/pums?get=SERIALNO%2CSPORDER%2CWGTP%2CPWGTP%2CPUMA%2CRELSHIPP%2CSEX%2CAGEP%2CHHT%2CHISP%2CRAC1P%2CENG%2CNATIVITY%2CDIS%2CSCHL%2CESR%NP%2CJWTRNS%2CTEN%2CKIT%2CPLM%2CWAGP%2CWKHP%2CADJINC%2CVEH%2CRMSP%2CNP%2CGRPIP%2COCPIP%2CPOVPIP&ucgid=0400000US06
# # Write out to .csv for the raw data from API call to folder named "clean_data": 1826332 obs. with 49 variables 
# # write_csv(ca_pums, here(acs_api_fp, "ca_pums_raw.csv"))
# ###  
# #Read in saved API call data: 
# ca_pums <- read_csv(here(acs_api_fp, "ca_pums_raw.csv"))
# # Set cols to numeric that ended up as characters, change order of vars: 
# ca_pums <- ca_pums %>% mutate(across(PUMA:RAC1P, ~ as.numeric(.))) %>%  
#     relocate(c("PUMA", "ST", "SPORDER", "SEX", "AGEP","HHT", "HISP","RAC1P", "ENG", "NATIVITY", "DIS", "SCHL","ESR"), .after = SERIALNO)
# # Filter data to only PUMAs that we need for SCAG Region:  
# # *------ PUMA 2010 -----------------------------------; 
# # if 		  puma  =2500 then county=25; *Imperial; 
# # if 3701<= puma <=3799 then county=37; *Los Angeles; 
# # if 5901<= puma <=5999 then county=59; *Orange; 
# # if 6501<= puma <=6599 then county=65; *Riverside ; 
# # if 7101<= puma <=7199 then county=71; *San Bernardino; 
# # if 11101<= puma <=11199 then county=111; *Ventura;
# # SCAG County list- need to conver PUMA codes to county and then filter whole raw ACS PUMS data set to only these counties: 
# scag_county_list <- c("Imperial",  
#                       "Los Angeles", 
#                       "Orange", 
#                       "Riverside", 
#                       "San Bernardino",  
#                       "Ventura") 
# # Mutate/case_when to replicate SAS code above for creating "county" var-  
# # Create county variable with SCAG counties and filter to only those rows in SCAG Counties using scag_county_list from above: 
# ca_pums_scag <- ca_pums %>% mutate(county = case_when(PUMA == 2500 ~ "Imperial", # 25 prefix 
#                                       PUMA >= 3701 & PUMA <= 3799 ~ "Los Angeles", # 37 prefix 
#                                       PUMA >= 5901 & PUMA <= 5999 ~ "Orange", # 59 prefix 
#                                       PUMA >= 6501 & PUMA <= 6599 ~ "Riverside", # 65 prefix 
#                                       PUMA >= 7101 & PUMA <= 7199 ~ "San Bernardino", # 71 prefix 
#                                       PUMA >= 11101 & PUMA <= 11199 ~ "Ventura" # 111 prefix 
#                                                     )) %>%  
#                             filter(county %in% scag_county_list) %>% relocate("county", .after = ST) 
# # Write out data filtered to only SCAG counties to folder named "clean_data": 879241 obs. with 49 variables 
# # write_csv(ca_pums_scag, here(acs_api_fp, "ca_pums_scag.csv"))
# # # Read in SCAG county data from ca_pums_scag.csv: 
# ca_pums_scag <- read_csv(here(acs_api_fp, "ca_pums_scag.csv")) 
# #  
# # # Set a list of names of the columns from API call: 
# # vars_ca_pums_scag <- names(ca_pums_scag)
# # Remove all large datasets, leave ca_pums_scag 
# # rm(merged_data,merged_data_scag,housing_data,person_data,ca_pums) 
```


### CA ACS PUMS Data from 2018-2022- 5 year ACS- Census API Call:

```{r tidycensus CA data 2022} 
# # TODO: NEED TO UPDATE this section once census API is working again.  
# # List of vars to get from ACS PUMS 
# vars_list_pums_22 <- c("PUMA10", "PUMA20", "RELSHIPP","SEX", "AGEP", "HHT", "HISP", "RAC1P", "ENG", "NATIVITY", "DIS", "SCHL", "ESR", "JWMNP", "JWTRNS",  
#                     "TEN", "KIT", "PLM", "WAGP", "WKHP", "ADJINC", "HINCP", "VEH", 
#                     "RMSP", "NP", "GRPIP", "OCPIP", "POVPIP", "HICOV") 
# # Check that all vars from 21 are in 22 data: 
# # read in acs_data_dict_22 
# acs_data_dict_22 <- read_csv(file = "data_dicts_ACS_PUMS/acs_data_dict_22.csv") 
# needed_vars_acs_data_dict_22 <- acs_data_dict_22 %>% filter(name %in% vars_list_pums_22)
# # Return tibble of var_code and var_label for vars_list_pums, arrange by order of vars_list_pums: 
# # pums_data_desc <- pums_vars_acs5_22 %>%  
# #             distinct(var_code, var_label, data_type, level) %>%  
# #             filter(var_code %in% vars_list_pums) %>% 
# #             mutate(var_code =  factor(var_code, levels = vars_list_pums)) %>% 
# #             arrange(var_code)
# ###### List of vars and labels: 
# #   var_code  var_label                                                                                                                                   data_type   level   
# #    <fct>    <chr>                                                                                                                                         <chr>     <chr>   
# #  1 PUMA     Public use microdata area code (PUMA) based on 2010 Census definition (areas with population of 100,000 or more, use with ST for unique code) chr       NA      
# #  2 RELSHIPP Relationship to reference person                                                                                                              chr       person  
# #  3 SEX      Sex                                                                                                                                           chr       person  
# #  4 AGEP     Age                                                                                                                                           num       person  
# #  5 HHT      Household/family type                                                                                                                         chr       housing 
# #  6 HISP     Recoded detailed Hispanic origin                                                                                                              chr       person  
# #  7 RAC1P    Recoded detailed race code                                                                                                                    chr       person  
# #  8 ENG      Ability to speak English                                                                                                                      chr       person  
# #  9 NATIVITY Nativity                                                                                                                                      chr       person  
# # 10 DIS      Disability recode                                                                                                                             chr       person  
# # 11 SCHL     Educational attainment                                                                                                                        chr       person  
# # 12 ESR      Employment status recode                                                                                                                      chr       person  
# # 13 JWMNP    Travel time to work                                                                                                                           num       person  
# # 14 JWTRNS   Means of transportation to work                                                                                                               chr       person  
# # 15 TEN      Tenure                                                                                                                                        chr       housing 
# # 16 KIT      Complete kitchen facilities                                                                                                                   chr       housing 
# # 17 PLM      Complete plumbing facilities                                                                                                                  chr       housing 
# # 18 WAGP     Wages or salary income past 12 months (use ADJINC to adjust WAGP to constant dollars)                                                         num       person  
# # 19 WKHP     Usual hours worked per week past 12 months                                                                                                    num       person  
# # 20 ADJINC   Adjustment factor for income and earnings dollar amounts (6 implied decimal places)                                                           chr       housing 
# # 21 HINCP    Household income (past 12 months, use ADJINC to adjust HINCP to constant dollars)                                                             num       housing 
# # 22 VEH      Vehicles (1 ton or less) available                                                                                                            chr       housing 
# # 23 RMSP     Number of rooms                                                                                                                               num       housing 
# # 24 NP       Number of persons associated with this housing record                                                                                         num       housing 
# # 25 GRPIP    Gross rent as a percentage of household income past 12 months                                                                                 num       housing 
# # 26 OCPIP    Selected monthly owner costs as a percentage of household income during the past 12 months                                                    num       housing 
# # 27 POVPIP   Income-to-poverty ratio recode                                                                                                                num       person 
# # Vector of PUMA codes to get from CA- ACS PUMS API Call below: 
# puma_codes_scag <- c("02500", "03701", "03702", "03703", "03704", "03705", "03706", "03707", "03708", "03709", "03710", "03711", "03712", "03713",  
#                      "03714", "03715", "03716", "03717", "03718", "03719", "03720", "03721", "03722", "03723", "03724", "03725", "03726", "03727",  
#                      "03728", "03729", "03730", "03731", "03732", "03733", "03734", "03735", "03736", "03737", "03738", "03739", "03740", "03741",  
#                      "03742", "03743", "03744", "03745", "03746", "03747", "03748", "03749", "03750", "03751", "03752", "03753", "03754", "03755",  
#                      "03756", "03757", "03758", "03759", "03760", "03761", "03762", "03763", "03764", "03765", "03766", "03767", "03768", "03769",  
#                      "05901", "05902", "05903", "05904", "05905", "05906", "05907", "05908", "05909", "05910", "05911", "05912", "05913", "05914",  
#                      "05915", "05916", "05917", "05918", "06501", "06502", "06503", "06504", "06505", "06506", "06507", "06508", "06509", "06510",  
#                      "06511", "06512","06513", "06514", "06515", "07101", "07102", "07103", "07104", "07105", "07106", "07107", "07108", "07109",  
#                      "07110", "07111", "07112", "07113", "07114", "07115", "11101", "11102", "11103", "11104", "11105", "11106")
# ### 
# # Run API call to get all California ACS PUMS data from 2018-2022- 5 year ACS: CA FIPS is 06- took about 8 minutes to download API call. 
# ca_pums_22 <- get_pums( 
#   variables = vars_list_pums_22, 
#   state = "CA", # California 
#   puma = puma_codes_scag, 
#   survey = "acs5", # acs5 is the 5 year ACS PUMS 
#   year = 2022, # Gets 2018-2022 ACS PUMS if acs5 set in survey option. 
#   recode = TRUE, # recode variable values using Census data dictionary and creates a new *_label column for each variable that is recoded. 
#   show_call  = TRUE # If TRUE, display call made to Census API. 
# )
# # API CALL: Census API call: https://api.census.gov/data/2021/acs/acs5/pums?get=SERIALNO%2CSPORDER%2CWGTP%2CPWGTP%2CPUMA%2CRELSHIPP%2CSEX%2CAGEP%2CHHT%2CHISP%2CRAC1P%2CENG%2CNATIVITY%2CDIS%2CSCHL%2CESR%NP%2CJWTRNS%2CTEN%2CKIT%2CPLM%2CWAGP%2CWKHP%2CADJINC%2CVEH%2CRMSP%2CNP%2CGRPIP%2COCPIP%2CPOVPIP&ucgid=0400000US06
# # Write out to .csv for the raw data from API call to folder named "clean_data": 1826332 obs. with 49 variables 
# # write_csv(ca_pums, here(acs_api_fp, "ca_pums_raw.csv"))
# ###  
# #Read in saved API call data: 
# # ca_pums <- read_csv(here(acs_api_fp, "ca_pums_raw.csv"))
# # Set cols to numeric that ended up as characters, change order of vars: 
# ca_pums <- ca_pums %>% mutate(across(PUMA:RAC1P, ~ as.numeric(.))) %>%  
#     relocate(c("PUMA", "ST", "SPORDER", "SEX", "AGEP","HHT", "HISP","RAC1P", "ENG", "NATIVITY", "DIS", "SCHL","ESR"), .after = SERIALNO)
# # Filter data to only PUMAs that we need for SCAG Region:  
# # *------ PUMA 2010 -----------------------------------; 
# # if 		  puma  =2500 then county=25; *Imperial; 
# # if 3701<= puma <=3799 then county=37; *Los Angeles; 
# # if 5901<= puma <=5999 then county=59; *Orange; 
# # if 6501<= puma <=6599 then county=65; *Riverside ; 
# # if 7101<= puma <=7199 then county=71; *San Bernardino; 
# # if 11101<= puma <=11199 then county=111; *Ventura;
# # SCAG County list- need to conver PUMA codes to county and then filter whole raw ACS PUMS data set to only these counties: 
# scag_county_list <- c("Imperial",  
#                       "Los Angeles", 
#                       "Orange", 
#                       "Riverside", 
#                       "San Bernardino",  
#                       "Ventura") 
# # Mutate/case_when to replicate SAS code above for creating "county" var-  
# # Create county variable with SCAG counties and filter to only those rows in SCAG Counties using scag_county_list from above: 
# ca_pums_scag <- ca_pums %>% mutate(county = case_when(PUMA == 2500 ~ "Imperial", # 25 prefix 
#                                       PUMA >= 3701 & PUMA <= 3799 ~ "Los Angeles", # 37 prefix 
#                                       PUMA >= 5901 & PUMA <= 5999 ~ "Orange", # 59 prefix 
#                                       PUMA >= 6501 & PUMA <= 6599 ~ "Riverside", # 65 prefix 
#                                       PUMA >= 7101 & PUMA <= 7199 ~ "San Bernardino", # 71 prefix 
#                                       PUMA >= 11101 & PUMA <= 11199 ~ "Ventura" # 111 prefix 
#                                                     )) %>%  
#                             filter(county %in% scag_county_list) %>% relocate("county", .after = ST) 
# # Write out data filtered to only SCAG counties to folder named "clean_data": 879241 obs. with 49 variables 
# # write_csv(ca_pums_scag, here(acs_api_fp, "ca_pums_scag.csv"))
# # # Read in SCAG county data from ca_pums_scag.csv: 
# # ca_pums_scag <- read_csv(here(acs_api_fp, "ca_pums_scag.csv")) 
# #  
# # # Set a list of names of the columns from API call: 
# # vars_ca_pums_scag <- names(ca_pums_scag)
# # Remove all large datasets, leave ca_pums_scag 
# # rm(merged_data,merged_data_scag,housing_data,person_data,ca_pums) 
``` 


--- 

## Data Recoding and Table Creation: 

### SCAG Data from ACS PUMS:
### Recoding variables for use in ACS PUMS Analysis: 
```{r read recode SCAG data}
# Read in SCAG county data from "ca_pums_scag.csv" aka the API CALL DATA:
# ca_pums_scag <- read_csv(here(acs_api_fp, "ca_pums_scag.csv"))

# Set a list of names of the columns from API call:
# vars_ca_pums_scag <- names(ca_pums_scag)

# Read in merged ACS data SCAG- aka the US Census FTP merged DATA:
ca_pums_scag <- read_csv(here(acs_data_21_fp, "merged_acs_data_scag.csv"), show_col_types = FALSE)

# Code county as a factor variable:
ca_pums_scag <- ca_pums_scag %>% mutate(county = factor(county, levels = c("Imperial", "Los Angeles", "Orange", "Riverside", "San Bernardino", "Ventura")))

# Race and Ethnicity: named var "race" for brevity:
# SAS example-
# *------- 1. Race_Ethnicity -------------------------------------------------;
# 
# racespan=999; 
# if hisp ge 2 then racespan=1;             	*Hispanic ;
# if hisp=1 then do;
#    if RAC1P=1 then racespan=2;              *NH White;
#    if RAC1P=2 then racespan=3;              *NH Black;
#    if 6<= RAC1P <= 7 then racespan=4;       *NH Asian & PI;
#    if 3<= RAC1P <= 5 then racespan=5;       *NH Am Indian;
#    if RAC1P >= 8 then racespan=6;           *NH Other;
#    end;
# Create "race" var based on conditions above: 
ca_pums_scag <- ca_pums_scag %>% mutate(race = factor(case_when(HISP != 1  ~ "Hispanic/Latino",
                                                         HISP == 1 & RAC1P == 1 ~ "White", 
                                                         HISP == 1 & RAC1P == 2 ~ "Black", 
                                                         HISP == 1 & RAC1P %in% c(6,7) ~ "Asian/Pacific Islander", 
                                                         HISP == 1 & RAC1P %in% c(3:5) ~ "Native American", 
                                                         HISP == 1 & RAC1P %in% c(8,9) ~ "Multiracial/Other"
                                                         ), levels = c("Asian/Pacific Islander", "Black", "Hispanic/Latino", "Multiracial/Other", "Native American", "White"))
                                        ) 

# Age Categories: named var "age_3_cat"
# SAS example- 
# ac1=.;
# if AGEP < 18 then ac1=1;
# if AGEP ge 18 and AGEP le 64 then ac1=2;
# if AGEP ge 65 then ac1=3; 
# Create "age_3_cat" var based on conditions above: 
ca_pums_scag <- ca_pums_scag %>% mutate(age_3_cat = factor(case_when(AGEP < 18  ~ "<18 years",
                                                                     AGEP %in% c(18:64) ~ "18 - 64 years",
                                                                     AGEP > 64 ~ "65+ years"
                                                                     ), levels = c("<18 years", "18 - 64 years","65+ years"))
                                        ) 

# Education Categories: named var "edu"
# SAS example- 
# *------- 7.Educational attainment for the population age 25+ -------------;
# 
# edu=.;
# if AGEP>=25 then do;
# 	edu=0;
#     if SCHL ge 1 and SCHL le 15 then edu=1; *less than a high school diploma;
#     if SCHL ge 16 and SCHL le 17 then edu=2; *high school diploma;
#     if SCHL ge 18 and SCHL le 19 then edu=3; *some college;
#     if SCHL=20 then edu=4; *AA degree;
#     if SCHL=21 then edu=5; *BA degree;
#     if SCHL ge 22 then edu=6; *MA degree or higher;
# end;
# 
ca_pums_scag <- ca_pums_scag %>% mutate(edu = factor(case_when(SCHL %in% c(1:15)  ~ "Less than HS Diploma",
                                                               SCHL %in% c(16:17) ~ "HS Diploma",
                                                               SCHL %in% c(18:19) ~ "Some College",
                                                               SCHL == 20 ~ "AA Degree",
                                                               SCHL == 21 ~ "BA degree",
                                                               SCHL %in% c(22:24) ~ "MA degree or higher"
                                                               ), levels = c("Less than HS Diploma", "HS Diploma", "Some College", "AA Degree", "BA degree", "MA degree or higher"))
                                        )

###
# Homeownership: own_home
# SAS example- 
# *------- H3.Homeownership: Tenure  -------------;
# 
# *TEN Character 1
# Tenure
# b .N/A (GQ/vacant)
# 1 .Owned with mortgage or loan (include home equity loans)
# 2 .Owned free and clear
# 3 .Rented
# 4 .Occupied without payment of rent;
# 
# own=.;
# if TEN in (1 2) then own=1;
# if TEN in (3 4) then own=0;
# 
# Create "own_home" var based on conditions above: 
ca_pums_scag <- ca_pums_scag %>% mutate(own_home = factor(case_when(TEN == 1 | TEN == 2 ~ "Homeowner",
                                                             TEN == 3 | TEN == 4 ~ "Non-Homeowner"), levels = c("Homeowner", "Non-Homeowner"))
                                                          )

###
# Households without a vehicle : 
# SAS example-
# *------- H1.Percent of households without a vehicle  -------------;
# *
# VEH Character 1
# Vehicles (1 ton or less) available
# b .N/A (GQ/vacant)
# 0 .No vehicles
# 1 .1 vehicle
# 2 .2 vehicles
# 3 .3 vehicles
# 4 .4 vehicles
# 5 .5 vehicles
# 6 .6 or more vehicles
# ;
# Veh_zero=0;
# if VEH=0 then Veh_zero=1
#;
#
# VEH_label 
# "No vehicles"  "1 vehicle"  "2 vehicles"  "3 vehicles"  "4 vehicles"  "5 vehicles"  "6 or more vehicles" "N/A (GQ/vacant)"

# Means of transportation to work- code- Workers who Commute by Walk, Bike, or Public Transit: named var "walk_bike_public_transport":
# SAS example-
# *JWTRNS Character 2
# Means of transportation to work
# bb .N/A (not a worker-not in the labor force, including persons .under 16 years, unemployed, employed, with a job but not at .work, Armed Forces, with a job but not at work)
# 01 .Car, truck, or van
# 02 .Bus
# 03 .Subway or elevated rail
# 04 .Long-distance train or commuter rail
# 05 .Light rail, streetcar, or trolley
# 06 .Ferryboat
# 07 .Taxicab
# 08 .Motorcycle
# 09 .Bicycle
# 10 .Walked
# 11 .Worked from home
# 12 .Other method;
# 
# Commute=.;
# if JWTRNS=1 then Commute=1;*Private;
# if JWTRNS in (2 3 4 5 6 7) then Commute=2;*Public;
# if JWTRNS in (8 9 10 12) then Commute=3;*Other;
# 
# 
# Commute2=.;
# if JWTRNS in (1 8) then Commute2=1;*Private(car or motorcycle);
# if JWTRNS in (2 3 4 5 6 7) then Commute2=2;*Public(bus, rail, taxi or ferry);
# if JWTRNS in (9 10 12) then Commute2=3;*Other(bike, walk or other);
# Create "race" var based on conditions above: 
ca_pums_scag <- ca_pums_scag %>% mutate(walk_bike_public_transport = factor(case_when(JWTRNS %in% c(2:5,9,10)  ~ "Walk/Bike/Public",
                                                         TRUE ~ "Other Transport"), levels = c("Walk/Bike/Public","Other Transport"))
                                                         ) 
# Means of transportation to work- code- named var "all_transport"
#  Workers who Commute by bus, rail, taxi, or ferry: coded level "Public": JWTRNS %in% c(2:7)
#  Workers who Commute by Car or Motorcycle: coded level "Private": JWTRNS %in% c(1,8)
#  Workers who Commute by Walk, Bike, or Other: coded level "Other": JWTRNS %in% c(9,10,12)
# all_transport will be all forms of transportation if use not na like this: !is.na(all_transport)
ca_pums_scag <- ca_pums_scag %>% mutate(all_transport = factor(case_when(JWTRNS %in% c(1,8) ~ "Private",
                                                                  JWTRNS %in% c(2:7) ~  "Public",
                                                                  JWTRNS %in% c(9,10,12) ~ "Other"
                                                                 ), levels = c("Other", "Public","Private"))
                                        ) 
# SAS example-
# *------- P3.Average travel time to work (minutes)  -------------;
# 
# *JWMNP Numeric 3
# Travel time to work
# bbb .N/A (not a worker or worker who worked at home)
# 1..200 .1 to 200 minutes to get to work (Top-coded);


#SAS Example 
#*------- H8.Housing burden  -------------;
# *GRPIP Numeric 3
# Gross rent as a percentage of household income past 12 months
# bbb .N/A (GQ/vacant/owned or being bought/occupied without .rent payment/no household income)
# 1..100 .1% to 100%
# 101 .101% or more
# 
# OCPIP Numeric 3
# Selected monthly owner costs as a percentage of household income during the past 12 months
# bbb .N/A (GQ/vacant/not owned or being bought/no household .income)
# 1..100 .1% to 100%
# 101 .101% or more
# 
# POVPIP Numeric 3
# Income-to-poverty ratio recode
# bbb .N/A
# 0..500 .Below 501 percent
# 501 .501 percent or more;
# 
# Gross rent as a percentage of household income (Rent burden) 30% or more and 200 below percent poverty line and rent home:
# pRENTGT30_POV200=0;	
# if own=0 then do;
# 	if GRPIP>=30 and POVPIP<200 then pRENTGT30_POV200=1;
# end;
# 
# owner costs as a percentage of household income (housing cost burden) 30% or more and 200 below percent poverty line and rent home:
# pSMOCGT30_POV200=0;	
# if own=1 then do;
# 	if OCPIP>=30 and POVPIP<200 then pSMOCGT30_POV200=1;
# end;
# Housing and Rent burdens: variable for homeowner burden named: "housing_burden"; variable for homeowner burden named: "renter_burden"
ca_pums_scag <- ca_pums_scag %>% mutate(housing_burden = factor(case_when(POVPIP %in% c(0:199) & own_home == "Homeowner" & OCPIP >= 30 ~ "Yes",
                                                          TRUE ~ "No",), levels = c("Yes","No")),
                        renter_burden = factor(case_when(POVPIP %in% c(0:199) & own_home == "Non-Homeowner" & GRPIP >= 30 ~ "Yes",
                                                          TRUE ~ "No",), levels = c("Yes","No"))
                                                         ) 

# Poverty-
# Create a poverty indicator for the Poverty (REBCR Economy section) Table:
# If households lived below 200 percent of the poverty line or did not:
# pov=.;
# if 0<= POVPIP <200 then pov=1;
# if POVPIP>=200 then pov=2;
# If poverty == "Yes", the HH is below 200 percent of the poverty line:
ca_pums_scag <- ca_pums_scag %>% mutate(poverty = factor(case_when(POVPIP %in% c(0:199) ~ "Yes",
                                                                   POVPIP >= 200 ~ "No",), levels = c("Yes","No"))
                                                         )

# SAS EXAMPLE:
# *------- H6.Complete kitchen facilities  -------------;
# 
# *KIT Character 1
# Complete kitchen facilities
# b .N/A (GQ)
# 1 .Yes, has stove or range, refrigerator, and sink with a faucet
# 2 .No;
# 
# *PLM Character 1
# Complete plumbing facilities
# b .N/A (GQ)
# 1 .Yes, has hot and cold running water and a bathtub or shower .(includes flush toilet for data collected prior to 2016)
# 2 .No
# 9 .Case is from Puerto Rico, PLM recode not applicable;
# 
# Kit_Plm=1;
# if KIT=2 and PLM=2 then Kit_Plm=0; *No Kitchen and Plumbing;
# 
ca_pums_scag <- ca_pums_scag %>% mutate(no_kitchen_plumbing = factor(case_when(KIT == 2 & PLM == 2 ~ "Yes",
                                                                   KIT == 1 | PLM == 1 ~ "No",), levels = c("Yes","No"))
                                                         )


### 
# Overcrowding of households: defined as "severe overcrowding is measured as the percentage of householders that have more than 1.5 persons per room"
# named variable: "overcrowded" if "Yes", more than 1.5 people per room, "No" otherwise. 
# SAS Example:
# *RMSP Numeric 2
# Number of rooms
# bb .N/A (GQ)
# 0..99 .Rooms (Top-coded)
# 
# NP Numeric 2
# Number of persons associated with this housing record
# 0 .Vacant unit
# 1 .One person record (one person in household or any person .in group quarters)
# 2..20 .Number of person records (number of persons in household);
# 
# Overcrowd=.;
# *if RMSP>0 then do;
# 	Overcrowd=NP/RMSP;
# *end;
# 
# Overcrowding=.;
# if 0<=Overcrowd<=1 then Overcrowding=0;
# if 1<Overcrowd<1.5 then Overcrowding=1;
# if Overcrowd>=1.5 then Overcrowding=2;
# 
ca_pums_scag <- ca_pums_scag %>% mutate(crowd = case_when(RMSP > 0  ~ NP/RMSP,
                                                           TRUE ~ NA),
                                        overcrowded = factor(case_when(crowd >= 1.5  ~ "Yes",
                                                           crowd < 1.5 ~ "No"), levels = c("Yes","No"))
                                                         ) 
# Health insurance coverage
# *------- P4.Health Insurance  -------------;
# *HICOV Character 1
# Health insurance coverage recode
# 1 .With health insurance coverage
# 2 .No health insurance coverage;
# ca_pums_scag %>% select(HICOV) 

## Median Hourly wage: variable named "hourly_wage"
# if AGEP ge 25 and AGEP le 64;
# 
# if ESR in (1 2); *Civilian worker;
# 
# *WAGP Numeric 6
# Wages or salary income past 12 months (use ADJINC to adjust WAGP to constant dollars)
# bbbbbb .N/A (less than 15 years old)
# 0 .None
# 4..999999 .$4 to 999999 (Rounded and top-coded)
# 
# WKHP Numeric 2
# Usual hours worked per week past 12 months
# bb .N/A (less than 16 years old/did not work during the past .12 months)
# 1..98 .1 to 98 usual hours
# 99 .99 or more usual hours
# 
# ADJINC Character 7
# Adjustment factor for income and earnings dollar amounts (6 implied decimal places)
# 1117630 .2017 factor (1.011189 * 1.10526316)
# 1093093 .2018 factor (1.013097 * 1.07896160)
# 1070512 .2019 factor (1.010145 * 1.05976096)
# 1053131 .2020 factor (1.006149 * 1.04669465)
# 1029928 .2021 factor (1.029928 * 1.00000000)
# ;
# 
# wage=.;
# if ADJINC=1117630 then wage=WAGP*1.011189 * 1.10526316; 	*2017 Adjust Income ($2021);
# if ADJINC=1093093 then wage=WAGP*1.013097 * 1.07896160; 	*2018 Adjust Income ($2021);
# if ADJINC=1070512 then wage=WAGP*1.010145 * 1.05976096; 	*2019 Adjust Income ($2021);
# if ADJINC=1053131 then wage=WAGP*1.006149 * 1.04669465; 	*2020 Adjust Income ($2021);
# if ADJINC=1029928 then wage=WAGP*1.029928 * 1.00000000; 	*2021 Adjust Income ($2021);
# 
#  
# 
# wwage=wage/52; *1 week wage;
# 
# Hwage=0;
# if WKHP>0 then do;
# 	Hwage=wwage/WKHP; *Hourly Wage;
# end;

# First, adjust the wages with the Adjust Income for the right year for all civilian workers ages 25-64 who worked more than 0 hours per week;
# Second, get the weekly wages by dividing by 52, then divide by WKHP (usual hours worked per week)
# Finally: get hourly wage only in: 
# ca_pums_scag %>% mutate(hourly_wage = case_when(ESR %in% c(1:2) & AGEP %in% c(25:64) & WKHP > 0 & WAGP > 0 & ADJINC == 1117630 ~ WAGP * ADJINC/52/WKHP, # 2017 Adjust Income
#                                                 ESR %in% c(1:2) & AGEP %in% c(25:64) & WKHP > 0 & WAGP > 0 & ADJINC == 1093093 ~ WAGP * ADJINC/52/WKHP, # 2018 Adjust Income
#                                                 ESR %in% c(1:2) & AGEP %in% c(25:64) & WKHP > 0 & WAGP > 0 & ADJINC == 1070512 ~ WAGP * ADJINC/52/WKHP, # 2019 Adjust Income
#                                                 ESR %in% c(1:2) & AGEP %in% c(25:64) & WKHP > 0 & WAGP > 0 & ADJINC == 1053131 ~ WAGP * ADJINC/52/WKHP, # 2020 Adjust Income
#                                                 ESR %in% c(1:2) & AGEP %in% c(25:64) & WKHP > 0 & WAGP > 0 & ADJINC == 1029928 ~ WAGP * ADJINC/52/WKHP, # 2021 Adjust Income
#                                                )) 
ca_pums_scag <- ca_pums_scag %>% mutate(wage = case_when(ADJINC == 1117630 ~ WAGP * 1.011189 * 1.10526316, # 2017 Adjust Income
                                         ADJINC == 1093093 ~ WAGP * 1.013097 * 1.07896160, # 2018 Adjust Income
                                         ADJINC == 1070512 ~ WAGP * 1.010145 * 1.05976096, # 2019 Adjust Income
                                         ADJINC == 1053131 ~ WAGP * 1.006149 * 1.04669465, # 2020 Adjust Income
                                         ADJINC == 1029928 ~ WAGP * 1.029928 * 1.00000000, # 2021 Adjust Income
                                        ),
                        weekly_wage = wage/52,
                        hourly_wage = if_else(WKHP > 0,weekly_wage/WKHP, NA_real_)
                        ) 

# Unemployment -named variable "unemployed"- if "Yes", unemployed, "No" otherwise. 
# *------- 8. Employment status -------------------------------------;
# 
# *ESR Character 1
# Employment status recode
# b .N/A (less than 16 years old)
# 1 .Civilian employed, at work
# 2 .Civilian employed, with a job but not at work
# 3 .Unemployed
# 4 .Armed forces, at work
# 5 .Armed forces, with a job but not at work
# 6 .Not in labor force;
# 
# Unemployment -named variable "unemployed"- if "Yes", unemployed, "No" otherwise. 
ca_pums_scag <- ca_pums_scag %>% mutate(unemployed = factor(case_when(ESR == 3  ~ "Yes",
                                                           ESR != 3 ~ "No"), levels = c("Yes","No"))
                                                         )
###
# Single Parent Households by gender:
# Use HHT2 to create new variable named "single_hh"
# Household/family type (includes cohabiting) == HHT2
# Value       Label		
#  bb	   N/A (GQ/vacant)
#  01	   Married couple household with children of the householder less than 18
#  02	   Married couple household, no children of the householder less than 18
#  03	   Cohabiting couple household with children of the householder less than 18
#  04	   Cohabiting couple household, no children of the householder less than 18
#  05	   Female householder, no spouse/partner present, living alone
#  06	   Female householder, no spouse/partner present, with children of the householder less than 18
#  07	   Female householder, no spouse/partner present, with relatives, no children of the householder less than 18
#  08	   Female householder, no spouse/partner present, only nonrelatives present
#  09	   Male householder, no spouse/partner present, living alone
#  10	   Male householder, no spouse/partner present, with children of the householder less than 18
#  11	   Male householder, no spouse/partner present, with relatives, no children of the householder less than 18
#  12	   Male householder, no spouse/partner present, only nonrelatives present
#  
# Create new var named single_hh
# If HHT2 == 06	   Female householder, no spouse/partner present, with children of the householder less than 18
# # Then single_hh == "female_hh"
# If HHT2 == 10	   Male householder, no spouse/partner present, with children of the householder less than 18
# Then single_hh == "male_hh"
# Otherwise, single_hh == "cohabit_or_nokids"
ca_pums_scag <- ca_pums_scag %>% mutate(single_hh = factor(case_when(HHT2 == 6  ~ "female_hh",
                                                                     HHT2 == 10  ~ "male_hh",
                                                                     HHT2 %in% c(1:5,7:9,11:12) ~ "cohabit_or_nokids"
                                                                     ), levels = c("female_hh", "male_hh","cohabit_or_nokids"))
                                        )

# 
# Limited English Proficiency:     
# SAS Example:                       
# *------- 4. English Proficiency -------------------------------------;
# *ENG Character 1
# Ability to speak English
# b .N/A (less than 5 years old/speaks only English)
# 1 .Very well
# 2 .Well
# 3 .Not well
# 4 .Not at all;
#   
# New variable named "lep"
# lep == "limited_english_proficiency" if ENG == 3 | if ENG == 4
# lep == "english_proficient" if ENG == 3 | if ENG == 4
# lep == "<5yos_or_no_eng" if is.na(ENG) or TRUE
ca_pums_scag <- ca_pums_scag %>% mutate(lep = factor(case_when(ENG %in% c(3:4) ~ "limited_english_proficiency",
                                                               ENG %in% c(1:2) ~ "english_proficient",
                                                               TRUE ~ "<5yos_or_no_eng"),
                                                    levels = c("limited_english_proficiency","english_proficient","<5yos_or_no_eng")
                                                    )
                                        )

# Household Income:
# # Create new variable "housing_income" by multiplying HINCP by ADJINC for each given year:
# SAS Example
# *------- H2.Median Household Income  -------------;
# 
# *
# ADJINC Character 7
# Adjustment factor for income and earnings dollar amounts (6 implied decimal places)
# 1117630 .2017 factor (1.011189 * 1.10526316)
# 1093093 .2018 factor (1.013097 * 1.07896160)
# 1070512 .2019 factor (1.010145 * 1.05976096)
# 1053131 .2020 factor (1.006149 * 1.04669465)
# 1029928 .2021 factor (1.029928 * 1.00000000);
# 
# HHINC=.;
# if ADJINC=1117630 then HHINC=HINCP*1.011189 * 1.10526316; 	*2017 Adjust Income ($2021);
# if ADJINC=1093093 then HHINC=HINCP*1.013097 * 1.07896160; 	*2018 Adjust Income ($2021);
# if ADJINC=1070512 then HHINC=HINCP*1.010145 * 1.05976096; 	*2019 Adjust Income ($2021);
# if ADJINC=1053131 then HHINC=HINCP*1.006149 * 1.04669465; 	*2020 Adjust Income ($2021);
# if ADJINC=1029928 then HHINC=HINCP*1.029928 * 1.00000000; 	*2021 Adjust Income ($2021);

# Create new variable "housing_income" by multiplying HINCP by ADJINC for each given year:
ca_pums_scag <- ca_pums_scag %>% mutate(housing_income = case_when(ADJINC == 1117630 ~ HINCP * 1.011189 * 1.10526316, # 2017 Adjust Income
                                                                   ADJINC == 1093093 ~ HINCP * 1.013097 * 1.07896160, # 2018 Adjust Income
                                                                   ADJINC == 1070512 ~ HINCP * 1.010145 * 1.05976096, # 2019 Adjust Income
                                                                   ADJINC == 1053131 ~ HINCP * 1.006149 * 1.04669465, # 2020 Adjust Income
                                                                   ADJINC == 1029928 ~ HINCP * 1.029928 * 1.00000000, # 2021 Adjust Income
                                        )
                        ) 

###
# Set up county and race levels to use later on to convert each to factors and arrange tables:
# county_levels:
county_levels <-  c("Imperial", "Los Angeles", "Orange", "Riverside", "San Bernardino", "Ventura", "SCAG")

# race_levels:
race_levels <-  c("Asian/Pacific Islander", "Black", "Hispanic/Latino", "Multiracial/Other", "Native American", "White", "SCAG Region")

```

# Analysis and Replication of Tables and Figures for SCAG

## Tables and Figures from Equity Analysis Technical Report- (EA report)

### Figure 5. Workers who Commute by Walk, Bike, or Public Transit by Race and Ethnicity

```{r fig_5}
### 
# Figure 5. Workers who Commute by Walk, Bike, or Public Transit by Race and Ethnicity:
# Use person level weights- PWGTP:
# walk_bike_public_transport ==  "Walk/Bike/Public"
# Get percentages based on non-home workers- drop all if JWTRNS respond == 11 (use filter not equal to 11 like this (filter(JWTRNS != 11)))
# Get Walk/Bike/Public percentages by race for all SCAG non-home workers:
# scag_race_walk_bike_public <- ca_pums_scag %>% filter(JWTRNS != 11) %>% select(PWGTP, race, walk_bike_public_transport) %>%  
#                                          group_by(race) %>% 
#                                          summarize(
#                                            total_pop = sum(PWGTP),
#                                            walk_bike_public = sum(PWGTP[walk_bike_public_transport == "Walk/Bike/Public"]),  
#                                            walk_bike_public_prop = walk_bike_public / total_pop, # divide by total_pop for proportion
#                                            walk_bike_public_perc = round(walk_bike_public_prop*100, 2)
#                                          ) %>% mutate(county = "SCAG") %>% select(county, race, walk_bike_public_perc)
# 
# # Get Walk/Bike/Public percentages by race for all by race and by county for non-home workers:
# scag_county_race_walk_bike_public <- ca_pums_scag %>% filter(JWTRNS != 11) %>% select(PWGTP, county, race, walk_bike_public_transport) %>%  
#                                          group_by(county, race) %>% 
#                                          summarize(
#                                            total_pop = sum(PWGTP),
#                                            walk_bike_public = sum(PWGTP[walk_bike_public_transport == "Walk/Bike/Public"]),  
#                                            walk_bike_public_prop = walk_bike_public / total_pop, # divide by total_pop for proportion
#                                            walk_bike_public_perc = round(walk_bike_public_prop*100, 2)
#                                          ) %>% select(county, race, walk_bike_public_perc)
# 
# # Get no_veh percentages by county for all SCAG:
# scag_county_total_walk_bike_public <- ca_pums_scag %>% filter(JWTRNS != 11) %>% 
#                                          select(PWGTP, county, walk_bike_public_transport)  %>%  
#                                          group_by(county) %>% 
#                                          summarize(
#                                            total_pop = sum(PWGTP),
#                                            walk_bike_public = sum(PWGTP[walk_bike_public_transport == "Walk/Bike/Public"]),  
#                                            walk_bike_public_prop = walk_bike_public / total_pop, # divide by total_pop for proportion
#                                            walk_bike_public_perc = round(walk_bike_public_prop*100, 2)
#                                          ) %>% select(county, walk_bike_public_perc) 
# # Get no_veh percentages for all SCAG:
# scag_total_walk_bike_public <- ca_pums_scag %>% filter(JWTRNS != 11) %>% select(PWGTP, walk_bike_public_transport) %>%  
#                                          summarize(
#                                            total_pop = sum(PWGTP),
#                                            walk_bike_public = sum(PWGTP[walk_bike_public_transport == "Walk/Bike/Public"]),  
#                                            walk_bike_public_prop = walk_bike_public / total_pop, # divide by total_pop for proportion
#                                            walk_bike_public_perc = round(walk_bike_public_prop*100, 2)
#                                          ) %>% mutate(county = "SCAG") %>% select(county, walk_bike_public_perc) 
# 
# # Full join all scag_total tables:
# scag_total_walk_bike_public_table <- full_join(scag_county_total_walk_bike_public,scag_total_walk_bike_public) %>% mutate(race = "SCAG Region")
# 
# # Full join all scag_race tables, then left join scag_total_no_veh_table by county:
# walk_bike_public_scag_table <- full_join(scag_county_race_walk_bike_public,scag_total_walk_bike_public_table) %>% full_join(.,scag_race_walk_bike_public) %>% 
#                                 mutate(county = factor(county, levels = county_levels),
#                                        race = factor(race, levels = race_levels)) %>% 
#                                 arrange(county, race) %>% ungroup()
# walk_bike_public_scag_table

# Use weight_perc_2groups():
# Pass in data filtered to only hh (filter(RELSHIPP == 20)), calculate weighted percentages using hh level weights- "WGTP", for variable "poverty" and filter to "poverty" == "Yes": 
walk_bike_public_scag_table <- ca_pums_scag %>% filter(JWTRNS != 11) %>% 
    weight_perc_2groups(var = "walk_bike_public_transport", weight = "PWGTP", group1 = "county", group2 = "race", filter_value = "Walk/Bike/Public",
                        group1_levels = county_levels, group2_levels = race_levels) %>% rename(walk_bike_public_percentage = percentage)
walk_bike_public_scag_table

# Write out table to .csv in "output/tables" folder and once the file exists remove from current environment all tibbles used to make the final table:
write_csv(walk_bike_public_scag_table, here(tables_fp, "walk_bike_public_scag_table.csv"))
if (file.exists(here(tables_fp, 'walk_bike_public_scag_table.csv'))) {rm(list = ls(pattern = "walk_bike_public"))}

```


### Figure 6. Householders without a Vehicle by Race and Ethnicity

```{r fig_6}
### 
# Figure 6. Householders without a Vehicle by Race and Ethnicity:
# Filter to only housing data(RELSHIPP == 20) and Use household weights- WGTP:
# sum over VEH == 0
# 
# Get no_veh percentages by race for all SCAG:
# scag_race_no_veh <- ca_pums_scag %>% filter(RELSHIPP == 20) %>% select(WGTP, race, VEH) %>%  
#                                          group_by(race) %>% 
#                                          summarize(
#                                            total_pop = sum(WGTP),
#                                            no_veh = sum(WGTP[VEH == 0]),  
#                                            no_veh_prop = no_veh / total_pop, # divide by total_pop for proportion
#                                            no_veh_perc = round(no_veh_prop*100, 2)
#                                          ) %>% mutate(county = "SCAG") %>% select(county, race, no_veh_perc) %>% 
#                                          pivot_wider(names_from = race, values_from = no_veh_perc) # make into wide table to match excel file table.
# 
# # Get no_veh percentages by race and by county:
# scag_county_race_no_veh <- ca_pums_scag %>% filter(RELSHIPP == 20) %>% select(WGTP, county, race, VEH) %>%  
#                                          group_by(county, race) %>% 
#                                          summarize(
#                                            total_pop = sum(WGTP),
#                                            no_veh = sum(WGTP[VEH == 0]), 
#                                            no_veh_prop = no_veh / total_pop, # divide by total_pop for proportion
#                                            no_veh_perc = round(no_veh_prop*100, 2)
#                                          ) %>% select(county, race, no_veh_perc) %>% 
#                                          pivot_wider(names_from = race, values_from = no_veh_perc)
# # Get no_veh percentages by county for all SCAG:
# scag_county_total_no_veh <- ca_pums_scag %>% filter(RELSHIPP == 20) %>% select(WGTP, county, VEH) %>%  
#                                          group_by(county) %>% 
#                                          summarize(
#                                            total_pop = sum(WGTP),
#                                            no_veh = sum(WGTP[VEH == 0]),
#                                            no_veh_prop = no_veh / total_pop, # divide by total_pop for proportion
#                                            no_veh_perc = round(no_veh_prop*100, 2)
#                                          ) %>% select(county, no_veh_perc) %>% rename(Total = no_veh_perc) 
# # Get no_veh percentages for all SCAG:
# scag_total_no_veh <- ca_pums_scag %>% filter(RELSHIPP == 20) %>% select(WGTP, VEH) %>%  
#                                          summarize(
#                                            total_pop = sum(WGTP),
#                                            no_veh = sum(WGTP[VEH == 0]), 
#                                            no_veh_prop = no_veh / total_pop, # divide by total_pop for proportion
#                                            no_veh_perc = round(no_veh_prop*100, 2)
#                                          ) %>% mutate(county = "SCAG") %>% select(county, no_veh_perc) %>% rename(Total = no_veh_perc)
# 
# # Full join all scag_total tables:
# scag_total_no_veh_table <- full_join(scag_county_total_no_veh,scag_total_no_veh)
# 
# # Full join all scag_race tables, then left join scag_total_no_veh_table by county:
# no_veh_scag_table <- full_join(scag_county_race_no_veh,scag_race_no_veh) %>% left_join(.,scag_total_no_veh_table, by = join_by(county))
# no_veh_scag_table


# Use weight_perc_2groups():
# Pass in data filtered to only hh (filter(RELSHIPP == 20)), calculate weighted percentages using hh level weights- "WGTP", for variable "poverty" and filter to "poverty" == "Yes": 
no_veh_scag_table <- ca_pums_scag %>% filter(RELSHIPP == 20) %>% 
    weight_perc_2groups(var = "VEH", weight = "WGTP", group1 = "county", group2 = "race", filter_value = 0,
                        group1_levels = county_levels, group2_levels = race_levels) %>% rename(no_vehicle_percentage = percentage)
no_veh_scag_table

# Write out table to .csv in "output/tables" folder and once the file exists remove from current environment all tibbles used to make the final table:
write_csv(no_veh_scag_table, here(tables_fp, "no_veh_scag_table.csv"))
if (file.exists(here(tables_fp, 'no_veh_scag_table.csv'))) {rm(list = ls(pattern = "no_veh"))}

```

### Figure 7. Workers’ Commute Times (Minutes) by Mode and Race and Ethnicity

```{r fig_7}
# Figure 7. Figure 7. Workers’ Commute Times (Minutes) by Mode and Race and Ethnicity:
# Use person level weights- PWGTP:
# Grouped by all_transport and race
# Get weighted means based on non-home workers- drop all if JWTRNS respond == 11 (use filter not equal to 11 like this (filter(JWTRNS != 11)))
# Get all_transport means by race for all SCAG non-home workers:
scag_race_transport_mean <- ca_pums_scag %>% select(PWGTP, race, all_transport, JWMNP) %>% drop_na() %>% 
                                         group_by(race, all_transport) %>%
                                         summarize(
                                           mean_transit_times_in_minutes = weighted.mean(JWMNP, PWGTP, na.rm = TRUE) # weighted mean 
                                         ) %>% mutate(county = "SCAG") %>% relocate(county) 


# Get all_transport means for all SCAG non-home workers- Any Transport:
scag_race_any_transport_mean <- ca_pums_scag %>% filter(JWTRNS != 11) %>%  select(PWGTP, race, all_transport, JWMNP) %>% 
                                         group_by(race) %>%
                                         summarize(
                                           mean_transit_times_in_minutes = weighted.mean(JWMNP, PWGTP, na.rm = TRUE) # weighted mean 
                                         ) %>% mutate(county = "SCAG", all_transport = "Any Transportation") %>% select(county, race, all_transport, mean_transit_times_in_minutes)

# Full Join scag_transport_mean and scag_any_transport_mean
scag_race_transport_mean <- full_join(scag_race_transport_mean, scag_race_any_transport_mean)

# Get all_transport means for all SCAG non-home workers:
scag_transport_mean <- ca_pums_scag %>% filter(JWTRNS != 11) %>%  select(PWGTP, all_transport, JWMNP) %>% 
                                         group_by(all_transport) %>%
                                         summarize(
                                           mean_transit_times_in_minutes = weighted.mean(JWMNP, PWGTP, na.rm = TRUE) # weighted mean 
                                         ) %>% mutate(county = "SCAG", race = "SCAG Region") %>% relocate(county) %>% 
                                         select(county, race, all_transport, mean_transit_times_in_minutes)

# Get all_transport means for all SCAG non-home workers- Any Transport:
scag_any_transport_mean <- ca_pums_scag %>% filter(JWTRNS != 11) %>%  select(PWGTP, all_transport, JWMNP) %>% 
                                         summarize(
                                           mean_transit_times_in_minutes = weighted.mean(JWMNP, PWGTP, na.rm = TRUE) # weighted mean 
                                         ) %>% mutate(county = "SCAG", race = "SCAG Region", all_transport = "Any Transportation") %>% 
                                         select(county, race, all_transport, mean_transit_times_in_minutes)

# Full Join scag_transport_mean and scag_any_transport_mean
scag_transport_mean_totals <- full_join(scag_transport_mean, scag_any_transport_mean)

# Full join scag_race_transport_mean and cag_transport_mean_overall to get full totals table for SCAG and by race:
scag_transport_mean <- scag_race_transport_mean %>% full_join(scag_transport_mean_totals)

#### 
# Next, do the same as above by broken down by county and join the full county table to scag_race_transport_mean
# By county
# Get all_transport means by race for all SCAG non-home workers:
scag_race_county_transport_mean <- ca_pums_scag %>% select(PWGTP, race, county, all_transport, JWMNP) %>% drop_na() %>% 
                                         group_by(county, race, all_transport) %>%
                                         summarize(
                                           mean_transit_times_in_minutes = weighted.mean(JWMNP, PWGTP, na.rm = TRUE) # weighted mean 
                                         ) %>% ungroup() %>% complete(county, race, all_transport) %>% relocate(county)  %>% 
                                         mutate(mean_transit_times_in_minutes = replace_na(mean_transit_times_in_minutes,0)) # Replace NA with 0.

# Get all_transport means for all SCAG non-home workers- Any Transport:
scag_race_county_any_transport_mean <- ca_pums_scag %>% filter(JWTRNS != 11) %>%  select(PWGTP, county, race, all_transport, JWMNP) %>% 
                                         group_by(race, county) %>%
                                         summarize(
                                           mean_transit_times_in_minutes = weighted.mean(JWMNP, PWGTP, na.rm = TRUE) # weighted mean 
                                         ) %>% mutate(all_transport = "Any Transportation") %>% 
                                        select(county, race, all_transport, mean_transit_times_in_minutes)

# Left Join scag_transport_mean and scag_any_transport_mean
scag_race_county_transport_mean <- full_join(scag_race_county_transport_mean, scag_race_county_any_transport_mean)

# Full join scag_race_transport_mean and cag_transport_mean_overall to get full totals table for SCAG and by race:
transport_mean_scag_table <- scag_transport_mean %>% full_join(scag_race_county_transport_mean) %>% ungroup()
# Round all means to 2 digits and arrange the table by county, race, and transportation_type:
transport_mean_scag_table <- transport_mean_scag_table %>% 
                                mutate(across(where(is.numeric), round, 2),
                                       county = factor(county, levels = county_levels),
                                       race = factor(race, levels = race_levels),
                                       all_transport = factor(all_transport, levels = c("Any Transportation","Private","Public", "Other"))) %>%
                                arrange(county, race, all_transport) %>% ungroup() %>% rename(transportation_type = all_transport)
transport_mean_scag_table

# Write out table to .csv in "output/tables" folder and once the file exists remove from current environment all tibbles used to make the final table:
write_csv(transport_mean_scag_table, here(tables_fp, "transport_mean_scag_table.csv"))
if (file.exists(here(tables_fp, 'transport_mean_scag_table.csv'))) {rm(list = ls(pattern = "transport_mean"))}

```

### Figure 19. Renters and Homeowners Experiencing Housing Cost Burden by Race and Ethnicity 

```{r fig_19}
# Figure 19. Renters and Homeowners Experiencing Housing Cost Burden by Race and Ethnicity 
# Filter to only housing data and renters (filter(RELSHIPP == 20, own_home == "Non-Homeowner")) and Use household weights- WGTP, sum if renter_burden == "Yes":
# Get renter burden percentages by race for all SCAG:
# scag_race_renter_burden <- ca_pums_scag %>% filter(RELSHIPP == 20, own_home == "Non-Homeowner") %>% select(WGTP, race, renter_burden) %>%  
#                                          group_by(race) %>% 
#                                          summarize(
#                                            total_pop = sum(WGTP),
#                                            renter = sum(WGTP[renter_burden == "Yes"]), # sum up only those that own homes.
#                                            renter_prop = renter / total_pop, # divide by total_pop for proportion
#                                            renter_perc = round(renter_prop*100, 2)
#                                          ) %>% mutate(county = "SCAG") %>% select(county, race, renter_perc) %>% 
#                                          pivot_wider(names_from = race, values_from = renter_perc) # make into wide table to match excel file table.
# 
# # Get renter burden percentages by race and by county:
# scag_county_race_renter_burden <- ca_pums_scag %>% filter(RELSHIPP == 20, own_home == "Non-Homeowner") %>% select(WGTP, race, county, renter_burden) %>%  
#                                          group_by(county, race) %>% 
#                                          summarize(
#                                            total_pop = sum(WGTP),
#                                            renter = sum(WGTP[renter_burden == "Yes"]), # sum up only those that own homes.
#                                            renter_prop = renter / total_pop, # divide by total_pop for proportion
#                                            renter_perc = round(renter_prop*100, 2)
#                                          ) %>% select(county, race, renter_perc) %>% 
#                                          pivot_wider(names_from = race, values_from = renter_perc)
# 
# # Get renter burden percentages  by county for all SCAG:
# scag_county_total_renter_burden <- ca_pums_scag %>% filter(RELSHIPP == 20, own_home == "Non-Homeowner") %>% select(WGTP, race, county, renter_burden) %>%  
#                                          group_by(county) %>% 
#                                          summarize(
#                                            total_pop = sum(WGTP),
#                                            renter = sum(WGTP[renter_burden == "Yes"]), # sum up only those that own homes.
#                                            renter_prop = renter / total_pop, # divide by total_pop for proportion
#                                            renter_perc = round(renter_prop*100, 2)
#                                          ) %>% select(county, renter_perc) %>% rename(Total = renter_perc) 
# # Get renter burden percentages for all SCAG:
# scag_total_renter_burden <- ca_pums_scag %>% filter(RELSHIPP == 20, own_home == "Non-Homeowner") %>% select(WGTP, race, county, renter_burden) %>%  
#                                          summarize(
#                                            total_pop = sum(WGTP),
#                                            renter = sum(WGTP[renter_burden == "Yes"]), # sum up only those that own homes.
#                                            renter_prop = renter / total_pop, # divide by total_pop for proportion
#                                            renter_perc = round(renter_prop*100, 2)
#                                          ) %>% mutate(county = "SCAG") %>% select(county, renter_perc) %>% rename(Total = renter_perc)
# 
# # Full join all scag_total tables:
# scag_total_renter_burden_table <- full_join(scag_county_total_renter_burden,scag_total_renter_burden)
# 
# # Full join all scag_race tables, then left join scag_total_homeownership_table by county:
# scag_renter_burden_table <- full_join(scag_county_race_renter_burden,scag_race_renter_burden) %>% left_join(.,scag_total_renter_burden_table)
# # Create new column household_type to denote Renters for type of housing burden for this part of table:
# scag_renter_burden_table <- scag_renter_burden_table %>% mutate(household_type = "Renters") %>% select(household_type, everything())
# 
# scag_renter_burden_table
# 
# ###
# # Repeat above steps for own_home == "Homeowner" and join with "Renters" table
# # Get housing burden percentages by race for all SCAG:
# scag_race_housing_burden <- ca_pums_scag %>% filter(RELSHIPP == 20, own_home == "Homeowner") %>% select(WGTP, race, housing_burden) %>%  
#                                          group_by(race) %>% 
#                                          summarize(
#                                            total_pop = sum(WGTP),
#                                            housing = sum(WGTP[housing_burden == "Yes"]), # sum up only those that own homes.
#                                            housing_prop = housing / total_pop, # divide by total_pop for proportion
#                                            housing_perc = round(housing_prop*100, 2)
#                                          ) %>% mutate(county = "SCAG") %>% select(county, race, housing_perc) %>% 
#                                          pivot_wider(names_from = race, values_from = housing_perc) # make into wide table to match excel file table.
# 
# # Get housing burden percentages by race and by county:
# scag_county_race_housing_burden <- ca_pums_scag %>% filter(RELSHIPP == 20, own_home == "Homeowner") %>% select(WGTP, race, county, housing_burden) %>%  
#                                          group_by(county, race) %>% 
#                                          summarize(
#                                            total_pop = sum(WGTP),
#                                            housing = sum(WGTP[housing_burden == "Yes"]), # sum up only those that own homes.
#                                            housing_prop = housing / total_pop, # divide by total_pop for proportion
#                                            housing_perc = round(housing_prop*100, 2)
#                                          ) %>% select(county, race, housing_perc) %>% 
#                                          pivot_wider(names_from = race, values_from = housing_perc)
# 
# # Get housing burden percentages  by county for all SCAG:
# scag_county_total_housing_burden <- ca_pums_scag %>% filter(RELSHIPP == 20, own_home == "Homeowner") %>% select(WGTP, race, county, housing_burden) %>%  
#                                          group_by(county) %>% 
#                                          summarize(
#                                            total_pop = sum(WGTP),
#                                            housing = sum(WGTP[housing_burden == "Yes"]), # sum up only those that own homes.
#                                            housing_prop = housing / total_pop, # divide by total_pop for proportion
#                                            housing_perc = round(housing_prop*100, 2)
#                                          ) %>% select(county, housing_perc) %>% rename(Total = housing_perc) 
# # Get housing burden percentages for all SCAG:
# scag_total_housing_burden <- ca_pums_scag %>% filter(RELSHIPP == 20, own_home == "Homeowner") %>% select(WGTP, race, county, housing_burden) %>%  
#                                          summarize(
#                                            total_pop = sum(WGTP),
#                                            housing = sum(WGTP[housing_burden == "Yes"]), # sum up only those that own homes.
#                                            housing_prop = housing / total_pop, # divide by total_pop for proportion
#                                            housing_perc = round(housing_prop*100, 2)
#                                          ) %>% mutate(county = "SCAG") %>% select(county, housing_perc) %>% rename(Total = housing_perc)
# 
# # Full join all scag_total tables:
# scag_total_housing_burden_table <- full_join(scag_county_total_housing_burden,scag_total_housing_burden)
# 
# # Full join all scag_race tables, then left join scag_total_homeownership_table by county:
# scag_housing_burden_table <- full_join(scag_county_race_housing_burden,scag_race_housing_burden) %>% left_join(.,scag_total_housing_burden_table)
# # Create new column household_type to denote Homeowners for type of housing burden for this part of table:
# scag_housing_burden_table <- scag_housing_burden_table %>% mutate(household_type = "Homeowners") %>% select(household_type, everything())

####
#### Use  weight_perc_2groups() twice, once for own_home == "Non-Homeowner" on variable "renter_burden" for Renters and again with own_home == "Homeowner" on variable "housing_burden" for Homeowners:
# Get renter_burden by using weight_perc_2groups() and add a column called household_type = "Renters":
scag_renter_burden_table <- ca_pums_scag %>% filter(RELSHIPP == 20, own_home == "Non-Homeowner") %>% 
    weight_perc_2groups(var = "renter_burden", weight = "WGTP", group1 = "county", group2 = "race", filter_value = "Yes",
                        group1_levels = county_levels, group2_levels = race_levels) %>% mutate(household_type = "Renters")
scag_renter_burden_table

# Get housing_burden by using weight_perc_2groups() and add a column called household_type = "Homeowners":
scag_housing_burden_table <- ca_pums_scag %>% filter(RELSHIPP == 20, own_home == "Homeowner") %>% 
    weight_perc_2groups(var = "housing_burden", weight = "WGTP", group1 = "county", group2 = "race", filter_value = "Yes",
                        group1_levels = county_levels, group2_levels = race_levels) %>% mutate(household_type = "Homeowners")
scag_housing_burden_table

# Join renters and Homeowners tables, re-order columns, add all complete cases to bring back any NA's in percentage and turn into 0:
housing_burden_scag_table <- full_join(scag_renter_burden_table, scag_housing_burden_table) %>% 
                                mutate(household_type = factor(household_type, levels = c("Renters","Homeowners"))) %>% 
                                select(household_type, everything()) %>% 
                                 complete(household_type, county, race) %>% mutate(percentage = replace_na(percentage, 0)) %>% 
                                    rename(burden_percentage = percentage)

# Write out table to .csv in "output/tables" folder and once the file exists remove from current environment all tibbles used to make the final table:
write_csv(housing_burden_scag_table, here(tables_fp, "housing_burden_scag_table.csv"))
if (file.exists(here(tables_fp, 'housing_burden_scag_table.csv'))) {
    rm(list = ls(pattern = "renter_burden"))
    rm(list = ls(pattern = "housing_burden"))
}

```

### Figure 20. People Living in Households Without Kitchen and Plumbing Facilities by Race and Ethnicity

```{r fig_20}
### 
# 
# Figure 20. People Living in Households Without Kitchen and Plumbing Facilities by Race and Ethnicity
# Filter to only housing data filter(RELSHIPP == 20) and Use household weights- WGTP: sum if no_kitchen_plumbing == "Yes"
# Get no_kitchen_plumbing percentages by race for all SCAG:
# scag_race_no_kitchen_plumbing <- ca_pums_scag %>% filter(RELSHIPP == 20) %>% select(WGTP, race, no_kitchen_plumbing) %>%  drop_na(no_kitchen_plumbing) %>%  
#                                          group_by(race) %>% 
#                                          summarize(
#                                            total_pop = sum(WGTP),
#                                            no_kitchen_plumbing_sum = sum(WGTP[no_kitchen_plumbing == "Yes"]), # sum up only those that own homes.
#                                            no_kitchen_plumbing_prop = no_kitchen_plumbing_sum / total_pop, # divide by total_pop for proportion
#                                            no_kitchen_plumbing_perc = round(no_kitchen_plumbing_prop*100, 2)
#                                          ) %>% mutate(county = "SCAG") %>% select(county, race, no_kitchen_plumbing_perc) %>% 
#                                          pivot_wider(names_from = race, values_from = no_kitchen_plumbing_perc) # make into wide table to match excel file table.
# 
# # Get no_kitchen_plumbing percentages by race and by county:
# scag_county_race_no_kitchen_plumbing <- ca_pums_scag  %>% filter(RELSHIPP == 20) %>% select(WGTP, race, no_kitchen_plumbing, county) %>%  drop_na(no_kitchen_plumbing) %>%
#                                          group_by(county, race) %>% 
#                                          summarize(
#                                            total_pop = sum(WGTP),
#                                            no_kitchen_plumbing_sum = sum(WGTP[no_kitchen_plumbing == "Yes"]), # sum up only those that own homes.
#                                            no_kitchen_plumbing_prop = no_kitchen_plumbing_sum / total_pop, # divide by total_pop for proportion
#                                            no_kitchen_plumbing_perc = round(no_kitchen_plumbing_prop*100, 2)
#                                          ) %>% select(county, race, no_kitchen_plumbing_perc) %>% 
#                                          pivot_wider(names_from = race, values_from = no_kitchen_plumbing_perc)
# # Get no_kitchen_plumbing percentages by county for all SCAG:
# scag_county_total_no_kitchen_plumbing <- ca_pums_scag %>% filter(RELSHIPP == 20) %>% select(WGTP, county, no_kitchen_plumbing) %>% drop_na(no_kitchen_plumbing) %>%
#                                          group_by(county) %>% 
#                                          summarize(
#                                            total_pop = sum(WGTP),
#                                            no_kitchen_plumbing_sum = sum(WGTP[no_kitchen_plumbing == "Yes"]), # sum up only those that own homes.
#                                            no_kitchen_plumbing_prop = no_kitchen_plumbing_sum / total_pop, # divide by total_pop for proportion
#                                            no_kitchen_plumbing_perc = round(no_kitchen_plumbing_prop*100, 2)
#                                          ) %>% select(county, no_kitchen_plumbing_perc) %>% rename(Total = no_kitchen_plumbing_perc) 
# 
# # Get no_kitchen_plumbing percentages for all SCAG:
# scag_total_no_kitchen_plumbing <- ca_pums_scag %>% filter(RELSHIPP == 20) %>% select(WGTP, no_kitchen_plumbing) %>% drop_na(no_kitchen_plumbing) %>%
#                                         summarize(
#                                            total_pop = sum(WGTP),
#                                            no_kitchen_plumbing_sum = sum(WGTP[no_kitchen_plumbing == "Yes"]), # sum up only those that own homes.
#                                            no_kitchen_plumbing_prop = no_kitchen_plumbing_sum / total_pop, # divide by total_pop for proportion
#                                            no_kitchen_plumbing_perc = round(no_kitchen_plumbing_prop*100, 2)
#                                          ) %>% mutate(county = "SCAG") %>% select(county, no_kitchen_plumbing_perc) %>% rename(Total = no_kitchen_plumbing_perc)
# 
# # Full join all scag_total tables:
# scag_total_no_kitchen_plumbing_table <- full_join(scag_county_total_no_kitchen_plumbing,scag_total_no_kitchen_plumbing)
# 
# # Full join all scag_race tables, then left join scag_total_no_kitchen_plumbing_table by county:
# no_kitchen_plumbing_scag_table <- full_join(scag_county_race_no_kitchen_plumbing,scag_race_no_kitchen_plumbing) %>% left_join(.,scag_total_no_kitchen_plumbing_table)
# no_kitchen_plumbing_scag_table

# Get no_kitchen_plumbing percentages by using weight_perc_2groups() and expand to all complete cases, then convert NA's to 0's:
no_kitchen_plumbing_scag_table <- ca_pums_scag %>% filter(RELSHIPP == 20) %>% 
    weight_perc_2groups(var = "no_kitchen_plumbing", weight = "WGTP", group1 = "county", group2 = "race", filter_value = "Yes",
                        group1_levels = county_levels, group2_levels = race_levels) %>% 
                                 complete(county, race) %>% mutate(percentage = replace_na(percentage, 0)) %>% 
                                    rename(no_kitchen_plumbing_percentage = percentage)
no_kitchen_plumbing_scag_table 

# Write out table to .csv in "output/tables" folder and once the file exists remove from current environment all tibbles used to make the final table:
write_csv(no_kitchen_plumbing_scag_table, here(tables_fp, "no_kitchen_plumbing_scag_table.csv"))
if (file.exists(here(tables_fp, 'no_kitchen_plumbing_scag_table.csv'))) {rm(list = ls(pattern = "no_kitchen_plumbing"))}

```

### Figure 21. Households with Severe Overcrowding by Race and Ethnicity

```{r fig_21}
# ### 
# # Figure 21. Households with Severe Overcrowding by Race and Ethnicity:
# # Filter to only housing data (filter(RELSHIPP == 20)) and Use household weights- WGTP, count if "overcrowded" == "Yes":
# # Get overcrowding percentages by race for all SCAG:
# scag_race_overcrowded <- ca_pums_scag %>% filter(RELSHIPP == 20) %>% select(WGTP, race, overcrowded) %>%  
#                                          group_by(race) %>% 
#                                          summarize(
#                                            total_pop = sum(WGTP),
#                                            overcrowd = sum(WGTP[overcrowded == "Yes"]), # sum up only those that
#                                            overcrowd_prop = overcrowd / total_pop, # divide by total_pop for proportion
#                                            overcrowd_perc = round(overcrowd_prop*100, 2)
#                                          ) %>% mutate(county = "SCAG") %>% select(county, race, overcrowd_perc) %>% 
#                                          pivot_wider(names_from = race, values_from = overcrowd_perc) # make into wide table to match excel file table.
# 
# # Get overcrowded percentages by race and by county:
# scag_county_race_overcrowded <- ca_pums_scag %>% filter(RELSHIPP == 20) %>% select(WGTP, county, race, overcrowded) %>%  
#                                          group_by(county, race) %>% 
#                                          summarize(
#                                            total_pop = sum(WGTP),
#                                            overcrowd = sum(WGTP[overcrowded == "Yes"]), # sum up only those that
#                                            overcrowd_prop = overcrowd / total_pop, # divide by total_pop for proportion
#                                            overcrowd_perc = round(overcrowd_prop*100, 2)
#                                          ) %>% select(county, race, overcrowd_perc) %>% 
#                                          pivot_wider(names_from = race, values_from = overcrowd_perc)
# # Get overcrowded percentages by county for all SCAG:
# scag_county_total_overcrowded <- ca_pums_scag %>% filter(RELSHIPP == 20) %>% select(WGTP, county, overcrowded) %>%  
#                                          group_by(county) %>% 
#                                          summarize(
#                                            total_pop = sum(WGTP),
#                                            overcrowd = sum(WGTP[overcrowded == "Yes"]), # sum up only those that
#                                            overcrowd_prop = overcrowd / total_pop, # divide by total_pop for proportion
#                                            overcrowd_perc = round(overcrowd_prop*100, 2)
#                                          ) %>% select(county, overcrowd_perc) %>% rename(Total = overcrowd_perc) 
# # Get overcrowded percentages for all SCAG:
# scag_total_overcrowded <- ca_pums_scag %>% filter(RELSHIPP == 20) %>% select(WGTP, overcrowded) %>%  
#                                          summarize(
#                                            total_pop = sum(WGTP),
#                                            overcrowd = sum(WGTP[overcrowded == "Yes"]), # sum up only those that
#                                            overcrowd_prop = overcrowd / total_pop, # divide by total_pop for proportion
#                                            overcrowd_perc = round(overcrowd_prop*100, 2)
#                                          ) %>% mutate(county = "SCAG") %>% select(county, overcrowd_perc) %>% rename(Total = overcrowd_perc)
# 
# # Full join all scag_total tables:
# scag_total_overcrowded_table <- full_join(scag_county_total_overcrowded,scag_total_overcrowded)
# 
# # Full join all scag_race tables, then left join scag_total_overcrowded_table by county:
# overcrowded_scag_table <- full_join(scag_county_race_overcrowded,scag_race_overcrowded) %>% left_join(.,scag_total_overcrowded_table) 
# overcrowded_scag_table

# Get no_kitchen_plumbing percentages by using weight_perc_2groups() and expand to all complete cases, then convert NA's to 0's:
overcrowded_scag_table <- ca_pums_scag %>% filter(RELSHIPP == 20) %>% 
    weight_perc_2groups(var = "overcrowded", weight = "WGTP", group1 = "county", group2 = "race", filter_value = "Yes",
                        group1_levels = county_levels, group2_levels = race_levels) %>% 
                            rename(overcrowded_percentage = percentage)
overcrowded_scag_table 

# Write out table to .csv in "output/tables" folder and once the file exists remove from current environment all tibbles used to make the final table:
write_csv(overcrowded_scag_table, here(tables_fp, "overcrowded_scag_table.csv"))
if (file.exists(here(tables_fp, 'overcrowded_scag_table.csv'))) {rm(list = ls(pattern = "overcrowded"))}

```

### Figure 22. Homeownership by Race and Ethnicity

```{r fig_22}
### 
# Figure 22. Homeownership by Race and Ethnicity:
# Filter to only housing data () and Use household weights- WGTP:
# Get homeownership percentages by race for all SCAG:
# scag_race_homeownership <- ca_pums_scag %>% filter(RELSHIPP == 20) %>% select(WGTP, race,own_home) %>%  
#                                          group_by(race) %>% 
#                                          summarize(
#                                            total_pop = sum(WGTP),
#                                            ownership = sum(WGTP[own_home == "Homeowner"]), # sum up only those that own homes.
#                                            ownership_prop = ownership / total_pop, # divide by total_pop for proportion
#                                            ownership_perc = round(ownership_prop*100, 2)
#                                          ) %>% mutate(county = "SCAG") %>% select(county, race, ownership_perc) %>% 
#                                          pivot_wider(names_from = race, values_from = ownership_perc) # make into wide table to match excel file table.
# 
# # Get homeownership percentages by race and by county:
# scag_county_race_homeownership <- ca_pums_scag %>% filter(RELSHIPP == 20) %>% select(WGTP, county, race,own_home) %>%  
#                                          group_by(county, race) %>% 
#                                          summarize(
#                                            total_pop = sum(WGTP),
#                                            ownership = sum(WGTP[own_home == "Homeowner"]), # sum up only those that own homes.
#                                            ownership_prop = ownership / total_pop, # divide by total_pop for proportion
#                                            ownership_perc = round(ownership_prop*100, 2) 
#                                          ) %>% select(county, race, ownership_perc) %>% 
#                                          pivot_wider(names_from = race, values_from = ownership_perc)
# # Get homeownership percentages by county for all SCAG:
# scag_county_total_homeownership <- ca_pums_scag %>% filter(RELSHIPP == 20) %>% select(WGTP, county, own_home) %>%  
#                                          group_by(county) %>% 
#                                          summarize(
#                                            total_pop = sum(WGTP),
#                                            ownership = sum(WGTP[own_home == "Homeowner"]), # sum up only those that own homes.
#                                            ownership_prop = ownership / total_pop, # divide by total_pop for proportion
#                                            ownership_perc = round(ownership_prop*100, 2) 
#                                          ) %>% select(county, ownership_perc) %>% rename(Total = ownership_perc) 
# # Get homeownership percentages for all SCAG:
# scag_total_homeownership <- ca_pums_scag %>% filter(RELSHIPP == 20) %>% select(WGTP, own_home) %>%  
#                                          summarize(
#                                            total_pop = sum(WGTP),
#                                            ownership = sum(WGTP[own_home == "Homeowner"]), # sum up only those that own homes.
#                                            ownership_prop = ownership / total_pop, # divide by total_pop for proportion
#                                            ownership_perc = round(ownership_prop*100, 2) 
#                                          ) %>% mutate(county = "SCAG") %>% select(county, ownership_perc) %>% rename(Total = ownership_perc)
# 
# # Full join all scag_total tables:
# scag_total_homeownership_table <- full_join(scag_county_total_homeownership,scag_total_homeownership)
# 
# # Full join all scag_race tables, then left join scag_total_homeownership_table by county:
# homeownership_scag_table <- full_join(scag_county_race_homeownership,scag_race_homeownership) %>% left_join(.,scag_total_homeownership_table)
# homeownership_scag_table

# Get no_kitchen_plumbing percentages by using weight_perc_2groups() and expand to all complete cases, then convert NA's to 0's:
homeownership_scag_table <- ca_pums_scag %>% filter(RELSHIPP == 20) %>% 
    weight_perc_2groups(var = "own_home", weight = "WGTP", group1 = "county", group2 = "race", filter_value = "Homeowner",
                        group1_levels = county_levels, group2_levels = race_levels) %>% 
                            rename(homeownership_percentage = percentage)
homeownership_scag_table 

# Write out table to .csv in "output/tables" folder and once the file exists remove from current environment all tibbles used to make the final table:
write_csv(homeownership_scag_table, here(tables_fp, "homeownership_scag_table.csv"))
if (file.exists(here(tables_fp, 'homeownership_scag_table.csv'))) {rm(list = ls(pattern = "homeownership"))}

```

### Figure 28. People without Health Insurance by Race and Ethnicity

```{r fig_28}
### 
# Figure 28. People without Health Insurance by Race and Ethnicity:
# # Health insurance coverage
# *------- P4.Health Insurance  -------------;
# *HICOV Character 1
# Health insurance coverage recode
# 1 .With health insurance coverage
# 2 .No health insurance coverage;
# ca_pums_scag %>% select(HICOV) 
# 
# Use person level weights- PWGTP:
# sum over those without health insurance coverage HICOV ==  2
# 
# Get People without Health Insurance percentages by race for all SCAG:
# scag_race_no_hicov <- ca_pums_scag %>% select(PWGTP, race, HICOV) %>%  
#                                          group_by(race) %>% 
#                                          summarize(
#                                            total_pop = sum(PWGTP),
#                                            no_hicov = sum(PWGTP[HICOV == 2]),  
#                                            no_hicov_prop = no_hicov / total_pop, # divide by total_pop for proportion
#                                           no_hicov_perc = round(no_hicov_prop*100, 2)
#                                          ) %>% mutate(county = "SCAG") %>% select(county, race, no_hicov_perc) %>% 
#                                          pivot_wider(names_from = race, values_from = no_hicov_perc) # make into wide table to match excel file table.
# 
# # Get People without Health Insurance percentages by race for all by race and county:
# scag_county_race_no_hicov <- ca_pums_scag %>% select(PWGTP, county, race, HICOV) %>%  
#                                          group_by(county, race) %>% 
#                                          summarize(
#                                            total_pop = sum(PWGTP),
#                                            no_hicov = sum(PWGTP[HICOV == 2]),  
#                                            no_hicov_prop = no_hicov / total_pop, # divide by total_pop for proportion
#                                           no_hicov_perc = round(no_hicov_prop*100, 2)
#                                          ) %>% select(county, race, no_hicov_perc) %>% 
#                                          pivot_wider(names_from = race, values_from = no_hicov_perc)
# 
# # Get People without Health Insurance  percentages by county for all SCAG:
# scag_county_total_no_hicov <- ca_pums_scag %>% select(PWGTP, county, HICOV)  %>%  
#                                                group_by(county) %>% 
#                                                summarize(
#                                                  total_pop = sum(PWGTP),
#                                                  no_hicov = sum(PWGTP[HICOV == 2]),  
#                                                  no_hicov_prop = no_hicov / total_pop, # divide by total_pop for proportion
#                                                 no_hicov_perc = round(no_hicov_prop*100, 2)
#                                                ) %>% select(county, no_hicov_perc) %>% rename(Total = no_hicov_perc) 
# # Get People without Health Insurance  percentages for all SCAG:
# scag_total_no_hicov <- ca_pums_scag %>% select(PWGTP, HICOV) %>%  
#                                          summarize(
#                                            total_pop = sum(PWGTP),
#                                            no_hicov = sum(PWGTP[HICOV == 2]),  
#                                            no_hicov_prop = no_hicov / total_pop, # divide by total_pop for proportion
#                                           no_hicov_perc = round(no_hicov_prop*100, 2)
#                                          ) %>% mutate(county = "SCAG") %>% select(county, no_hicov_perc) %>% rename(Total = no_hicov_perc)
# 
# # Full join all scag_total tables:
# scag_total_no_hicov_table <- full_join(scag_county_total_no_hicov,scag_total_no_hicov)
# 
# # Full join all scag_race tables, then left join scag_total_no_veh_table by county:
# no_hicov_scag_table <- full_join(scag_county_race_no_hicov,scag_race_no_hicov) %>% left_join(.,scag_total_no_hicov_table, by = join_by(county))
# no_hicov_scag_table

# Get People without Health Insurance percentages by using weight_perc_2groups():
no_hicov_scag_table <- ca_pums_scag  %>% 
    weight_perc_2groups(var = "HICOV", weight = "PWGTP", group1 = "county", group2 = "race", filter_value = 2,
                        group1_levels = county_levels, group2_levels = race_levels) %>% 
                            rename(no_health_insurance_percentage = percentage)
no_hicov_scag_table 

# Write out table to .csv in "output/tables" folder and once the file exists remove from current environment all tibbles used to make the final table:
write_csv(no_hicov_scag_table, here(tables_fp, "no_hicov_scag_table.csv"))
if (file.exists(here(tables_fp, 'no_hicov_scag_table.csv'))) {rm(list = ls(pattern = "no_hicov"))}

```

### Figure 39. Median Hourly Wage by Race and Ethnicity

```{r fig_39}
### 
# Figure 39. Median Hourly Wage by Race and Ethnicity
# Use person level weights- PWGTP:

# Get Median Hourly Wage by race for all SCAG:
scag_race_med_hr_wage <- ca_pums_scag %>% filter(ESR %in% c(1:2) & AGEP %in% c(25:64)) %>% 
                                       select(PWGTP, race, hourly_wage)  %>% 
                                       group_by(race) %>% 
                                       summarize(
                                         med_hr_wage = round(weighted.median(hourly_wage, PWGTP, na.rm = TRUE),2)
                                       ) %>% mutate(county = "SCAG") %>% select(county, race, med_hr_wage) 

# Get Median Hourly Wage by race for all by race and county:
scag_county_race_med_hr_wage <- ca_pums_scag %>% filter(ESR %in% c(1:2) & AGEP %in% c(25:64)) %>% 
                                       select(PWGTP, county, race, hourly_wage) %>% 
                                         group_by(county, race) %>% 
                                         summarize(
                                         med_hr_wage = round(weighted.median(hourly_wage, PWGTP, na.rm = TRUE),2)
                                         ) %>% select(county, race, med_hr_wage) 

# Get Median Hourly Wage by county for all SCAG:
scag_county_total_med_hr_wage <- ca_pums_scag %>% filter(ESR %in% c(1:2) & AGEP %in% c(25:64)) %>% 
                                       select(PWGTP, county, race, hourly_wage) %>%  
                                               group_by(county) %>% 
                                               summarize(
                                           med_hr_wage = round(weighted.median(hourly_wage, PWGTP, na.rm = TRUE),2)
                                         ) %>% select(county, med_hr_wage) %>% mutate(race = "SCAG Region")
# Get Median Hourly Wage for all SCAG:
scag_total_med_hr_wage <- ca_pums_scag %>% filter(ESR %in% c(1:2) & AGEP %in% c(25:64)) %>% 
                                       select(PWGTP, race, hourly_wage) %>%  
                                         summarize(
                                           med_hr_wage = round(weighted.median(hourly_wage, PWGTP, na.rm = TRUE),2)
                                           ) %>% mutate(county = "SCAG", race = "SCAG Region") %>% select(county, race, med_hr_wage)

# Full join all scag_total tables:
scag_total_med_hr_wage_table <- full_join(scag_county_total_med_hr_wage,scag_total_med_hr_wage)

# Full join all scag_race tables, then left join scag_total_no_veh_table by county:
med_hr_wage_scag_table <- full_join(scag_county_race_med_hr_wage,scag_race_med_hr_wage) %>% full_join(.,scag_total_med_hr_wage_table) %>% 
                            mutate(county = factor(county, levels = county_levels),
                                   race = factor(race, levels = race_levels)) %>% 
                            arrange(county, race)

med_hr_wage_scag_table

# Write out table to .csv in "output/tables" folder and once the file exists remove from current environment all tibbles used to make the final table:
write_csv(med_hr_wage_scag_table, here(tables_fp, "med_hr_wage_scag_table.csv"))
if (file.exists(here(tables_fp, 'med_hr_wage_scag_table.csv'))) {rm(list = ls(pattern = "med_hr_wage"))}

```

### Figure 40. Unemployment by Race and Ethnicity

```{r fig_40}
### 
# Figure 40. Unemployment by Race and Ethnicity
# Use person level weights- PWGTP:

# Get unemployed percentage by race for all SCAG:
scag_race_unemployed <- ca_pums_scag %>% select(PWGTP, race, unemployed,ESR) %>% drop_na(unemployed) %>% 
                                       group_by(race) %>% 
                                       summarize(
                                           total_labor = sum(PWGTP[ESR != 6]), # excludes not in labor force from ESR variable
                                           unemployed_sum = sum(PWGTP[unemployed == "Yes"]),  
                                           unemployed_prop = unemployed_sum / total_labor, # divide by total_labor for proportion
                                           unemployed_perc = round(unemployed_prop*100, 2)
                                         )  %>% mutate(county = "SCAG") %>% select(county, race, unemployed_perc) 

# Get unemployed percentage by all by race and county:
scag_county_race_unemployed <- ca_pums_scag %>%  select(PWGTP, county, race, unemployed,ESR) %>% drop_na(unemployed) %>%
                                         group_by(county, race) %>%
                                         summarize(
                                           total_labor = sum(PWGTP[ESR != 6]), # excludes not in labor force from ESR variable
                                           unemployed_sum = sum(PWGTP[unemployed == "Yes"]),
                                           unemployed_prop = unemployed_sum / total_labor, # divide by total_labor for proportion
                                           unemployed_perc = round(unemployed_prop*100, 2)
                                         ) %>% select(county, race, unemployed_perc) 


# Get unemployed percentage by county for all SCAG:
scag_county_total_unemployed <- ca_pums_scag %>% select(PWGTP, county, unemployed,ESR) %>% drop_na(unemployed) %>%
                                               group_by(county) %>%
                                               summarize(
                                                       total_labor = sum(PWGTP[ESR != 6]), # excludes not in labor force from ESR variable
                                                       unemployed_sum = sum(PWGTP[unemployed == "Yes"]),
                                                       unemployed_prop = unemployed_sum / total_labor, # divide by total_labor for proportion
                                                       unemployed_perc = round(unemployed_prop*100, 2)
                                                     ) %>% mutate(race = "SCAG Region") %>% select(county, race, unemployed_perc) 

# # Get Median Hourly Wage for all SCAG:
scag_total_unemployed <- ca_pums_scag %>%  select(PWGTP, county, unemployed,ESR) %>% drop_na(unemployed) %>%
                                               summarize(
                                                       total_labor = sum(PWGTP[ESR != 6]), # excludes not in labor force from ESR variable
                                                       unemployed_sum = sum(PWGTP[unemployed == "Yes"]),
                                                       unemployed_prop = unemployed_sum / total_labor, # divide by total_labor for proportion
                                                       unemployed_perc = round(unemployed_prop*100, 2)
                                                     ) %>% mutate(county = "SCAG", race = "SCAG Region") %>% select(county, race, unemployed_perc) 

# Full join all scag_total tables:
scag_total_unemployed_table <- full_join(scag_county_total_unemployed,scag_total_unemployed)

# Full join all scag_race tables, then left join scag_total_no_veh_table by county:
unemployed_scag_table <- full_join(scag_county_race_unemployed,scag_race_unemployed) %>% full_join(.,scag_total_unemployed_table) %>% 
                            mutate(county = factor(county, levels = county_levels),
                                   race = factor(race, levels = race_levels)) %>% 
                            arrange(county, race)
unemployed_scag_table

# Write out table to .csv in "output/tables" folder and once the file exists remove from current environment all tibbles used to make the final table:
write_csv(unemployed_scag_table, here(tables_fp, "unemployed_scag_table.csv"))
if (file.exists(here(tables_fp, 'unemployed_scag_table.csv'))) {rm(list = ls(pattern = "unemployed"))}

```

### Figure 41. Working Poor by Race and Ethnicity

```{r fig_41}
### 
# Figure 41. Working Poor by Race and Ethnicity
# Use person level weights- PWGTP:
# Filter to age 25-64 and a civilian worker:
# SAS Example: 
# if AGEP ge 25 and AGEP le 64;
# if ESR in (1 2); *Civilian worker;
# if poverty == "Yes"- this is if the respondent is less than 200 percent below the poverty line

# Get working poor percentage by race for all SCAG:
# scag_race_working_poor <- ca_pums_scag %>% filter(ESR %in% c(1:2) & AGEP %in% c(25:64)) %>%  select(PWGTP, race, poverty) %>% drop_na(poverty) %>% 
#                                        group_by(race) %>% 
#                                        summarize(
#                                            total_pop = sum(PWGTP),
#                                            poverty_sum = sum(PWGTP[poverty == "Yes"]),  
#                                            poverty_prop = poverty_sum / total_pop, # divide by total_pop for proportion
#                                            poverty_perc = round(poverty_prop*100, 2)
#                                          )  %>% mutate(county = "SCAG") %>% select(county, race, poverty_perc) %>% 
#                                        pivot_wider(names_from = race, values_from = poverty_perc) # make into wide table to match excel file table.
# 
# 
# # Get working poor percentage by all by race and county:
# scag_county_race_working_poor <- ca_pums_scag %>% filter(ESR %in% c(1:2) & AGEP %in% c(25:64)) %>%  select(PWGTP, county, race, poverty) %>% drop_na(poverty) %>%
#                                          group_by(county, race) %>%
#                                          summarize(
#                                            total_pop = sum(PWGTP), 
#                                            poverty_sum = sum(PWGTP[poverty == "Yes"]),
#                                            poverty_prop = poverty_sum / total_pop, # divide by total_pop for proportion
#                                            poverty_perc = round(poverty_prop*100, 2)
#                                          ) %>% select(county, race, poverty_perc) %>%
#                                          pivot_wider(names_from = race, values_from = poverty_perc)
# 
# 
# # Get working poor percentage by county for all SCAG:
# scag_county_total_working_poor <- ca_pums_scag %>% filter(ESR %in% c(1:2) & AGEP %in% c(25:64)) %>% select(PWGTP, county, poverty,ESR) %>% drop_na(poverty) %>%
#                                                group_by(county) %>%
#                                                summarize(
#                                                        total_pop = sum(PWGTP), 
#                                                        poverty_sum = sum(PWGTP[poverty == "Yes"]),
#                                                        poverty_prop = poverty_sum / total_pop, # divide by total_pop for proportion
#                                                        poverty_perc = round(poverty_prop*100, 2)
#                                                      ) %>% select(county, poverty_perc) %>% rename(Total = poverty_perc)
# 
# # Get working poor for all SCAG:
# scag_total_working_poor <- ca_pums_scag %>% filter(ESR %in% c(1:2) & AGEP %in% c(25:64)) %>% select(PWGTP, county, poverty,ESR) %>% drop_na(poverty) %>%
#                                                summarize(
#                                                        total_pop = sum(PWGTP), 
#                                                        poverty_sum = sum(PWGTP[poverty == "Yes"]),
#                                                        poverty_prop = poverty_sum / total_pop, # divide by total_pop for proportion
#                                                        poverty_perc = round(poverty_prop*100, 2)
#                                                      ) %>% mutate(county = "SCAG") %>% select(county, poverty_perc) %>% rename(Total = poverty_perc)
# 
# # Full join all scag_total tables:
# scag_total_working_poor_table <- full_join(scag_county_total_working_poor,scag_total_working_poor)
# 
# # Full join all scag_race tables, then left join scag_total_no_veh_table by county:
# working_poor_scag_table <- full_join(scag_county_race_working_poor,scag_race_working_poor) %>% left_join(.,scag_total_working_poor_table, by = join_by(county))
# working_poor_scag_table

# Get working_poor percentages by using weight_perc_2groups(), use person level weights and filter to civilian workers aged 25-64:
working_poor_scag_table <- ca_pums_scag %>% filter(ESR %in% c(1:2) & AGEP %in% c(25:64)) %>% drop_na(poverty) %>% 
    weight_perc_2groups(var = "poverty", weight = "PWGTP", group1 = "county", group2 = "race", filter_value = "Yes",
                        group1_levels = county_levels, group2_levels = race_levels) %>% 
                            rename(working_poor_percentage = percentage)
working_poor_scag_table 

# Write out table to .csv in "output/tables" folder and once the file exists remove from current environment all tibbles used to make the final table:
write_csv(working_poor_scag_table, here(tables_fp, "working_poor_scag_table.csv"))
if (file.exists(here(tables_fp, 'working_poor_scag_table.csv'))) {rm(list = ls(pattern = "working_poor"))}

```


## Tables and Figures from Racial Equity Baseline Conditions Report (REBCR)

### Total Population by County and SCAG

```{r total_pop}
### 
# Total Population by County and SCAG:
# Use person level weights- PWGTP:
# sum over everyone
# 
# Get Total Population for all SCAG:
scag_total_pop <- ca_pums_scag %>% select(PWGTP) %>% summarize(total_population = sum(PWGTP)) %>% 
                                    mutate(county = "SCAG") %>% select(county, total_population)

# Get Total Population by county:
scag_county_total_pop <- ca_pums_scag %>% select(PWGTP, county) %>%  
                                group_by(county) %>% summarize(total_population = sum(PWGTP)) %>% select(county, total_population)


# Full join all scag_total tables:
total_pop_scag_table <- full_join(scag_county_total_pop, scag_total_pop, by = join_by(county, total_population)) 
total_pop_scag_table

# Write out table to .csv in "output/tables" folder and once the file exists remove from current environment all tibbles used to make the final table:
write_csv(total_pop_scag_table, here(tables_fp, "total_pop_scag_table.csv"))
if (file.exists(here(tables_fp, 'total_pop_scag_table.csv'))) {rm(list = ls(pattern = "total_pop"))}

```


### Race/Ethnicity Distribution (%) by County and SCAG Region

```{r race_ethnicity}
### 
# Race/Ethnicity Distribution (%) by County and SCAG Region:
# Use person level weights- PWGTP:
# Percentages of race by county and SCAG
# race = c("Asian/Pacific Islander", "Black", "Hispanic/Latino", "Multiracial/Other", "Native American", "White")
# 
# Get race percentages for all SCAG:
# scag_race_perc_total <- ca_pums_scag %>% select(PWGTP, race) %>% count(race, wt = PWGTP) %>% mutate(total_pop = sum(n)) %>% 
#                                         group_by(race) %>% summarize(race_percentage = round( (n / total_pop)*100, 2)) %>% 
#                                         mutate(county = "SCAG") %>% select(county, race, race_percentage)
# 
# # Get race percentages for by county for each SCAG County:
# scag_race_perc_county <- ca_pums_scag %>% select(PWGTP, race, county) %>% group_by(county) %>% count(race, wt = PWGTP) %>% mutate(total_pop = sum(n)) %>% ungroup() %>% 
#                                          group_by(race, county) %>% summarize(race_percentage = round( (n / total_pop)*100, 2)) %>% select(county, race, race_percentage)
# 
# # Full join all scag_total tables:
# race_perc_scag_table <- full_join(scag_race_perc_county, scag_race_perc_total) %>% 
#                             mutate(county = factor(county, levels = county_levels),
#                                    race = factor(race, levels = race_levels)) %>% 
#                             arrange(county, race)
# race_perc_scag_table

# Use weight_perc_table_filter():
# Pass in data and calculate weighted percentages using person level weights- "PWGTP", for variable "race", set county to factor, arrange by "race" and "county", 
# then rename "percentage" to "race_percentage", move county to first column: 
# 
race_perc_scag_table <- ca_pums_scag %>% weight_perc_table_filter(var = "race", weight = "PWGTP", group = "county") %>% 
                                            mutate(county = factor(county, levels = county_levels)) %>% 
                                            arrange(county, race) %>% rename(race_percentage = percentage) %>% 
                                            select(county, everything())
race_perc_scag_table
# Write out table to .csv in "output/tables" folder and once the file exists remove from current environment all tibbles used to make the final table:
write_csv(race_perc_scag_table, here(tables_fp, "race_perc_scag_table.csv"))
if (file.exists(here(tables_fp, 'race_perc_scag_table.csv'))) {rm(list = ls(pattern = "race_perc"))}

```


### Age Distribution (%) by County and SCAG Region

```{r age_dist}
### 
# Age Distribution (%) by County and SCAG Region:
# Use person level weights- PWGTP:
# Percentages of age categories by county and SCAG
# Age Categories: named var "age_3_cat"
# SAS example- 
# ac1=.;
# if AGEP < 18 then ac1=1;
# if AGEP ge 18 and AGEP le 64 then ac1=2;
# if AGEP ge 65 then ac1=3; 
# Use "age_3_cat" to get percentages of each category for each SCAG County and the whole SCAG Region: 

# Get age percentages for all SCAG:
# scag_age_perc_total <- ca_pums_scag %>% select(PWGTP, age_3_cat) %>% count(age_3_cat, wt = PWGTP) %>% mutate(total_pop = sum(n)) %>% 
#                                         group_by(age_3_cat) %>% summarize(SCAG = round( (n / total_pop)*100, 2))  
#                                         
# 
# # Get age percentages for by county for each SCAG County:
# scag_age_perc_county <- ca_pums_scag %>% select(PWGTP, age_3_cat, county) %>% group_by(county) %>% count(age_3_cat, wt = PWGTP) %>% mutate(total_pop = sum(n)) %>% ungroup() %>% 
#                                          group_by(age_3_cat, county) %>% summarize(age_perc = round( (n / total_pop)*100, 2)) %>% 
#                                          pivot_wider(names_from = county, values_from = age_perc)
# 
# # Full join all scag_total tables, and pivot_longer() to have county three columns: age_categories, county, and corresponding percentages:
# age_perc_scag_table <- left_join(scag_age_perc_county, scag_age_perc_total, by = join_by(age_3_cat)) %>% ungroup() %>%
#                                 pivot_longer(cols = Imperial:SCAG, names_to = "county", values_to = "percentages") %>% rename(age_categories = age_3_cat)

# Use weight_perc_table_filter():
# Function to return full table of weighted percentages by group and filtered to one value of a variable: weight_perc_table_filter()
# df = dataframe of all data, var = variable to sum over,  weight = weights, group = grouping variable, filter_value = value of a variable to filter output to.
# has and if statement to drop filter_value if NULL, which it is by default
# 
# Pass in data and calculate weighted percentages using person level weights- "PWGTP", for variable "age_3_cat", set county to factor, arrange by "age_3_cat" and "county", 
# then rename "age_3_cat" to "age_categories": 
age_perc_scag_table <- ca_pums_scag %>% weight_perc_table_filter(var = "age_3_cat", weight = "PWGTP", group = "county") %>% 
                                            mutate(county = factor(county, levels = county_levels)) %>% 
                                            arrange(age_3_cat, county) %>% rename(age_categories = age_3_cat) 
age_perc_scag_table

# Write out table to .csv in "output/tables" folder and once the file exists remove from current environment all tibbles used to make the final table:
write_csv(age_perc_scag_table, here(tables_fp, "age_perc_scag_table.csv"))
if (file.exists(here(tables_fp, 'age_perc_scag_table.csv'))) {rm(list = ls(pattern = "age_perc"))}

```


### Single Parent Households (%) by Gender of Head of Household and then by County and SCAG Region

```{r singe_parent}
### 
# Single Parent Households (%) by Gender of Head of Household and then by County and SCAG Region:
# Use household level weights- WGTP:
# Percentages of Single Parent Household categories by gender of Head of Household by county and SCAG
#                                         
# Household/family type (includes cohabiting) == HHT2
# Value       Label		
#  bb	   N/A (GQ/vacant)
#  01	   Married couple household with children of the householder less than 18
#  02	   Married couple household, no children of the householder less than 18
#  03	   Cohabiting couple household with children of the householder less than 18
#  04	   Cohabiting couple household, no children of the householder less than 18
#  05	   Female householder, no spouse/partner present, living alone
#  06	   Female householder, no spouse/partner present, with children of the householder less than 18
#  07	   Female householder, no spouse/partner present, with relatives, no children of the householder less than 18
#  08	   Female householder, no spouse/partner present, only nonrelatives present
#  09	   Male householder, no spouse/partner present, living alone
#  10	   Male householder, no spouse/partner present, with children of the householder less than 18
#  11	   Male householder, no spouse/partner present, with relatives, no children of the householder less than 18
#  12	   Male householder, no spouse/partner present, only nonrelatives present
#  
# Create new var named single_hh
# If HHT2 == 06	   Female householder, no spouse/partner present, with children of the householder less than 18
# # Then single_hh == "female_hh"
# If HHT2 == 10	   Male householder, no spouse/partner present, with children of the householder less than 18
# Then single_hh == "male_hh"
# Otherwise, single_hh == "cohabit_or_nokids"
# ca_pums_scag <- ca_pums_scag %>% mutate(single_hh = factor(case_when(HHT2 == 6  ~ "female_hh",
#                                                                      HHT2 == 10  ~ "male_hh",
#                                                                      HHT2 %in% c(1:5,7:9,11:12) ~ "cohabit_or_nokids"
#                                                                      ), levels = c("female_hh", "male_hh","cohabit_or_nokids"))
#                                         ) 

# Get Single Parent Households percentages for all SCAG:
# scag_single_hh_total <- ca_pums_scag %>% select(WGTP, single_hh)  %>% count(single_hh, wt = WGTP) %>% mutate(total_pop = sum(n)) %>% 
#                                         group_by(single_hh) %>% summarize(SCAG = round( (n / total_pop)*100, 2)) %>% filter(single_hh %in% c("female_hh","male_hh")) %>% ungroup()
#                                         
# 
# # Get Single Parent Households percentages for by county for each SCAG County:
# scag_single_hh_county <- ca_pums_scag %>% select(WGTP, single_hh, county) %>% group_by(county) %>% count(single_hh, wt = WGTP) %>% mutate(total_pop = sum(n)) %>% ungroup() %>% 
#                                          group_by(single_hh, county) %>% summarize(single_hh_perc = round( (n / total_pop)*100, 2)) %>% 
#                                          pivot_wider(names_from = county, values_from = single_hh_perc) %>% filter(single_hh %in% c("female_hh","male_hh")) %>% ungroup()
# 
# # Full join all scag_total tables, and pivot_longer() to have county three columns: age_categories, county, and corresponding percentages:
# single_hh_scag_table <- left_join(scag_single_hh_county, scag_single_hh_total, by = join_by(single_hh)) %>% ungroup() %>%
#                                 pivot_longer(cols = Imperial:SCAG, names_to = "county", values_to = "percentages") %>% 
#                                 rename(single_parent_households = single_hh)
# single_hh_scag_table

# Use weight_perc_table_filter():
# Pass in data and calculate weighted percentages using hh level weights- "WGTP", for variable "single_hh", set county to factor, arrange by "single_hh" and "county", 
# then rename columns: 
single_hh_scag_table <- ca_pums_scag %>% weight_perc_table_filter(var = "single_hh", weight = "WGTP", group = "county") %>% 
                                            filter(single_hh %in% c("female_hh","male_hh")) %>% 
                                            mutate(county = factor(county, levels = county_levels)) %>% 
                                            arrange(single_hh, county) %>% rename(gender_head_of_household = single_hh, single_parent_hh_percentage = percentage) 
single_hh_scag_table

# Write out table to .csv in "output/tables" folder and once the file exists remove from current environment all tibbles used to make the final table:
write_csv(single_hh_scag_table, here(tables_fp, "single_hh_scag_table.csv"))
if (file.exists(here(tables_fp, 'single_hh_scag_table.csv'))) {rm(list = ls(pattern = "single_hh"))}

```

### National Origin (% Foreign born) by County and SCAG Region

```{r natl_origin}
### 
# National Origin (% Foreign born) by County and SCAG Region
# Use person level weights- PWGTP:
# Percentages of Foreign born by county and SCAG
#                             
# National Origin == NATIVITY
# Value    Label		
#  1        Native
#  2	    Foreign born
#  
# sum over if NATIVITY == 2 

# Get Foreign born percentages for all SCAG:
# scag_natl_origin_total <- ca_pums_scag %>% select(PWGTP, NATIVITY)  %>% count(NATIVITY, wt = PWGTP) %>% mutate(total_pop = sum(n)) %>% 
#                                         group_by(NATIVITY) %>% summarize(natl_origin_perc = round( (n / total_pop)*100, 2)) %>% filter(NATIVITY == 2) %>% ungroup() %>% 
#                                         mutate(county = "SCAG") %>% select(county, natl_origin_perc)
#                                         
# 
# # Get Foreign born percentages for by county for each SCAG County:
# scag_natl_origin_county <- ca_pums_scag %>% select(PWGTP, NATIVITY, county) %>% group_by(county) %>% count(NATIVITY, wt = PWGTP) %>% mutate(total_pop = sum(n)) %>% 
#                                         group_by(NATIVITY, county) %>% summarize(natl_origin_perc = round( (n / total_pop)*100, 2)) %>% filter(NATIVITY == 2) %>% ungroup() %>% 
#                                          select(county, natl_origin_perc)
# 
# # Full join all scag_total tables, and pivot_longer() to have county three columns: age_categories, county, and corresponding percentages:
# natl_origin_scag_table <- full_join(scag_natl_origin_county, scag_natl_origin_total, by = join_by(county, natl_origin_perc)) 
# 
# natl_origin_scag_table

# Use weight_perc_table_filter():
# Pass in data and calculate weighted percentages using person level weights- "PWGTP", for variable "age_3_cat", set county to factor, arrange by "age_3_cat" and "county", 
# then rename "age_3_cat" to "age_categories": 
natl_origin_scag_table <- ca_pums_scag %>% weight_perc_table_filter(var = "NATIVITY", weight = "PWGTP", group = "county", filter_value = 2) %>% 
                                            mutate(county = factor(county, levels = county_levels)) %>% 
                                            rename(foreign_born_percentage = percentage) 
natl_origin_scag_table

# Write out table to .csv in "output/tables" folder and once the file exists remove from current environment all tibbles used to make the final table:
write_csv(natl_origin_scag_table, here(tables_fp, "natl_origin_scag_table.csv"))
if (file.exists(here(tables_fp, 'natl_origin_scag_table.csv'))) {rm(list = ls(pattern = "natl_origin"))}

```


### Limited English Proficiency (%) by County and SCAG Region

```{r LEP}
### 
# Limited English Proficiency (LEP %) by County and SCAG Region
# Use person level weights- PWGTP:
# Percentages of LEP by county and SCAG
#      
# SAS Example:                       
# *------- 4. English Proficiency -------------------------------------;
# *ENG Character 1
# Ability to speak English
# b .N/A (less than 5 years old/speaks only English)
# 1 .Very well
# 2 .Well
# 3 .Not well
# 4 .Not at all;
#   
# New variable named "lep"
# lep == "limited_english_proficiency" if ENG == 3 | if ENG == 4
# lep == "english_proficient" if ENG == 3 | if ENG == 4
# lep == "<5yos_or_no_eng" if is.na(ENG) or TRUE
# ca_pums_scag <- ca_pums_scag %>% mutate(lep = factor(case_when(ENG %in% c(3:4) ~ "limited_english_proficiency",
#                                                                ENG %in% c(1:2) ~ "english_proficient",
#                                                                TRUE ~ "<5yos_or_no_eng"),
#                                                     levels = c("limited_english_proficiency","english_proficient","<5yos_or_no_eng")
#                                                     )
#                                         )

# Get LEP percentages for all SCAG:
# scag_lep_total <- ca_pums_scag %>% select(PWGTP, lep)  %>% count(lep, wt = PWGTP) %>% mutate(total_pop = sum(n)) %>% 
#                                         group_by(lep) %>% summarize(lep_perc = round( (n / total_pop)*100, 2)) %>% filter(lep == "limited_english_proficiency") %>% ungroup() %>% 
#                                         mutate(county = "SCAG") %>% select(county, lep_perc)
#                                         
# 
# # Get LEP percentages for by county for each SCAG County:
# scag_lep_county <- ca_pums_scag %>% select(PWGTP, lep, county) %>% group_by(county) %>% count(lep, wt = PWGTP) %>% mutate(total_pop = sum(n)) %>% 
#                                         group_by(lep, county) %>% summarize(lep_perc = round( (n / total_pop)*100, 2)) %>% filter(lep == "limited_english_proficiency") %>% ungroup() %>% 
#                                          select(county, lep_perc)
# 
# # Full join all scag_total tables, and pivot_longer() to have county three columns: age_categories, county, and corresponding percentages:
# lep_scag_table <- full_join(scag_lep_county, scag_lep_total, by = join_by(county, lep_perc)) 
# lep_scag_table

# Use weight_perc_table_filter():
# Pass in data and calculate weighted percentages using person level weights- "PWGTP", for variable "lep", set county to factor,  
# then rename "percentage" to "limited_english_proficiency_percentage": 
lep_scag_table <- ca_pums_scag %>% weight_perc_table_filter(var = "lep", weight = "PWGTP", group = "county", filter_value = "limited_english_proficiency") %>% 
                                            mutate(county = factor(county, levels = county_levels)) %>% 
                                            rename(limited_english_proficiency_percentage = percentage) 
lep_scag_table

# Write out table to .csv in "output/tables" folder and once the file exists remove from current environment all tibbles used to make the final table:
write_csv(lep_scag_table, here(tables_fp, "lep_scag_table.csv"))
if (file.exists(here(tables_fp, 'lep_scag_table.csv'))) {rm(list = ls(pattern = "lep"))}

```

### People with Disabilities (%) by County and SCAG Region

```{r disablities}
### 
# People with Disabilities (%) by County and SCAG Region
# Use person level weights- PWGTP:
# Percentages of LEP by county and SCAG
# Filter to DIS == 1 
#      
# Disability recode == DIS
# Value     Label
# 1	    With a disability
# 2	    Without a disability

# Get People with Disabilities percentages for all SCAG:
# scag_dis_total <- ca_pums_scag %>% select(PWGTP, DIS)  %>% count(DIS, wt = PWGTP) %>% mutate(total_pop = sum(n)) %>% 
#                                         group_by(DIS) %>% summarize(dis_perc = round( (n / total_pop)*100, 2)) %>% filter(DIS == 1 ) %>% ungroup() %>% 
#                                         mutate(county = "SCAG") %>% select(county, dis_perc)
#                                         
# 
# # Get People with Disabilities percentages for by county for each SCAG County:
# scag_dis_county <- ca_pums_scag %>% select(PWGTP, DIS, county) %>% group_by(county) %>% count(DIS, wt = PWGTP) %>% mutate(total_pop = sum(n)) %>% 
#                                         group_by(DIS, county) %>% summarize(dis_perc = round( (n / total_pop)*100, 2)) %>% filter(DIS == 1 ) %>% ungroup() %>% 
#                                          select(county, dis_perc)
# 
# # Full join all scag_total tables, and pivot_longer() to have county three columns: age_categories, county, and corresponding percentages:
# dis_scag_table <- full_join(scag_dis_county, scag_dis_total, by = join_by(county, dis_perc)) 
# dis_scag_table

# Use weight_perc_table_filter():
# Pass in data and calculate weighted percentages using person level weights- "PWGTP", for variable "DIS", set county to factor,  
# then rename "percentage" to "disabilities_percentage": 
dis_scag_table <- ca_pums_scag %>% weight_perc_table_filter(var = "DIS", weight = "PWGTP", group = "county", filter_value = 1) %>% 
                                            mutate(county = factor(county, levels = county_levels)) %>% 
                                            rename(disabilities_percentage = percentage) 
dis_scag_table

# Write out table to .csv in "output/tables" folder and once the file exists remove from current environment all tibbles used to make the final table:
write_csv(dis_scag_table, here(tables_fp, "dis_scag_table.csv"))
if (file.exists(here(tables_fp, 'dis_scag_table.csv'))) {rm(list = ls(pattern = "dis"))}

```

### Disabilites by category (%) by County and SCAG Region

- 6 categories of disabilities: Self-care, Hearing, Vision, Independent, Ambulatory, Cognitive

```{r disablities_cat}
### 
### Disabilites by category (%) by County and SCAG Region
# Use person level weights- PWGTP:
# Percentages of Disabilites broken down into 6 categories and also by county and SCAG
# Filter to DIS == 1 
# Title: var_code
# Value     Label
# Self-care difficulty  == DDRS
# b	N/A (Less than 5 years old)
# 1	Yes
# 2	No
# Hearing difficulty == DEAR	
# 1	Yes
# 2	No
# Vision difficulty == DEYE	
# 1	Yes
# 2	No
# Independent living difficulty == DOUT		
# b	N/A (Less than 15 years old)
# 1	Yes
# 2	No
# Ambulatory difficulty == DPHY		
# b	N/A (Less than 5 years old)
# 1	Yes
# 2	No
# Cognitive difficulty == DREM		
# b	N/A (Less than 5 years old)
# 1	Yes
# 2	2	No

# Function to return full table of weighted percentages by group and filtered to one value of a variable: weight_perc_table_filter()
# df = dataframe of all data, var = variable to sum over,  weight = weights, group = grouping variable, filter_value = value of a variable to filter output to.
# has and if statement to drop filter_value if NULL, which it is by default

# List of variable names and text to add as disability_type:
disability_list <- list(var_names =  c("DDRS", "DEAR", "DEYE", "DOUT", "DPHY", "DREM"),
                        text_vars = c("Self-care difficulty", "Hearing difficulty","Vision difficulty", "Independent living", "Ambulatory difficulty", "Cognitive difficulty"))

# use map2(), to iterate over both elements of disability_list- the x = "var_names" and y ="text_vars", pass to function and use bind_rows() to turn the list of tibbles into a single tibble that is the full
# table of each disablity_type percentage by county and all of SCAG 
categories_dis_scag_table <- map2(disability_list[["var_names"]], disability_list[["text_vars"]], 
                                  function(x,y) weight_perc_table_filter(df = ca_pums_scag, var = x, weight = "PWGTP", group = "county", filter_value = 1) %>% 
                                                mutate(disability_type = y) %>% 
                                                select(county, disability_type, percentage)
                                  ) %>% bind_rows()
categories_dis_scag_table

# Vector of variable names and a vector of text to add as disability_type to each tibble:

disability_var_names <- c("DDRS", "DEAR", "DEYE", "DOUT", "DPHY", "DREM")
disability_text_vars <- c("Self-care difficulty", "Hearing difficulty","Vision difficulty", "Independent living", "Ambulatory difficulty", "Cognitive difficulty")

# use map2(), to iterate over both elements of disability_list- the x = "var_names" and y ="text_vars", pass to function and use bind_rows() to turn the list of tibbles into a single tibble that is the full
# table of each disablity_type percentage by county and all of SCAG 
categories_dis_scag_table <- map2(.x = disability_var_names, .y =  disability_text_vars, 
                                  function(x,y) weight_perc_table_filter(df = ca_pums_scag, var = x, weight = "PWGTP", group = "county", filter_value = 1) %>% 
                                                mutate(disability_type = y) %>% 
                                                select(county, disability_type, percentage)
                                  ) %>% bind_rows()
categories_dis_scag_table

# Write out table to .csv in "output/tables" folder and once the file exists remove from current environment all tibbles used to make the final table:
write_csv(categories_dis_scag_table, here(tables_fp, "categories_dis_scag_table.csv"))
if (file.exists(here(tables_fp, 'categories_dis_scag_table.csv'))) {rm(list = ls(pattern = "categories_dis"))}

```


### Educational Attainment (%) by Race/ethincity and whole SCAG Region

- 6 categories of disabilities: Self-care, Hearing, Vision, Independent, Ambulatory, Cognitive

```{r education}
### 
### Disabilites by category (%) by County and SCAG Region
# Use person level weights- PWGTP:
# Filter to people over 25, filter(AGEP > 25)
# **Educational Attainment** (REBCR Economy section)- Filter to people over 25, these 6 categories: "LESS THAN HS DIPLOMA", "HS DIPLOMA", "SOME 
#   COLLEGE", "AA DEGREE", "BA DEGREE", "MA DEGREE". By race and also report the whole SCAG Region
# Education Categories: named var "edu"
# SAS example- 
# *------- 7.Educational attainment for the population age 25+ -------------;
# 
# edu=.;
# if AGEP>=25 then do;
# 	edu=0;
#     if SCHL ge 1 and SCHL le 15 then edu=1; *less than a high school diploma;
#     if SCHL ge 16 and SCHL le 17 then edu=2; *high school diploma;
#     if SCHL ge 18 and SCHL le 19 then edu=3; *some college;
#     if SCHL=20 then edu=4; *AA degree;
#     if SCHL=21 then edu=5; *BA degree;
#     if SCHL ge 22 then edu=6; *MA degree or higher;
# end;
# 
# ca_pums_scag <- ca_pums_scag %>% mutate(edu = factor(case_when(SCHL %in% c(1:15)  ~ "Less than HS Diploma",
#                                                                SCHL %in% c(16:17) ~ "HS Diploma",
#                                                                SCHL %in% c(18:19) ~ "Some College", 
#                                                                SCHL == 20 ~ "AA Degree", 
#                                                                SCHL == 21 ~ "BA degree", 
#                                                                SCHL %in% c(22:24) ~ "MA degree or higher" 
#                                                                ), levels = c("Less than HS Diploma", "HS Diploma", "Some College", "AA Degree", "BA degree", "MA degree or higher"))
#                                         )
#                                         
# Function to return full table of weighted percentages by group and filtered to one value of a variable: weight_perc_table()
# df = dataframe of all data, var = variable to sum over,  weight = weights, group = grouping variable, filter_value = value of a variable to filter output to.
# has and if statement to drop filter_value if NULL, which it is by default

# function(df, var, weight, group) {
#     
#     # Get var percentages for all:
#     overall_perc <- df %>% select({{weight}}, {{var}})  %>% count(!!sym((var)), wt = !!sym((weight))) %>% mutate(total_pop = sum(n)) %>% 
#                                             group_by(!!sym((var))) %>% summarize(percentage = round( (n / total_pop)*100, 2)) %>% filter(!!sym((var)) == filter_value) %>% ungroup() %>% 
#                                             mutate({{group}} := "SCAG") %>% select({{group}}, percentage)
#                                             
# 
#     # Get var percentages for by group:
#     group_perc <- df %>% select({{weight}}, {{var}}, {{group}}) %>% group_by(!!sym((group))) %>% count(!!sym((var)), wt = !!sym((weight))) %>% mutate(total_pop = sum(n)) %>% 
#                                             group_by(!!sym((var)), !!sym((group))) %>% summarize(percentage = round( (n / total_pop)*100, 2)) %>% filter(!!sym((var)) == filter_value) %>% ungroup() %>% 
#                                              select({{group}}, percentage)
# 
#     # Full join all Self-care difficulty tables, and pivot_longer() to have group three columns: age_categories, group, and corresponding percentages:
#     full_table <- full_join(group_perc, overall_perc, by = join_by({{group}}, percentage)) 
# 
#     return(full_table)
# 
# }
# ca_pums_scag %>% filter(AGEP > 25) %>% drop_na(edu) %>% weight_perc_table(var = "edu", weight = "PWGTP", group = "county")


# Get edu percentages for all SCAG:
# scag_edu_perc_total <- ca_pums_scag %>% filter(AGEP > 25) %>% drop_na(edu) %>% select(PWGTP, edu) %>% count(edu, wt = PWGTP) %>% mutate(total_pop = sum(n)) %>% 
#                                         group_by(edu) %>% summarize(percentage = round( (n / total_pop)*100, 2)) %>% mutate(race = "SCAG region")
# 
# # Get edu percentages for by county for each SCAG County:
# scag_edu_perc_county <- ca_pums_scag %>% filter(AGEP > 25) %>% drop_na(edu) %>% select(PWGTP, edu, race) %>% group_by(race) %>% count(edu, wt = PWGTP) %>% 
#                                          mutate(total_pop = sum(n)) %>% ungroup() %>% 
#                                          group_by(edu, race) %>% summarize(percentage = round( (n / total_pop)*100, 2)) 
# # Full join all scag_total tables:
# edu_perc_scag_table <- full_join(scag_edu_perc_county, scag_edu_perc_total, by = join_by(edu, race, percentage)) %>% arrange(edu) %>% ungroup() %>% rename(education_level = edu)
# edu_perc_scag_table

# Use weight_perc_table_filter():
# Pass in data and calculate weighted percentages using person level weights- "PWGTP", for variable "edu", set county to race,  
# then rename "percentage" to "disabilities_percentage": 
edu_perc_scag_table <- ca_pums_scag %>% filter(AGEP > 25) %>% drop_na(edu) %>% weight_perc_table_filter(var = "edu", weight = "PWGTP", group = "race") %>% 
                                            mutate(race = if_else(race == "SCAG", "SCAG Region", race),
                                                   race = factor(race, levels = race_levels)) %>% 
                                            arrange(edu, race) %>% 
                                            rename(education_level = edu)
edu_perc_scag_table 

# Write out table to .csv in "output/tables" folder and once the file exists remove from current environment all tibbles used to make the final table:
write_csv(edu_perc_scag_table, here(tables_fp, "edu_perc_scag_table.csv"))
if (file.exists(here(tables_fp, 'edu_perc_scag_table.csv'))) {rm(list = ls(pattern = "edu_perc"))}

```

<!-- # TODO: ABOVE figures changed to long format, need to change all below this point -->

### Median Household Income by Race/ethincity and whole SCAG Region

```{r med_hh_incom}
### 
### Median Household Income by Race/ethincity and whole SCAG Region
# Use person level weights- WGTP:
# filter(RELSHIPP == 20) Only household level
# use weighted median for only households
# 
### 
# Household Income:
# # Create new variable "housing_income" by multiplying HINCP by ADJINC for each given year:
# SAS Example
# *------- H2.Median Household Income  -------------;
# 
# *
# ADJINC Character 7
# Adjustment factor for income and earnings dollar amounts (6 implied decimal places)
# 1117630 .2017 factor (1.011189 * 1.10526316)
# 1093093 .2018 factor (1.013097 * 1.07896160)
# 1070512 .2019 factor (1.010145 * 1.05976096)
# 1053131 .2020 factor (1.006149 * 1.04669465)
# 1029928 .2021 factor (1.029928 * 1.00000000);
# 
# HHINC=.;
# if ADJINC=1117630 then HHINC=HINCP*1.011189 * 1.10526316; 	*2017 Adjust Income ($2021);
# if ADJINC=1093093 then HHINC=HINCP*1.013097 * 1.07896160; 	*2018 Adjust Income ($2021);
# if ADJINC=1070512 then HHINC=HINCP*1.010145 * 1.05976096; 	*2019 Adjust Income ($2021);
# if ADJINC=1053131 then HHINC=HINCP*1.006149 * 1.04669465; 	*2020 Adjust Income ($2021);
# if ADJINC=1029928 then HHINC=HINCP*1.029928 * 1.00000000; 	*2021 Adjust Income ($2021);

# Create new variable "housing_income" by multiplying HINCP by ADJINC for each given year:
# ca_pums_scag <- ca_pums_scag %>% mutate(housing_income = case_when(ADJINC == 1117630 ~ HINCP * 1.011189 * 1.10526316, # 2017 Adjust Income
#                                                                    ADJINC == 1093093 ~ HINCP * 1.013097 * 1.07896160, # 2018 Adjust Income
#                                                                    ADJINC == 1070512 ~ HINCP * 1.010145 * 1.05976096, # 2019 Adjust Income
#                                                                    ADJINC == 1053131 ~ HINCP * 1.006149 * 1.04669465, # 2020 Adjust Income
#                                                                    ADJINC == 1029928 ~ HINCP * 1.029928 * 1.00000000, # 2021 Adjust Income
#                                         )
#                         ) 
                        
# Get median hh income for all SCAG:
scag_med_hh_income_total <- ca_pums_scag %>% filter(RELSHIPP == 20) %>% drop_na(housing_income) %>% select(WGTP, housing_income)  %>% 
                                             summarize(
                                               med_hh_income = round(weighted.median(housing_income, WGTP, na.rm = TRUE),2)
                                             ) %>% mutate(race = "SCAG region") %>% select(race,  med_hh_income)

# Get median hh income for by race for each SCAG County:
scag_med_hh_income_county <- ca_pums_scag %>% filter(RELSHIPP == 20) %>% drop_na(housing_income) %>% select(WGTP, housing_income, race)  %>% 
                                              group_by(race) %>% 
                                              summarize(
                                                med_hh_income = round(weighted.median(housing_income, WGTP, na.rm = TRUE),2)
                                              ) %>%  select(race, med_hh_income)

# Full join all scag_total tables:
med_hh_income_scag_table <- full_join(scag_med_hh_income_county, scag_med_hh_income_total, by = join_by(med_hh_income, race)) %>% rename(median_household_income = med_hh_income)
med_hh_income_scag_table

# Write out table to .csv in "output/tables" folder and once the file exists remove from current environment all tibbles used to make the final table:
write_csv(med_hh_income_scag_table, here(tables_fp, "med_hh_income_scag_table.csv"))
if (file.exists(here(tables_fp, 'med_hh_income_scag_table.csv'))) {rm(list = ls(pattern = "med_hh_income"))}

```


### Household Poverty (%) by Race/ethincity and whole SCAG Region

```{r poverty_hh}
### 
# Use household level weights- WGTP:
# Filter only households: filter(RELSHIPP == 20)
# if poverty == "Yes"- this is if the respondent is less than 200 percent below the poverty line

# Use weight_perc_table_filter():
# Function to return full table of weighted percentages by group and filtered to one value of a variable: weight_perc_table_filter()
# df = dataframe of all data, var = variable to sum over,  weight = weights, group = grouping variable, filter_value = value of a variable to filter output to.
# has and if statement to drop filter_value if NULL, which it is by default
# 
# Pass in data filtered to only hh (filter(RELSHIPP == 20)), calculate weighted percentages using hh level weights- "WGTP", for variable "poverty" and filter to "poverty" == "Yes": 
poverty_hh_scag_table <- ca_pums_scag %>% filter(RELSHIPP == 20) %>% 
                            weight_perc_table_filter(var = "poverty", weight = "WGTP", group = "race", filter_value = "Yes") %>% 
                                rename(household_poverty_percentage = percentage)
poverty_hh_scag_table

# Write out table to .csv in "output/tables" folder and once the file exists remove from current environment all tibbles used to make the final table:
write_csv(poverty_hh_scag_table, here(tables_fp, "poverty_hh_scag_table.csv"))
if (file.exists(here(tables_fp, 'poverty_hh_scag_table.csv'))) {rm(list = ls(pattern = "poverty_hh"))}

```


--- 


### Write out excel file with all sheets:

```{r write_excel}
# Read in completed tables and set to tibbles in current global env:
# Read in all the tables from the folder "output/tables" and keep names from the files:
table_file_list <- lapply(list.files(here(tables_fp), full.names = TRUE), function(x) { read_csv(x, show_col_types = FALSE) } )

# Set names of each list element to the actual file name without path and file extension:
table_file_list <- set_names(table_file_list, file_path_sans_ext(path_file(list.files(here(tables_fp), full.names = TRUE))))

# convert each list item into a tibble (map(as_tibble)) and save to the current global env (list2env(envir = .GlobalEnv)):
table_file_list %>% 
  map(as_tibble) %>%
  list2env(envir = .GlobalEnv)

### Create tabbed excel workbook for SCAG:
# Set up up a tibble to use as a table of contents (toc) for output tabbed excel workbook named "scag_tabbed.xlsx":
toc <- tribble(~sheet_name, ~ figure_name,
              "Figure_5",  "Figure 5. Workers who Commute by Walk, Bike, or Public Transit by Race and Ethnicity",
              "Figure_6",  "Figure 6. Householders without a Vehicle by Race and Ethnicity",
              "Figure_7",  "Figure 7. Workers’ Commute Times (Minutes) by Mode and Race and Ethnicity",
              "Figure_19", "Figure 19. Renters and Homeowners Experiencing Housing Cost Burden by Race and Ethnicity",
              "Figure_20", "Figure 20. People Living in Households Without Kitchen and Plumbing Facilities by Race and Ethnicity",
              "Figure_21",  "Figure 21. Households with Severe Overcrowding by Race and Ethniciy",
              "Figure_22",  "Figure 22. Homeownership by Race and Ethniciy",
              "Figure_28",  "Figure 28. People without Health Insurance by Race and Ethnicity",
              "Figure_39", "Figure 39. Median Hourly Wage by Race and Ethnicity",
              "Figure_40", "Figure 40. Unemployment by Race and Ethnicity",
              "Figure_41", "Figure 41. Working Poor by Race and Ethnicity",
              "Total_Population", "Total Population by County and SCAG Region",
              "Race_Ethnicity", "Race/Ethnicity Distribution (%) by County and SCAG Region",
              "Age", "Age Distribution (%) by County and SCAG Region",
              "Singe_Parent_HHs", "Single Parent Households (%) by Gender of Head of Household and then by County and SCAG Region",
              "Natl_Origin", "National Origin (% Foreign born) by County and SCAG Region",
              "LEP", "Limited English Proficiency (%) by County and SCAG Region",
              "Disablity", "People with Disabilities (%) by County and SCAG Region",
              "Categories_Disablity", "Disabilites by 6 categories (%) and then by County and SCAG Region: Self-care, Hearing, Vision, Independent, Ambulatory, Cognitive",
              "Education", "Educational Attainment (%) by Race/ethincity and whole SCAG Region",
              "Median_HH_Income", "Median Household Income by Race/ethincity and whole SCAG Region",
              "Poverty_HH","Household Poverty (%) by Race/ethincity and whole SCAG Region") 

# Write out table to new sheet in excel file for tabbed SCAG output, list is this format: ("name of new sheet" = df/tibble)
# Make a list that has the name or each sheets and the df/tibble that will populate it- e.g below "homeownership_scag_table" is a tibble that will populate the sheet named "Figure_22".
sheets <- list("TOC" = toc,
               "Figure_5" = walk_bike_public_scag_table,
               "Figure_6" = no_veh_scag_table,
               "Figure_7" = transport_mean_scag_table,
               "Figure_19" = housing_burden_scag_table,
               "Figure_20" = no_kitchen_plumbing_scag_table,
               "Figure_21" = overcrowded_scag_table,
               "Figure_22" = homeownership_scag_table, 
               "Figure_28" = no_hicov_scag_table,
               "Figure_39" = med_hr_wage_scag_table,
               "Figure_40" = unemployed_scag_table,
               "Figure_41" = working_poor_scag_table,
               "Total_Population" = total_pop_scag_table,
               "Race_Ethnicity" = race_perc_scag_table,
               "Age" = age_perc_scag_table,
               "Singe_Parent_HHs" = single_hh_scag_table,
               "Natl_Origin" = natl_origin_scag_table,
               "LEP" = lep_scag_table,
               "Disablity" = dis_scag_table,
               "Categories_Disablity" = categories_dis_scag_table,
               "Education" = edu_perc_scag_table,
               "Median_HH_Income" = med_hh_income_scag_table,
               "Poverty_HH" = poverty_hh_scag_table) 

# Create an output folder if it does NOT exist already:
if (!dir.exists("output")) {dir.create("output")}

# Pass sheet list to write_xlsx() and destination "path/filename.xlsx", write to "output/scag_tabbed.xlsx":
write_xlsx(sheets, "output/scag_tabbed.xlsx")

# Remove all variables created in this chunk:
rm(list = (names(table_file_list)), table_file_list, sheets, toc)

### ----
# Extra bit to "auto" fit all column widths in all sheets of the workbook using openxlsx2 package:
library(openxlsx2)
# First, load the excel workbook we just created:
scag_wb <- wb_load(file = "output/scag_tabbed.xlsx")

# Get a list of sheets from the workbook "scag_wb":
sheets_scag_wb <- wb_get_sheet_names(scag_wb)

# Simple function to return column dimension of an object:
ncol0 <- function(x) dim(x)[2]

# Retrieve the number of columns from each sheet in the scag_tabbed.xlsx workbook using ncol0():
col_list <- map_vec(sheets_scag_wb,  path = "output/scag_tabbed.xlsx", 
                    function(sheet, path) { 
                        path %>% read_excel(sheet = sheet) %>% ncol0() 
                        }
                    )

# Use map2() to iterate over the sheet list and the col_list, first the function inside will set column widths to "auto" for whole workbook 
# (by going into each sheet and over the number of columns supplied by col_list), 
# then the next two functions will to change the font for the header row of each sheet to bold, font size 12 and centered:
map2(sheets_scag_wb, col_list, function(x, y) scag_wb %>% wb_set_col_widths(sheet = x, cols = c(1:y), widths = "auto") %>% 
                                              wb_add_font(sheet = x, dims = wb_dims(1, 1:y), bold = TRUE, size = 12) %>% 
                                              wb_add_cell_style(sheet = x, dims = wb_dims(1, 1:y), horizontal = "center")
     )

# Save workbook "scag_wb" by overwriting old file "output/scag_tabbed.xlsx":
wb_save(scag_wb, file = "output/scag_tabbed.xlsx", overwrite = TRUE)

```

--- 

```{r scratch_func_grouped, eval=FALSE, include=FALSE}
df = ca_pums_scag %>% filter(JWTRNS != 11) 
var = "walk_bike_public_transport"
weight = "PWGTP"
group1 = "county"
group2 = "race"
filter_value = "Walk/Bike/Public"
group1_levels = county_levels
group2_levels = race_levels
    
# Get percent for group1 (usually county):
group1_total <-  df %>% select({{weight}}, {{var}}, {{group1}}) %>% group_by(!!sym((group1))) %>% count(!!sym((var)), wt = !!sym((weight))) %>% mutate(total_pop = sum(n)) %>% 
                                            group_by(!!sym((var)), !!sym((group1))) %>% summarize(percentage = round( (n / total_pop)*100, 2)) %>% 
                                            filter(!!sym((var)) == filter_value) %>% mutate({{group2}} := "SCAG Region") %>% ungroup() %>%
                                            select({{group1}}, {{group2}},  percentage)
# Get percent for group2 (usually county):
group2_total <-  df %>% select({{weight}}, {{var}}, {{group2}}) %>% group_by(!!sym((group2))) %>% count(!!sym((var)), wt = !!sym((weight))) %>% mutate(total_pop = sum(n)) %>% 
                                            group_by(!!sym((var)), !!sym((group2))) %>% summarize(percentage = round( (n / total_pop)*100, 2)) %>% 
                                            filter(!!sym((var)) == filter_value) %>% mutate({{group1}} := "SCAG") %>% ungroup() %>% 
                                            select({{group1}}, {{group2}},  percentage)
# Get percent for group2 (usually county):
group1_by_group2_total <-  df %>% select({{weight}}, {{var}}, {{group1}}, {{group2}}) %>% group_by(!!sym((group1)), !!sym((group2))) %>% 
                                          count(!!sym((var)), wt = !!sym((weight))) %>% mutate(total_pop = sum(n)) %>% 
                                            group_by(!!sym((var)), !!sym((group1)), !!sym((group2))) %>% summarize(percentage = round( (n / total_pop)*100, 2)) %>% 
                                            filter(!!sym((var)) == filter_value) %>% ungroup() %>% 
                                             select({{group1}}, {{group2}},  percentage)
# Get percent for group2 (usually county):
total_overall <-  df %>% select({{weight}}, {{var}}) %>% count(!!sym((var)), wt = !!sym((weight))) %>% mutate(total_pop = sum(n)) %>% 
                                          group_by(!!sym((var))) %>%  summarize(percentage = round( (n / total_pop)*100, 2)) %>% 
                                            filter(!!sym((var)) == filter_value) %>% mutate({{group1}} := "SCAG") %>% ungroup() %>% 
                                             select({{group1}}, percentage) 
# Full join all scag_total tables:
group1_total_overall_tbl <- full_join(group1_total, total_overall) %>% mutate(race = "SCAG Region")
# Full join all scag_race tables, then left join scag_total_no_veh_table by county:
full_table <- full_join(group1_by_group2_total,group1_total_overall_tbl) %>% full_join(.,group2_total) 

if (!is.null(group1_levels) & !is.null(group2_levels)) {
    
# If levels are provided for both group1_levels and group2_levels- set each as a factor with levels and then arrange by group1,group2:
full_table <- full_table %>% mutate({{group1}} := factor(!!sym((group1)), levels = group1_levels),
                                    {{group2}} := factor(!!sym((group2)), levels = group2_levels)) %>% 
                             arrange(desc({{group2}}),{{group1}}) 
} 

full_table

# 
### Functions ----
### weight_perc_2groups()
# Function to return full table of weighted percentages by group and filtered to one value of a variable: weight_perc_2groups
# df = dataframe of all data, var = variable to sum over,  weight = weights, group1 = grouping variable 1 (county), group2 = grouping variable 2 (race),
#  filter_value = value of a variable to filter output to.
# has and if statement to drop filter_value if NULL, which it is by default group_by(across(variables_2))
weight_perc_2groups <- function(df, var, weight, group1, group2, filter_value = NULL, group1_levels = NULL, group2_levels = NULL) {
    # If filter_value is not NULL:
    if (!is.null(filter_value)) {
    # Get percent for group1 (usually county):
    group1_total <-  df %>% select({{weight}}, {{var}}, {{group1}}) %>% group_by(!!sym((group1))) %>% count(!!sym((var)), wt = !!sym((weight))) %>% mutate(total_pop = sum(n)) %>% 
                                                group_by(!!sym((var)), !!sym((group1))) %>% summarize(percentage = round( (n / total_pop)*100, 2)) %>% 
                                                filter(!!sym((var)) == filter_value) %>% ungroup() %>% mutate({{group2}} := "SCAG Region") %>% select({{group1}}, {{group2}},  percentage)

    # Get percent for group2 (usually county):
    group2_total <-  df %>% select({{weight}}, {{var}}, {{group2}}) %>% group_by(!!sym((group2))) %>% count(!!sym((var)), wt = !!sym((weight))) %>% mutate(total_pop = sum(n)) %>% 
                                                group_by(!!sym((var)), !!sym((group2))) %>% summarize(percentage = round( (n / total_pop)*100, 2)) %>% 
                                                filter(!!sym((var)) == filter_value) %>% ungroup() %>% mutate({{group1}} := "SCAG") %>% select({{group1}}, {{group2}},  percentage)

    # Get percent for group2 (usually county):
    group1_by_group2_total <-  df %>% select({{weight}}, {{var}}, {{group1}}, {{group2}}) %>% group_by(!!sym((group1)), !!sym((group2))) %>% 
                                              count(!!sym((var)), wt = !!sym((weight))) %>% mutate(total_pop = sum(n)) %>% 
                                                group_by(!!sym((var)), !!sym((group1)), !!sym((group2))) %>% summarize(percentage = round( (n / total_pop)*100, 2)) %>% 
                                                filter(!!sym((var)) == filter_value) %>% ungroup() %>% 
                                                 select({{group1}}, {{group2}},  percentage)

    # Get percent for group2 (usually county):
    total_overall <-  df %>% select({{weight}}, {{var}}) %>% count(!!sym((var)), wt = !!sym((weight))) %>% mutate(total_pop = sum(n)) %>% 
                                              group_by(!!sym((var))) %>%  summarize(percentage = round( (n / total_pop)*100, 2)) %>% 
                                                filter(!!sym((var)) == filter_value) %>% ungroup() %>%  mutate({{group1}} := "SCAG") %>% 
                                                 select({{group1}}, percentage)

    # Full join all scag_total tables:
    group1_total_overall_tbl <- full_join(group1_total, total_overall) %>% mutate(race = "SCAG Region")

    # Full join all scag_race tables, then left join scag_total_no_veh_table by county:
    full_table <- full_join(group1_by_group2_total,group1_total_overall_tbl) %>% full_join(.,group2_total) 
    
    } else { # else filter_value is NULL:
        
    # Get percent for group1 (usually county):
    group1_total <-  df %>% select({{weight}}, {{var}}, {{group1}}) %>% group_by(!!sym((group1))) %>% count(!!sym((var)), wt = !!sym((weight))) %>% mutate(total_pop = sum(n)) %>% 
                                                group_by(!!sym((var)), !!sym((group1))) %>% summarize(percentage = round( (n / total_pop)*100, 2)) %>% ungroup() %>% 
                                                mutate({{group2}} := "SCAG Region") %>% select({{group1}}, {{group2}},  percentage)

    # Get percent for group2 (usually county):
    group2_total <-  df %>% select({{weight}}, {{var}}, {{group2}}) %>% group_by(!!sym((group2))) %>% count(!!sym((var)), wt = !!sym((weight))) %>% mutate(total_pop = sum(n)) %>% 
                                                group_by(!!sym((var)), !!sym((group2))) %>% summarize(percentage = round( (n / total_pop)*100, 2)) %>% ungroup() %>% 
                                                mutate({{group1}} := "SCAG") %>% select({{group1}}, {{group2}},  percentage)

    # Get percent for group2 (usually county):
    group1_by_group2_total <-  df %>% select({{weight}}, {{var}}, {{group1}}, {{group2}}) %>% group_by(!!sym((group1)), !!sym((group2))) %>% 
                                              count(!!sym((var)), wt = !!sym((weight))) %>% mutate(total_pop = sum(n)) %>% 
                                                group_by(!!sym((var)), !!sym((group1)), !!sym((group2))) %>% 
                                                summarize(percentage = round( (n / total_pop)*100, 2)) %>% ungroup() %>% 
                                                 select({{group1}}, {{group2}},  percentage)

    # Get percent for group2 (usually county):
    total_overall <-  df %>% select({{weight}}, {{var}}) %>% count(!!sym((var)), wt = !!sym((weight))) %>% mutate(total_pop = sum(n)) %>% 
                                              group_by(!!sym((var))) %>%  summarize(percentage = round( (n / total_pop)*100, 2)) %>% ungroup() %>%  
                                                mutate({{group1}} := "SCAG") %>% select({{group1}}, percentage)

    # Full join all scag_total tables:
    group1_total_overall_tbl <- full_join(group1_total, total_overall) %>% mutate(race = "SCAG Region")

    # Full join all scag_race tables, then left join scag_total_no_veh_table by county:
    full_table <- full_join(group1_by_group2_total,group1_total_overall_tbl) %>% full_join(.,group2_total)
    
    } # End of main if/else.
    
    if (!is.null(group1_levels) & !is.null(group2_levels)) {
        
    # If levels are provided for both group1_levels and group2_levels- set each as a factor with levels and then arrange by group1,group2:
    full_table <- full_table %>% mutate({{group1}} := factor(!!sym((group1)), levels = group1_levels),
                                        {{group2}} := factor(!!sym((group2)), levels = group2_levels)) %>% 
                                 arrange(!!sym((group1)),!!sym((group2)))
    } 
    
    return(full_table)
}

# Use weight_perc_table_filter():
# Function to return full table of weighted percentages by group and filtered to one value of a variable: weight_perc_table_filter()
# df = dataframe of all data, var = variable to sum over,  weight = weights, group = grouping variable, filter_value = value of a variable to filter output to.
# has and if statement to drop filter_value if NULL, which it is by default
# 
# Pass in data filtered to only hh (filter(RELSHIPP == 20)), calculate weighted percentages using hh level weights- "WGTP", for variable "poverty" and filter to "poverty" == "Yes": 
walk_bike_public_scag_table <- ca_pums_scag %>% filter(JWTRNS != 11) %>% 
    weight_perc_2groups(var = "walk_bike_public_transport", weight = "PWGTP", group1 = "county", group2 = "race", filter_value = "Walk/Bike/Public",
                        group1_levels = county_levels, group2_levels = race_levels) %>% rename(walk_bike_public_perc = percentage)
walk_bike_public_scag_table


```

