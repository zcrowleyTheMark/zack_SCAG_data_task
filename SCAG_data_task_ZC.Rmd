---
title: "SCAG Data Task"
author: "Zack Crowley"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
# Set R chunk options:
## Set default options for R code chunks:
knitr::opts_chunk$set(
    echo = FALSE, 
    warning = FALSE, 
    message = FALSE 
    # fig.width = 6.5,
    # fig.height = 4
    )
# Prevents sci notation and sets the output of decimals to 4 (0.0000), suppresses warnings/info for tidyverse:
options(scipen = 999,
        tidyverse.quiet = TRUE,
        dplyr.summarise.inform = FALSE)

# Set here() location- working directory will be based on the project folder that this Rmd file is inside of currently:
here::i_am("SCAG_data_task_ZC.Rmd")

# Load libraries:
library(here) # package to manage file paths
library(fs)  # package to work with system file paths
library(tools) # another package to work with system file paths
library(rstudioapi) # package accessing Rstudio API 
# library(rlang) # package for R helpers
# library(rstatix)
library(magrittr) # pipe function package
library(janitor) # package for functions that help clean data
library(spatstat) # package for weighted.median() function
library(readxl) # reading excel files
library(writexl) # writing excel files
library(data.table) # package for data manipulation and reads in large files faster using fread()
library(tidycensus) # API for US Census- can access ACS PUMS directly from API- key set in .Renviron- to see use: usethis::edit_r_environ()
library(tidyverse) # package loads all tidyverse packages like dplyr, tidyselect, stringR, etc.

# library(survey) # Working with survey data
# library(srvyr) # Working with survey data with pipes

```


```{r data dicts, include=FALSE}
### 2021 ACS: 
## Get data dictionary as tibble from tidycensus for 2021:
# pums_vars_acs5 <- pums_variables %>%
#   filter(year == 2021, survey == "acs5")
# # person level
# pums_vars_acs5_person <- pums_variables %>%
#   filter(year == 2021, survey == "acs5", level == "person")
# # housing level:
# pums_vars_acs5_housing <- pums_variables %>%
#    filter(year == 2021, survey == "acs5", level == "housing")
# 
# # Write out data dicts for all vars, person and housing vars:
# write_csv(pums_vars_acs5, "data_dicts_ACS_PUMS/pums_vars_acs5.csv")
# write_csv(pums_vars_acs5_person, "data_dicts_ACS_PUMS/pums_vars_acs5_person.csv")
# write_csv(pums_vars_acs5_housing, "data_dicts_ACS_PUMS/pums_vars_acs5_housing.csv")
# 
# Read in data dicts from person and housing level data:
pums_vars_acs5 <- read_csv("data_dicts_ACS_PUMS/pums_vars_acs5.csv")
pums_vars_acs5_person <- read_csv("data_dicts_ACS_PUMS/pums_vars_acs5_person.csv")
pums_vars_acs5_housing <- read_csv("data_dicts_ACS_PUMS/pums_vars_acs5_housing.csv")

### 2022 ACS: Needed to scrape from website 
# library(rvest) # package for webscraping
# # Pull data dictionary from 2018-2022 ACS PUMS from website that has the data dict in a html table:
# acs_data_dict_22 <- "https://api.census.gov/data/2022/acs/acs5/pums/variables.html" %>% 
#   read_html() %>%
#   html_element("table") %>% 
#   html_table(convert = TRUE) %>% 
#   janitor::clean_names() 
# 
# # Drop first row- was incorrectly pulled in from footer of table ("525 variables") :
# acs_data_dict_22 <- acs_data_dict_22 %>% filter(name != "525 variables")
# 
# # write to csv called "acs_data_dict_22.csv:
# acs_data_dict_22 %>% write_csv(file = "data_dicts_ACS_PUMS/acs_data_dict_22.csv")

# Read in acs_data_dict_22
pums_vars_acs5 <- read_csv("data_dicts_ACS_PUMS/acs_data_dict_22.csv")

```


```{r setup file paths, include=FALSE}
# Set up all file paths:
# file path for all raw data:
data_fp <- here('data')
# list.files(data_fp)

### IMPORTS filepaths ---- 
# file path for 2021 5-year ACS PUMS Data:
acs_2021_fp <- here(data_fp, '2017_2021_ACS_PUMS')
# list.files(acs_2021_fp) 

# file path for 2021 person level data
person_2021_fp <- here(acs_2021_fp, "csv_pca", "psam_p06.csv")

# file path for 2021 household level data
hh_2021_fp <- here(acs_2021_fp, "csv_hca", "psam_h06.csv")

# Set up file path for 2022 5-year ACS PUMS Data:
acs_2022_fp <- here(data_fp, '2018_2022_ACS_PUMS')
# list.files(acs_2022_fp)

# file path for 2022 person level data
person_2022_fp <- here(acs_2022_fp, "csv_pca", "psam_p06.csv")

# file path for 2022 household level data
hh_2022_fp <- here(acs_2022_fp, "csv_hca", "psam_h06.csv")

### CLEAN DATA filepaths ---- 
# File paths and directories for clean data- 
# Creates a new folder called "clean_data" if it doesn't already exist in working directory:
if (!dir.exists("clean_data")) {dir.create("clean_data")}
# file path for clean_data
clean_data_fp <- here("clean_data")
# list.files(clean_data_fp)

# Clean 21 data
# Creates a new folder called "acs_data_21" (if it doesn't already exist in working directory)- this will be where the clean data for the 2021 ACS will be stored:
if (!dir.exists(here(clean_data_fp, "acs_data_21"))) {dir.create(here(clean_data_fp, "acs_data_21"))}
# file path for clean_data acs_data_21
acs_data_21_fp <- here(clean_data_fp, "acs_data_21")

# Clean 22 data
# Creates a new folder called "acs_data_22" (if it doesn't already exist in working directory)- this will be where the clean data for the 2022 ACS will be stored:
if (!dir.exists(here(clean_data_fp, 'acs_data_22'))) {dir.create(here(clean_data_fp, 'acs_data_22'))}
# file path for clean_data acs_data_22
acs_data_22_fp <- here(clean_data_fp, "acs_data_22")

# Clean ACS API data
# Creates a new folder called "acs_api" (if it doesn't already exist in working directory)- this will be where the clean data for API datawill be stored:
if (!dir.exists(here(clean_data_fp, 'acs_api'))) {dir.create(here(clean_data_fp, 'acs_api'))}
# file path for clean_data acs_data_22
acs_api_fp <- here(clean_data_fp, "acs_api")

### OUTPUTS filepaths ---- 
# output folder
# Creates a new folder called "output" (if it doesn't already exist in working directory)- this will be where the outputs from the R script will be stored:
if (!dir.exists(here('output'))) {dir.create(here('output'))}
# file path for clean_data acs_data_22
output_fp <- here("output")

# Creates a new folder called "acs_api" (if it doesn't already exist in working directory)- this will be where the individual tables for 
# the tabbed output from the R script will be stored as separate .csv's:
if (!dir.exists(here(output_fp, 'tables'))) {dir.create(here(output_fp, 'tables'))}
# file path for clean_data acs_data_22
tables_fp <- here(output_fp, 'tables')

```

## Load and Clean data from US Census American Community Survey (ACS) Public Use Microdata Sample (PUMS) File Transfer Protocol (FTP) site:

- Both 5 year estimates from 2017-2021 and 2018-2022 ACS data

### 2017-2021 ACS data from US Census ACS PUMS FTP- Load and Clean raw data:

```{r ACS 2021 FTP data}
# # Total list of vars to get from ACS PUMS
# vars_list_pums <- c("SERIALNO", "PUMA", "ST", "SPORDER", "RELSHIPP", "PWGTP", "WGTP", "SEX", "AGEP", "HHT", "HISP", 
#                     "RAC1P", "POVPIP", "NATIVITY", "DIS", "SCHL", "ESR", "JWMNP", "JWTRNS", "TEN","KIT", "PLM", "WAGP", "WKHP", 
#                     "ADJINC","HINCP", "VEH","RMSP", "NP", "GRPIP", "OCPIP", "POVPIP", "HICOV")
#        
# ### Housing level data raw:
# # Variables to pull out of raw housing data:
# housing_vars_list <- c("SERIALNO", "PUMA", "ST","WGTP", "HHT", "TEN", "KIT", "PLM", "ADJINC", "HINCP", "VEH", "RMSP", "NP", "GRPIP", "OCPIP")
# 
# # Read in the housing level data, select only vars from housing_vars_list, convert to tibble:
# housing_data <- fread(here(hh_2021_fp), select = housing_vars_list) %>% as_tibble()
# 
# ### Person level data raw:
# # Variables to pull out of raw housing data:
# person_vars_list <- c("SERIALNO", "ST", "PUMA", "SPORDER", "RELSHIPP", "PWGTP", "SEX", "AGEP", "HISP", "RAC1P", "ENG", "NATIVITY", 
#                       "DIS", "SCHL", "ESR", "JWMNP", "JWTRNS", "WAGP", "WKHP", "ADJINC", "POVPIP", "HICOV")
# # Set up type list for read_csv:
# 
# # Read in the person level data:
# person_data <- fread(here(person_2021_fp), select = person_vars_list) %>% as_tibble()
# 
# # # Merge the person level data and the housing level data- using the variable `SERIALNO`; left_join on person_data- to only keep data in person-level data:
# merged_data <- person_data %>% left_join(., housing_data, by = c("SERIALNO", "ST", "PUMA", "ADJINC"))
# 
# # Write out to .csv for the raw data from ACS Data call to folder named "clean_data/acs_data_21": 1826332 obs. with 33 variables
# # write_csv(merged_data, here(acs_data_21_fp, "merged_acs_data_scag.csv")) 
# 
# # SCAG County list- need to convert PUMA codes to county and then filter whole raw ACS PUMS data set to only these counties:
# scag_county_list <- c("Imperial", 
#                       "Los Angeles",
#                       "Orange",
#                       "Riverside",
#                       "San Bernardino", 
#                       "Ventura")
# 
# # Mutate/case_when to replicate SAS code above for creating "county" var- 
# # Create couny variable with SCAG counties and filter to only those rows in SCAG Counties using scag_county_list from above:
# merged_data_scag <- merged_data %>% mutate(county = case_when(PUMA == 2500 ~ "Imperial", # 25 prefix
#                                                               PUMA %in% (3701:3799) ~ "Los Angeles", # 37 prefix
#                                                               PUMA %in% (5901:5999) ~ "Orange", # 59 prefix
#                                                               PUMA %in% (6501:6599) ~ "Riverside", # 65 prefix
#                                                               PUMA %in% (7101:7199) ~ "San Bernardino", # 71 prefix
#                                                               PUMA %in% (11101:11199) ~ "Ventura" # 111 prefix
#                                                               )) %>% 
#                                           filter(county %in% scag_county_list) %>% 
#                                           select(SERIALNO, ST,PUMA,county, everything()) 
# 
# # Write out to .csv for the raw data from ACS Data call to folder named "clean_data/acs_data_21": 879241 obs. (same as API call) with 34 variables
# # write_csv(merged_data_scag, here(acs_data_21_fp, "merged_acs_data_scag.csv"))
# 
# # # check variables from the merged_data using str() and summary():
# # str(merged_data)
# # 
# # Remove all large files if no longer needed:
# # rm(housing_data, person_data, merged_data_scag, merged_data)

```

### 2018-2022 ACS data from US Census ACS PUMS FTP- Load and Clean raw data:

```{r ACS 2022 FTP data}
# # Total list of vars to get from ACS PUMS 22- change from 21 is PUMA is in 2010 and 2020 census columns: "PUMA10" and "PUMA20"
# vars_list_pums_22 <- c("SERIALNO", "PUMA10", "PUMA20", "ST", "SPORDER", "RELSHIPP", "PWGTP", "WGTP", "SEX", "AGEP", "HHT", "HISP", 
#                     "RAC1P", "POVPIP", "NATIVITY", "DIS", "SCHL", "ESR", "JWMNP", "JWTRNS", "TEN","KIT", "PLM", "WAGP", "WKHP", 
#                     "ADJINC","HINCP", "VEH","RMSP", "NP", "GRPIP", "OCPIP", "POVPIP", "HICOV")
#        
# ### Housing level data raw:
# # Variables to pull out of raw housing data:
# housing_vars_list_22 <- c("SERIALNO", "PUMA10", "PUMA20", "ST","WGTP", "HHT", "TEN", "KIT", "PLM", "ADJINC", "HINCP", "VEH", "RMSP", "NP", "GRPIP", "OCPIP")
# 
# # Read in the housing level data, select only vars from housing_vars_list, convert to tibble:
# housing_data_22 <- fread(here(hh_2022_fp), select = housing_vars_list_22) %>% as_tibble()
# 
# ### Person level data raw:
# # Variables to pull out of raw housing data:
# person_vars_list_22 <- c("SERIALNO", "ST", "PUMA10", "PUMA20", "SPORDER", "RELSHIPP", "PWGTP", "SEX", "AGEP", "HISP", "RAC1P", "ENG", 
#                       "NATIVITY", "DIS", "SCHL", "ESR", "JWMNP", "JWTRNS", "WAGP", "WKHP", "ADJINC", "POVPIP", "HICOV")
# # Set up type list for read_csv:
# 
# # Read in the person level data:
# person_data_22 <- fread(here(person_2022_fp), select = person_vars_list_22) %>% as_tibble()
# 
# # # Merge the person level data and the housing level data- using the variable `SERIALNO`; left_join on person_data- to only keep data in person-level data:
# merged_data_22 <- person_data_22 %>% left_join(., housing_data_22, by = c("SERIALNO", "ST", "PUMA10", "PUMA20", "ADJINC"))
# 
# # Create single PUMA code that merges the columns "PUMA10" and "PUMA20", use PUMA10 and if -9 then take in PUMA20 to replace:
# merged_data_22 <- merged_data_22 %>% mutate(PUMA = case_when(PUMA10 == -9 ~ PUMA20,
#                                                                      TRUE ~ PUMA10)) 
# 
# # Write out to .csv for the raw data from ACS Data call to folder named "clean_data/acs_data_22": 1826332 obs. with 31 variables
# # write_csv(merged_data_22, here(acs_data_22_fp, "merged_acs_22.csv")) 
# 
# # SCAG County list- need to convert PUMA codes to county and then filter whole raw ACS PUMS data set to only these counties:
# scag_county_list <- c("Imperial", 
#                       "Los Angeles",
#                       "Orange",
#                       "Riverside",
#                       "San Bernardino", 
#                       "Ventura")
# 
# # Mutate/case_when to replicate SAS code above for creating "county" var- 
# # Create couny variable with SCAG counties and filter to only those rows in SCAG Counties using scag_county_list from above:
# merged_data_22_scag <- merged_data_22 %>% mutate(county = case_when(PUMA == 2500 ~ "Imperial", # 25 prefix
#                                                                     PUMA %in% (3701:3799) ~ "Los Angeles", # 37 prefix
#                                                                     PUMA %in% (5901:5999) ~ "Orange", # 59 prefix
#                                                                     PUMA %in% (6501:6599) ~ "Riverside", # 65 prefix
#                                                                     PUMA %in% (7101:7199) ~ "San Bernardino", # 71 prefix
#                                                                     PUMA %in% (11101:11199) ~ "Ventura" # 111 prefix
#                                                                     )) %>% 
#                                           filter(county %in% scag_county_list) %>% 
#                                           select(SERIALNO, ST,PUMA,county, everything()) 
# 
# # Write out to .csv for the raw data from ACS Data call to folder named "clean_data/acs_data_22":  881207 obs.  with 34 variables
# # write_csv(merged_data_22_scag, here(acs_data_22_fp, "merged_acs_22_scag.csv")) 
# 
# # Read in merged_data_22_scag from  here(acs_data_22_fp, "merged_acs_22_scag.csv")
# # merged_data_22_scag <- read_csv(here(acs_data_22_fp, "merged_acs_22_scag.csv")) 
# 
# # # check variables from the merged_data_22 using str() and summary():
# # str(merged_data_22)
# # 
# # Remove all large files if no longer needed:
# rm(housing_data_22, person_data_22, merged_data_22_scag, merged_data_22)
# 
```


--- 

## API Calls using tidycensus package:
<!-- TODO: Fix API calls to US Census using tidycensus -->
### CA ACS PUMS Data from 2017-2021- 5 year ACS- Census API Call: 

```{r tidycensus CA data 2021}
# pums_vars_acs5_22 <- pums_variables %>% filter(year == 2022, survey == "acs5")
# # List of vars to get from ACS PUMS 
# vars_list_pums <- c("PUMA","RELSHIPP","SEX", "AGEP", "HHT", "HISP", "RAC1P", "ENG", "NATIVITY", "DIS", "SCHL", "ESR", "JWMNP", "JWTRNS",  
#                     "TEN", "KIT", "PLM", "WAGP", "WKHP", "ADJINC", "HINCP", "VEH", 
#                     "RMSP", "NP", "GRPIP", "OCPIP", "POVPIP", "HICOV")
# # Return tibble of var_code and var_label for vars_list_pums, arrange by order of vars_list_pums: 
# pums_data_desc <- pums_vars_acs5 %>%  
#             distinct(var_code, var_label, data_type, level) %>%  
#             filter(var_code %in% vars_list_pums) %>% 
#             mutate(var_code =  factor(var_code, levels = vars_list_pums)) %>% 
#             arrange(var_code)
# # List of vars and labels: 
# #   var_code  var_label                                                                                                                                   data_type   level   
# #    <fct>    <chr>                                                                                                                                         <chr>     <chr>   
# #  1 PUMA     Public use microdata area code (PUMA) based on 2010 Census definition (areas with population of 100,000 or more, use with ST for unique code) chr       NA      
# #  2 RELSHIPP Relationship to reference person                                                                                                              chr       person  
# #  3 SEX      Sex                                                                                                                                           chr       person  
# #  4 AGEP     Age                                                                                                                                           num       person  
# #  5 HHT      Household/family type                                                                                                                         chr       housing 
# #  6 HISP     Recoded detailed Hispanic origin                                                                                                              chr       person  
# #  7 RAC1P    Recoded detailed race code                                                                                                                    chr       person  
# #  8 ENG      Ability to speak English                                                                                                                      chr       person  
# #  9 NATIVITY Nativity                                                                                                                                      chr       person  
# # 10 DIS      Disability recode                                                                                                                             chr       person  
# # 11 SCHL     Educational attainment                                                                                                                        chr       person  
# # 12 ESR      Employment status recode                                                                                                                      chr       person  
# # 13 JWMNP    Travel time to work                                                                                                                           num       person  
# # 14 JWTRNS   Means of transportation to work                                                                                                               chr       person  
# # 15 TEN      Tenure                                                                                                                                        chr       housing 
# # 16 KIT      Complete kitchen facilities                                                                                                                   chr       housing 
# # 17 PLM      Complete plumbing facilities                                                                                                                  chr       housing 
# # 18 WAGP     Wages or salary income past 12 months (use ADJINC to adjust WAGP to constant dollars)                                                         num       person  
# # 19 WKHP     Usual hours worked per week past 12 months                                                                                                    num       person  
# # 20 ADJINC   Adjustment factor for income and earnings dollar amounts (6 implied decimal places)                                                           chr       housing 
# # 21 HINCP    Household income (past 12 months, use ADJINC to adjust HINCP to constant dollars)                                                             num       housing 
# # 22 VEH      Vehicles (1 ton or less) available                                                                                                            chr       housing 
# # 23 RMSP     Number of rooms                                                                                                                               num       housing 
# # 24 NP       Number of persons associated with this housing record                                                                                         num       housing 
# # 25 GRPIP    Gross rent as a percentage of household income past 12 months                                                                                 num       housing 
# # 26 OCPIP    Selected monthly owner costs as a percentage of household income during the past 12 months                                                    num       housing 
# # 27 POVPIP   Income-to-poverty ratio recode                                                                                                                num       person 
# # Vector of PUMA codes to get from CA- ACS PUMS API Call below: 
# puma_codes_scag <- c("02500", "03701", "03702", "03703", "03704", "03705", "03706", "03707", "03708", "03709", "03710", "03711", "03712", "03713",  
#                      "03714", "03715", "03716", "03717", "03718", "03719", "03720", "03721", "03722", "03723", "03724", "03725", "03726", "03727",  
#                      "03728", "03729", "03730", "03731", "03732", "03733", "03734", "03735", "03736", "03737", "03738", "03739", "03740", "03741",  
#                      "03742", "03743", "03744", "03745", "03746", "03747", "03748", "03749", "03750", "03751", "03752", "03753", "03754", "03755",  
#                      "03756", "03757", "03758", "03759", "03760", "03761", "03762", "03763", "03764", "03765", "03766", "03767", "03768", "03769",  
#                      "05901", "05902", "05903", "05904", "05905", "05906", "05907", "05908", "05909", "05910", "05911", "05912", "05913", "05914",  
#                      "05915", "05916", "05917", "05918", "06501", "06502", "06503", "06504", "06505", "06506", "06507", "06508", "06509", "06510",  
#                      "06511", "06512","06513", "06514", "06515", "07101", "07102", "07103", "07104", "07105", "07106", "07107", "07108", "07109",  
#                      "07110", "07111", "07112", "07113", "07114", "07115", "11101", "11102", "11103", "11104", "11105", "11106")
# ### 
# # Run API call to get all California ACS PUMS data from 2017-2021- 5 year ACS: CA FIPS is 06- took about 8 minutes to download API call. 
# ca_pums <- get_pums( 
#   variables = vars_list_pums, 
#   state = "CA", # California 
#   puma = puma_codes_scag, 
#   survey = "acs5", # acs5 is the 5 year ACS PUMS 
#   year = 2021, # Gets 2017-2021 ACS PUMS if acs5 set in survey option. 
#   recode = TRUE, # recode variable values using Census data dictionary and creates a new *_label column for each variable that is recoded. 
#   show_call  = TRUE # If TRUE, display call made to Census API. 
# )
# # API CALL: Census API call: https://api.census.gov/data/2021/acs/acs5/pums?get=SERIALNO%2CSPORDER%2CWGTP%2CPWGTP%2CPUMA%2CRELSHIPP%2CSEX%2CAGEP%2CHHT%2CHISP%2CRAC1P%2CENG%2CNATIVITY%2CDIS%2CSCHL%2CESR%NP%2CJWTRNS%2CTEN%2CKIT%2CPLM%2CWAGP%2CWKHP%2CADJINC%2CVEH%2CRMSP%2CNP%2CGRPIP%2COCPIP%2CPOVPIP&ucgid=0400000US06
# # Write out to .csv for the raw data from API call to folder named "clean_data": 1826332 obs. with 49 variables 
# # write_csv(ca_pums, here(acs_api_fp, "ca_pums_raw.csv"))
# ###  
# #Read in saved API call data: 
# ca_pums <- read_csv(here(acs_api_fp, "ca_pums_raw.csv"))
# # Set cols to numeric that ended up as characters, change order of vars: 
# ca_pums <- ca_pums %>% mutate(across(PUMA:RAC1P, ~ as.numeric(.))) %>%  
#     relocate(c("PUMA", "ST", "SPORDER", "SEX", "AGEP","HHT", "HISP","RAC1P", "ENG", "NATIVITY", "DIS", "SCHL","ESR"), .after = SERIALNO)
# # Filter data to only PUMAs that we need for SCAG Region:  
# # *------ PUMA 2010 -----------------------------------; 
# # if 		  puma  =2500 then county=25; *Imperial; 
# # if 3701<= puma <=3799 then county=37; *Los Angeles; 
# # if 5901<= puma <=5999 then county=59; *Orange; 
# # if 6501<= puma <=6599 then county=65; *Riverside ; 
# # if 7101<= puma <=7199 then county=71; *San Bernardino; 
# # if 11101<= puma <=11199 then county=111; *Ventura;
# # SCAG County list- need to conver PUMA codes to county and then filter whole raw ACS PUMS data set to only these counties: 
# scag_county_list <- c("Imperial",  
#                       "Los Angeles", 
#                       "Orange", 
#                       "Riverside", 
#                       "San Bernardino",  
#                       "Ventura") 
# # Mutate/case_when to replicate SAS code above for creating "county" var-  
# # Create county variable with SCAG counties and filter to only those rows in SCAG Counties using scag_county_list from above: 
# ca_pums_scag <- ca_pums %>% mutate(county = case_when(PUMA == 2500 ~ "Imperial", # 25 prefix 
#                                       PUMA >= 3701 & PUMA <= 3799 ~ "Los Angeles", # 37 prefix 
#                                       PUMA >= 5901 & PUMA <= 5999 ~ "Orange", # 59 prefix 
#                                       PUMA >= 6501 & PUMA <= 6599 ~ "Riverside", # 65 prefix 
#                                       PUMA >= 7101 & PUMA <= 7199 ~ "San Bernardino", # 71 prefix 
#                                       PUMA >= 11101 & PUMA <= 11199 ~ "Ventura" # 111 prefix 
#                                                     )) %>%  
#                             filter(county %in% scag_county_list) %>% relocate("county", .after = ST) 
# # Write out data filtered to only SCAG counties to folder named "clean_data": 879241 obs. with 49 variables 
# # write_csv(ca_pums_scag, here(acs_api_fp, "ca_pums_scag.csv"))
# # # Read in SCAG county data from ca_pums_scag.csv: 
# ca_pums_scag <- read_csv(here(acs_api_fp, "ca_pums_scag.csv")) 
# #  
# # # Set a list of names of the columns from API call: 
# # vars_ca_pums_scag <- names(ca_pums_scag)
# # Remove all large datasets, leave ca_pums_scag 
# # rm(merged_data,merged_data_scag,housing_data,person_data,ca_pums) 
```


### CA ACS PUMS Data from 2018-2022- 5 year ACS- Census API Call:

```{r tidycensus CA data 2022} 
# # TODO: NEED TO UPDATE this section once census API is working again.  
# # List of vars to get from ACS PUMS 
# vars_list_pums_22 <- c("PUMA10", "PUMA20", "RELSHIPP","SEX", "AGEP", "HHT", "HISP", "RAC1P", "ENG", "NATIVITY", "DIS", "SCHL", "ESR", "JWMNP", "JWTRNS",  
#                     "TEN", "KIT", "PLM", "WAGP", "WKHP", "ADJINC", "HINCP", "VEH", 
#                     "RMSP", "NP", "GRPIP", "OCPIP", "POVPIP", "HICOV") 
# # Check that all vars from 21 are in 22 data: 
# # read in acs_data_dict_22 
# acs_data_dict_22 <- read_csv(file = "data_dicts_ACS_PUMS/acs_data_dict_22.csv") 
# needed_vars_acs_data_dict_22 <- acs_data_dict_22 %>% filter(name %in% vars_list_pums_22)
# # Return tibble of var_code and var_label for vars_list_pums, arrange by order of vars_list_pums: 
# # pums_data_desc <- pums_vars_acs5_22 %>%  
# #             distinct(var_code, var_label, data_type, level) %>%  
# #             filter(var_code %in% vars_list_pums) %>% 
# #             mutate(var_code =  factor(var_code, levels = vars_list_pums)) %>% 
# #             arrange(var_code)
# ###### 
# ###### List of vars and labels: 
# ######  
# #   var_code  var_label                                                                                                                                   data_type   level   
# #    <fct>    <chr>                                                                                                                                         <chr>     <chr>   
# #  1 PUMA     Public use microdata area code (PUMA) based on 2010 Census definition (areas with population of 100,000 or more, use with ST for unique code) chr       NA      
# #  2 RELSHIPP Relationship to reference person                                                                                                              chr       person  
# #  3 SEX      Sex                                                                                                                                           chr       person  
# #  4 AGEP     Age                                                                                                                                           num       person  
# #  5 HHT      Household/family type                                                                                                                         chr       housing 
# #  6 HISP     Recoded detailed Hispanic origin                                                                                                              chr       person  
# #  7 RAC1P    Recoded detailed race code                                                                                                                    chr       person  
# #  8 ENG      Ability to speak English                                                                                                                      chr       person  
# #  9 NATIVITY Nativity                                                                                                                                      chr       person  
# # 10 DIS      Disability recode                                                                                                                             chr       person  
# # 11 SCHL     Educational attainment                                                                                                                        chr       person  
# # 12 ESR      Employment status recode                                                                                                                      chr       person  
# # 13 JWMNP    Travel time to work                                                                                                                           num       person  
# # 14 JWTRNS   Means of transportation to work                                                                                                               chr       person  
# # 15 TEN      Tenure                                                                                                                                        chr       housing 
# # 16 KIT      Complete kitchen facilities                                                                                                                   chr       housing 
# # 17 PLM      Complete plumbing facilities                                                                                                                  chr       housing 
# # 18 WAGP     Wages or salary income past 12 months (use ADJINC to adjust WAGP to constant dollars)                                                         num       person  
# # 19 WKHP     Usual hours worked per week past 12 months                                                                                                    num       person  
# # 20 ADJINC   Adjustment factor for income and earnings dollar amounts (6 implied decimal places)                                                           chr       housing 
# # 21 HINCP    Household income (past 12 months, use ADJINC to adjust HINCP to constant dollars)                                                             num       housing 
# # 22 VEH      Vehicles (1 ton or less) available                                                                                                            chr       housing 
# # 23 RMSP     Number of rooms                                                                                                                               num       housing 
# # 24 NP       Number of persons associated with this housing record                                                                                         num       housing 
# # 25 GRPIP    Gross rent as a percentage of household income past 12 months                                                                                 num       housing 
# # 26 OCPIP    Selected monthly owner costs as a percentage of household income during the past 12 months                                                    num       housing 
# # 27 POVPIP   Income-to-poverty ratio recode                                                                                                                num       person 
# # Vector of PUMA codes to get from CA- ACS PUMS API Call below: 
# puma_codes_scag <- c("02500", "03701", "03702", "03703", "03704", "03705", "03706", "03707", "03708", "03709", "03710", "03711", "03712", "03713",  
#                      "03714", "03715", "03716", "03717", "03718", "03719", "03720", "03721", "03722", "03723", "03724", "03725", "03726", "03727",  
#                      "03728", "03729", "03730", "03731", "03732", "03733", "03734", "03735", "03736", "03737", "03738", "03739", "03740", "03741",  
#                      "03742", "03743", "03744", "03745", "03746", "03747", "03748", "03749", "03750", "03751", "03752", "03753", "03754", "03755",  
#                      "03756", "03757", "03758", "03759", "03760", "03761", "03762", "03763", "03764", "03765", "03766", "03767", "03768", "03769",  
#                      "05901", "05902", "05903", "05904", "05905", "05906", "05907", "05908", "05909", "05910", "05911", "05912", "05913", "05914",  
#                      "05915", "05916", "05917", "05918", "06501", "06502", "06503", "06504", "06505", "06506", "06507", "06508", "06509", "06510",  
#                      "06511", "06512","06513", "06514", "06515", "07101", "07102", "07103", "07104", "07105", "07106", "07107", "07108", "07109",  
#                      "07110", "07111", "07112", "07113", "07114", "07115", "11101", "11102", "11103", "11104", "11105", "11106")
# ### 
# # Run API call to get all California ACS PUMS data from 2018-2022- 5 year ACS: CA FIPS is 06- took about 8 minutes to download API call. 
# ca_pums_22 <- get_pums( 
#   variables = vars_list_pums_22, 
#   state = "CA", # California 
#   puma = puma_codes_scag, 
#   survey = "acs5", # acs5 is the 5 year ACS PUMS 
#   year = 2022, # Gets 2018-2022 ACS PUMS if acs5 set in survey option. 
#   recode = TRUE, # recode variable values using Census data dictionary and creates a new *_label column for each variable that is recoded. 
#   show_call  = TRUE # If TRUE, display call made to Census API. 
# )
# # API CALL: Census API call: https://api.census.gov/data/2021/acs/acs5/pums?get=SERIALNO%2CSPORDER%2CWGTP%2CPWGTP%2CPUMA%2CRELSHIPP%2CSEX%2CAGEP%2CHHT%2CHISP%2CRAC1P%2CENG%2CNATIVITY%2CDIS%2CSCHL%2CESR%NP%2CJWTRNS%2CTEN%2CKIT%2CPLM%2CWAGP%2CWKHP%2CADJINC%2CVEH%2CRMSP%2CNP%2CGRPIP%2COCPIP%2CPOVPIP&ucgid=0400000US06
# # Write out to .csv for the raw data from API call to folder named "clean_data": 1826332 obs. with 49 variables 
# # write_csv(ca_pums, here(acs_api_fp, "ca_pums_raw.csv"))
# ###  
# #Read in saved API call data: 
# # ca_pums <- read_csv(here(acs_api_fp, "ca_pums_raw.csv"))
# # Set cols to numeric that ended up as characters, change order of vars: 
# ca_pums <- ca_pums %>% mutate(across(PUMA:RAC1P, ~ as.numeric(.))) %>%  
#     relocate(c("PUMA", "ST", "SPORDER", "SEX", "AGEP","HHT", "HISP","RAC1P", "ENG", "NATIVITY", "DIS", "SCHL","ESR"), .after = SERIALNO)
# # Filter data to only PUMAs that we need for SCAG Region:  
# # *------ PUMA 2010 -----------------------------------; 
# # if 		  puma  =2500 then county=25; *Imperial; 
# # if 3701<= puma <=3799 then county=37; *Los Angeles; 
# # if 5901<= puma <=5999 then county=59; *Orange; 
# # if 6501<= puma <=6599 then county=65; *Riverside ; 
# # if 7101<= puma <=7199 then county=71; *San Bernardino; 
# # if 11101<= puma <=11199 then county=111; *Ventura;
# # SCAG County list- need to conver PUMA codes to county and then filter whole raw ACS PUMS data set to only these counties: 
# scag_county_list <- c("Imperial",  
#                       "Los Angeles", 
#                       "Orange", 
#                       "Riverside", 
#                       "San Bernardino",  
#                       "Ventura") 
# # Mutate/case_when to replicate SAS code above for creating "county" var-  
# # Create county variable with SCAG counties and filter to only those rows in SCAG Counties using scag_county_list from above: 
# ca_pums_scag <- ca_pums %>% mutate(county = case_when(PUMA == 2500 ~ "Imperial", # 25 prefix 
#                                       PUMA >= 3701 & PUMA <= 3799 ~ "Los Angeles", # 37 prefix 
#                                       PUMA >= 5901 & PUMA <= 5999 ~ "Orange", # 59 prefix 
#                                       PUMA >= 6501 & PUMA <= 6599 ~ "Riverside", # 65 prefix 
#                                       PUMA >= 7101 & PUMA <= 7199 ~ "San Bernardino", # 71 prefix 
#                                       PUMA >= 11101 & PUMA <= 11199 ~ "Ventura" # 111 prefix 
#                                                     )) %>%  
#                             filter(county %in% scag_county_list) %>% relocate("county", .after = ST) 
# # Write out data filtered to only SCAG counties to folder named "clean_data": 879241 obs. with 49 variables 
# # write_csv(ca_pums_scag, here(acs_api_fp, "ca_pums_scag.csv"))
# # # Read in SCAG county data from ca_pums_scag.csv: 
# # ca_pums_scag <- read_csv(here(acs_api_fp, "ca_pums_scag.csv")) 
# #  
# # # Set a list of names of the columns from API call: 
# # vars_ca_pums_scag <- names(ca_pums_scag)
# # Remove all large datasets, leave ca_pums_scag 
# # rm(merged_data,merged_data_scag,housing_data,person_data,ca_pums) 
``` 


--- 

## Data Recoding and Table Creation: 

### SCAG Data from ACS PUMS:
### Recoding variables for use in ACS PUMS Analysis: 
```{r read recode SCAG data}
# Read in SCAG county data from "ca_pums_scag.csv" aka the API CALL DATA:
# ca_pums_scag <- read_csv(here(acs_api_fp, "ca_pums_scag.csv"))

# Set a list of names of the columns from API call:
# vars_ca_pums_scag <- names(ca_pums_scag)

# Read in merged ACS data SCAG- aka the US Census FTP merged DATA:
ca_pums_scag <- read_csv(here(acs_data_21_fp, "merged_acs_data_scag.csv"))

# Code county as a factor variable:
ca_pums_scag <- ca_pums_scag %>% mutate(county = factor(county, levels = c("Imperial", "Los Angeles", "Orange", "Riverside", "San Bernardino", "Ventura")))

# Race and Ethnicity: named var "race" for brevity:
# SAS example-
# *------- 1. Race_Ethnicity -------------------------------------------------;
# 
# racespan=999; 
# if hisp ge 2 then racespan=1;             	*Hispanic ;
# if hisp=1 then do;
#    if RAC1P=1 then racespan=2;              *NH White;
#    if RAC1P=2 then racespan=3;              *NH Black;
#    if 6<= RAC1P <= 7 then racespan=4;       *NH Asian & PI;
#    if 3<= RAC1P <= 5 then racespan=5;       *NH Am Indian;
#    if RAC1P >= 8 then racespan=6;           *NH Other;
#    end;
# Create "race" var based on conditions above: 
ca_pums_scag <- ca_pums_scag %>% mutate(race = factor(case_when(HISP != 1  ~ "Hispanic/Latino",
                                                         HISP == 1 & RAC1P == 1 ~ "White", 
                                                         HISP == 1 & RAC1P == 2 ~ "Black", 
                                                         HISP == 1 & RAC1P %in% c(6,7) ~ "Asian/Pacific Islander", 
                                                         HISP == 1 & RAC1P %in% c(3:5) ~ "Native American", 
                                                         HISP == 1 & RAC1P %in% c(8,9) ~ "Multiracial/Other"
                                                         ), levels = c("Asian/Pacific Islander", "Black", "Hispanic/Latino", "Multiracial/Other", "Native American", "White"))
                                        ) 

###
# Homeownership: own
# SAS example- 
# *------- H3.Homeownership: Tenure  -------------;
# 
# *TEN Character 1
# Tenure
# b .N/A (GQ/vacant)
# 1 .Owned with mortgage or loan (include home equity loans)
# 2 .Owned free and clear
# 3 .Rented
# 4 .Occupied without payment of rent;
# 
# own=.;
# if TEN in (1 2) then own=1;
# if TEN in (3 4) then own=0;
# 
# Create "own_home" var based on conditions above: 
ca_pums_scag <- ca_pums_scag %>% mutate(own_home = factor(case_when(TEN == 1 | TEN == 2 ~ "Homeowner",
                                                             TEN == 3 | TEN == 4 ~ "Non-Homeowner"), levels = c("Homeowner", "Non-Homeowner"))
                                                          )

###
# Households without a vehicle : 
# SAS example-
# *------- H1.Percent of households without a vehicle  -------------;
# *
# VEH Character 1
# Vehicles (1 ton or less) available
# b .N/A (GQ/vacant)
# 0 .No vehicles
# 1 .1 vehicle
# 2 .2 vehicles
# 3 .3 vehicles
# 4 .4 vehicles
# 5 .5 vehicles
# 6 .6 or more vehicles
# ;
# Veh_zero=0;
# if VEH=0 then Veh_zero=1
#;
#
# VEH_label 
# "No vehicles"  "1 vehicle"  "2 vehicles"  "3 vehicles"  "4 vehicles"  "5 vehicles"  "6 or more vehicles" "N/A (GQ/vacant)"

# Means of transportation to work- code- Workers who Commute by Walk, Bike, or Public Transit: named var "walk_bike_public_transport":
# SAS example-
# *JWTRNS Character 2
# Means of transportation to work
# bb .N/A (not a worker-not in the labor force, including persons .under 16 years, unemployed, employed, with a job but not at .work, Armed Forces, with a job but not at work)
# 01 .Car, truck, or van
# 02 .Bus
# 03 .Subway or elevated rail
# 04 .Long-distance train or commuter rail
# 05 .Light rail, streetcar, or trolley
# 06 .Ferryboat
# 07 .Taxicab
# 08 .Motorcycle
# 09 .Bicycle
# 10 .Walked
# 11 .Worked from home
# 12 .Other method;
# 
# Commute=.;
# if JWTRNS=1 then Commute=1;*Private;
# if JWTRNS in (2 3 4 5 6 7) then Commute=2;*Public;
# if JWTRNS in (8 9 10 12) then Commute=3;*Other;
# 
# 
# Commute2=.;
# if JWTRNS in (1 8) then Commute2=1;*Private(car or motorcycle);
# if JWTRNS in (2 3 4 5 6 7) then Commute2=2;*Public(bus, rail, taxi or ferry);
# if JWTRNS in (9 10 12) then Commute2=3;*Other(bike, walk or other);
# Create "race" var based on conditions above: 
ca_pums_scag <- ca_pums_scag %>% mutate(walk_bike_public_transport = factor(case_when(JWTRNS %in% c(2:5,9,10)  ~ "Walk/Bike/Public",
                                                         TRUE ~ "Other Transport"), levels = c("Walk/Bike/Public","Other Transport"))
                                                         ) 
# Means of transportation to work- code- named var "all_transport"
#  Workers who Commute by bus, rail, taxi, or ferry: coded level "Public": JWTRNS %in% c(2:7)
#  Workers who Commute by Car or Motorcycle: coded level "Private": JWTRNS %in% c(1,8)
#  Workers who Commute by Walk, Bike, or Other: coded level "Other": JWTRNS %in% c(9,10,12)
# all_transport will be all forms of transportation if use not na like this: !is.na(all_transport)
ca_pums_scag <- ca_pums_scag %>% mutate(all_transport = factor(case_when(JWTRNS %in% c(1,8) ~ "Private",
                                                                  JWTRNS %in% c(2:7) ~  "Public",
                                                                  JWTRNS %in% c(9,10,12) ~ "Other"
                                                                 ), levels = c("Other", "Public","Private"))
                                        ) 
# SAS example-
# *------- P3.Average travel time to work (minutes)  -------------;
# 
# *JWMNP Numeric 3
# Travel time to work
# bbb .N/A (not a worker or worker who worked at home)
# 1..200 .1 to 200 minutes to get to work (Top-coded);


#SAS Example 
#*------- H8.Housing burden  -------------;
# *GRPIP Numeric 3
# Gross rent as a percentage of household income past 12 months
# bbb .N/A (GQ/vacant/owned or being bought/occupied without .rent payment/no household income)
# 1..100 .1% to 100%
# 101 .101% or more
# 
# OCPIP Numeric 3
# Selected monthly owner costs as a percentage of household income during the past 12 months
# bbb .N/A (GQ/vacant/not owned or being bought/no household .income)
# 1..100 .1% to 100%
# 101 .101% or more
# 
# POVPIP Numeric 3
# Income-to-poverty ratio recode
# bbb .N/A
# 0..500 .Below 501 percent
# 501 .501 percent or more;
# 
# Gross rent as a percentage of household income (Rent burden) 30% or more and 200 below percent poverty line and rent home:
# pRENTGT30_POV200=0;	
# if own=0 then do;
# 	if GRPIP>=30 and POVPIP<200 then pRENTGT30_POV200=1;
# end;
# 
# owner costs as a percentage of household income (housing cost burden) 30% or more and 200 below percent poverty line and rent home:
# pSMOCGT30_POV200=0;	
# if own=1 then do;
# 	if OCPIP>=30 and POVPIP<200 then pSMOCGT30_POV200=1;
# end;
# Housing and Rent burdens: variable for homeowner burden named: "housing_burden"; variable for homeowner burden named: "renter_burden"
ca_pums_scag <- ca_pums_scag %>% mutate(housing_burden = factor(case_when(POVPIP %in% c(0:199) & own_home == "Homeowner" & OCPIP >= 30 ~ "Yes",
                                                          TRUE ~ "No",), levels = c("Yes","No")),
                        renter_burden = factor(case_when(POVPIP %in% c(0:199) & own_home == "Non-Homeowner" & GRPIP >= 30 ~ "Yes",
                                                          TRUE ~ "No",), levels = c("Yes","No"))
                                                         ) 

# Poverty-
# Create a poverty indicator for the Poverty (REBCR Economy section) Table:
# If households lived below 200 percent of the poverty line or did not:
# pov=.;
# if 0<= POVPIP <200 then pov=1;
# if POVPIP>=200 then pov=2;
# If poverty == "Yes", the HH is below 200 percent of the poverty line:
ca_pums_scag <- ca_pums_scag %>% mutate(poverty = factor(case_when(POVPIP %in% c(0:199) ~ "Yes",
                                                                   POVPIP >= 200 ~ "No",), levels = c("Yes","No"))
                                                         )

# SAS EXAMPLE:
# *------- H6.Complete kitchen facilities  -------------;
# 
# *KIT Character 1
# Complete kitchen facilities
# b .N/A (GQ)
# 1 .Yes, has stove or range, refrigerator, and sink with a faucet
# 2 .No;
# 
# *PLM Character 1
# Complete plumbing facilities
# b .N/A (GQ)
# 1 .Yes, has hot and cold running water and a bathtub or shower .(includes flush toilet for data collected prior to 2016)
# 2 .No
# 9 .Case is from Puerto Rico, PLM recode not applicable;
# 
# Kit_Plm=1;
# if KIT=2 and PLM=2 then Kit_Plm=0; *No Kitchen and Plumbing;
# 
ca_pums_scag <- ca_pums_scag %>% mutate(no_kitchen_plumbing = factor(case_when(KIT == 2 & PLM == 2 ~ "Yes",
                                                                   KIT == 1 | PLM == 1 ~ "No",), levels = c("Yes","No"))
                                                         )


### 
# Overcrowding of households: defined as "severe overcrowding is measured as the percentage of householders that have more than 1.5 persons per room"
# named variable: "overcrowded" if "Yes", more than 1.5 people per room, "No" otherwise. 
# SAS Example:
# *RMSP Numeric 2
# Number of rooms
# bb .N/A (GQ)
# 0..99 .Rooms (Top-coded)
# 
# NP Numeric 2
# Number of persons associated with this housing record
# 0 .Vacant unit
# 1 .One person record (one person in household or any person .in group quarters)
# 2..20 .Number of person records (number of persons in household);
# 
# Overcrowd=.;
# *if RMSP>0 then do;
# 	Overcrowd=NP/RMSP;
# *end;
# 
# Overcrowding=.;
# if 0<=Overcrowd<=1 then Overcrowding=0;
# if 1<Overcrowd<1.5 then Overcrowding=1;
# if Overcrowd>=1.5 then Overcrowding=2;
# 
ca_pums_scag <- ca_pums_scag %>% mutate(crowd = case_when(RMSP > 0  ~ NP/RMSP,
                                                           TRUE ~ NA),
                                        overcrowded = factor(case_when(crowd >= 1.5  ~ "Yes",
                                                           crowd < 1.5 ~ "No"), levels = c("Yes","No"))
                                                         ) 
# Health insurance coverage
# *------- P4.Health Insurance  -------------;
# *HICOV Character 1
# Health insurance coverage recode
# 1 .With health insurance coverage
# 2 .No health insurance coverage;
# ca_pums_scag %>% select(HICOV) 

## Median Hourly wage: variable named "hourly_wage"
# if AGEP ge 25 and AGEP le 64;
# 
# if ESR in (1 2); *Civilian worker;
# 
# *WAGP Numeric 6
# Wages or salary income past 12 months (use ADJINC to adjust WAGP to constant dollars)
# bbbbbb .N/A (less than 15 years old)
# 0 .None
# 4..999999 .$4 to 999999 (Rounded and top-coded)
# 
# WKHP Numeric 2
# Usual hours worked per week past 12 months
# bb .N/A (less than 16 years old/did not work during the past .12 months)
# 1..98 .1 to 98 usual hours
# 99 .99 or more usual hours
# 
# ADJINC Character 7
# Adjustment factor for income and earnings dollar amounts (6 implied decimal places)
# 1117630 .2017 factor (1.011189 * 1.10526316)
# 1093093 .2018 factor (1.013097 * 1.07896160)
# 1070512 .2019 factor (1.010145 * 1.05976096)
# 1053131 .2020 factor (1.006149 * 1.04669465)
# 1029928 .2021 factor (1.029928 * 1.00000000)
# ;
# 
# wage=.;
# if ADJINC=1117630 then wage=WAGP*1.011189 * 1.10526316; 	*2017 Adjust Income ($2021);
# if ADJINC=1093093 then wage=WAGP*1.013097 * 1.07896160; 	*2018 Adjust Income ($2021);
# if ADJINC=1070512 then wage=WAGP*1.010145 * 1.05976096; 	*2019 Adjust Income ($2021);
# if ADJINC=1053131 then wage=WAGP*1.006149 * 1.04669465; 	*2020 Adjust Income ($2021);
# if ADJINC=1029928 then wage=WAGP*1.029928 * 1.00000000; 	*2021 Adjust Income ($2021);
# 
#  
# 
# wwage=wage/52; *1 week wage;
# 
# Hwage=0;
# if WKHP>0 then do;
# 	Hwage=wwage/WKHP; *Hourly Wage;
# end;

# First, adjust the wages with the Adjust Income for the right year for all civilian workers ages 25-64 who worked more than 0 hours per week;
# Second, get the weekly wages by dividing by 52, then divide by WKHP (usual hours worked per week)
# Finally: get hourly wage only in: 
# ca_pums_scag %>% mutate(hourly_wage = case_when(ESR %in% c(1:2) & AGEP %in% c(25:64) & WKHP > 0 & WAGP > 0 & ADJINC == 1117630 ~ WAGP * ADJINC/52/WKHP, # 2017 Adjust Income
#                                                 ESR %in% c(1:2) & AGEP %in% c(25:64) & WKHP > 0 & WAGP > 0 & ADJINC == 1093093 ~ WAGP * ADJINC/52/WKHP, # 2018 Adjust Income
#                                                 ESR %in% c(1:2) & AGEP %in% c(25:64) & WKHP > 0 & WAGP > 0 & ADJINC == 1070512 ~ WAGP * ADJINC/52/WKHP, # 2019 Adjust Income
#                                                 ESR %in% c(1:2) & AGEP %in% c(25:64) & WKHP > 0 & WAGP > 0 & ADJINC == 1053131 ~ WAGP * ADJINC/52/WKHP, # 2020 Adjust Income
#                                                 ESR %in% c(1:2) & AGEP %in% c(25:64) & WKHP > 0 & WAGP > 0 & ADJINC == 1029928 ~ WAGP * ADJINC/52/WKHP, # 2021 Adjust Income
#                                                )) 
ca_pums_scag <- ca_pums_scag %>% mutate(wage = case_when(ADJINC == 1117630 ~ WAGP * 1.011189 * 1.10526316, # 2017 Adjust Income
                                         ADJINC == 1093093 ~ WAGP * 1.013097 * 1.07896160, # 2018 Adjust Income
                                         ADJINC == 1070512 ~ WAGP * 1.010145 * 1.05976096, # 2019 Adjust Income
                                         ADJINC == 1053131 ~ WAGP * 1.006149 * 1.04669465, # 2020 Adjust Income
                                         ADJINC == 1029928 ~ WAGP * 1.029928 * 1.00000000, # 2021 Adjust Income
                                        ),
                        weekly_wage = wage/52,
                        hourly_wage = if_else(WKHP > 0,weekly_wage/WKHP, NA_real_)
                        ) 

# Unemployment -named variable "unemployed"- if "Yes", unemployed, "No" otherwise. 
# *------- 8. Employment status -------------------------------------;
# 
# *ESR Character 1
# Employment status recode
# b .N/A (less than 16 years old)
# 1 .Civilian employed, at work
# 2 .Civilian employed, with a job but not at work
# 3 .Unemployed
# 4 .Armed forces, at work
# 5 .Armed forces, with a job but not at work
# 6 .Not in labor force;
# 
# Unemployment -named variable "unemployed"- if "Yes", unemployed, "No" otherwise. 
ca_pums_scag <- ca_pums_scag %>% mutate(unemployed = factor(case_when(ESR == 3  ~ "Yes",
                                                           ESR != 3 ~ "No"), levels = c("Yes","No"))
                                                         )
```

### Analysis and Replication of Tables and Figures for SCAG

### Figure 5. Workers who Commute by Walk, Bike, or Public Transit by Race and Ethnicity

```{r fig 5}
### 
# Figure 5. Workers who Commute by Walk, Bike, or Public Transit by Race and Ethnicity:
# Use person level weights- PWGTP:
# walk_bike_public_transport ==  "Walk/Bike/Public"
# Get percentages based on non-home workers- drop all if JWTRNS respond == 11 (use filter not equal to 11 like this (filter(JWTRNS != 11)))
# Get Walk/Bike/Public percentages by race for all SCAG non-home workers:
scag_race_walk_bike_public <- ca_pums_scag %>% filter(JWTRNS != 11) %>% select(PWGTP, race, walk_bike_public_transport) %>%  
                                         group_by(race) %>% 
                                         summarize(
                                           total_pop = sum(PWGTP),
                                           walk_bike_public = sum(PWGTP[walk_bike_public_transport == "Walk/Bike/Public"]),  
                                           walk_bike_public_prop = walk_bike_public / total_pop, # divide by total_pop for proportion
                                           walk_bike_public_perc = round(walk_bike_public_prop*100, 2)
                                         ) %>% mutate(county = "SCAG") %>% select(county, race, walk_bike_public_perc) %>% 
                                         pivot_wider(names_from = race, values_from = walk_bike_public_perc) # make into wide table to match excel file table.

# Get Walk/Bike/Public percentages by race for all by race and by county for non-home workers:
scag_county_race_walk_bike_public <- ca_pums_scag %>% filter(JWTRNS != 11) %>% select(PWGTP, county, race, walk_bike_public_transport) %>%  
                                         group_by(county, race) %>% 
                                         summarize(
                                           total_pop = sum(PWGTP),
                                           walk_bike_public = sum(PWGTP[walk_bike_public_transport == "Walk/Bike/Public"]),  
                                           walk_bike_public_prop = walk_bike_public / total_pop, # divide by total_pop for proportion
                                           walk_bike_public_perc = round(walk_bike_public_prop*100, 2)
                                         ) %>% select(county, race, walk_bike_public_perc) %>% 
                                         pivot_wider(names_from = race, values_from = walk_bike_public_perc)

# Get no_veh percentages by county for all SCAG:
scag_county_total_walk_bike_public <- ca_pums_scag %>% filter(JWTRNS != 11) %>% 
                                         select(PWGTP, county, walk_bike_public_transport)  %>%  
                                         group_by(county) %>% 
                                         summarize(
                                           total_pop = sum(PWGTP),
                                           walk_bike_public = sum(PWGTP[walk_bike_public_transport == "Walk/Bike/Public"]),  
                                           walk_bike_public_prop = walk_bike_public / total_pop, # divide by total_pop for proportion
                                           walk_bike_public_perc = round(walk_bike_public_prop*100, 2)
                                         ) %>% select(county, walk_bike_public_perc) %>% rename(Total = walk_bike_public_perc) 
# Get no_veh percentages for all SCAG:
scag_total_walk_bike_public <- ca_pums_scag %>% filter(JWTRNS != 11) %>% select(PWGTP, walk_bike_public_transport) %>%  
                                         summarize(
                                           total_pop = sum(PWGTP),
                                           walk_bike_public = sum(PWGTP[walk_bike_public_transport == "Walk/Bike/Public"]),  
                                           walk_bike_public_prop = walk_bike_public / total_pop, # divide by total_pop for proportion
                                           walk_bike_public_perc = round(walk_bike_public_prop*100, 2)
                                         ) %>% mutate(county = "SCAG") %>% select(county, walk_bike_public_perc) %>% rename(Total = walk_bike_public_perc)

# Full join all scag_total tables:
scag_total_walk_bike_public_table <- full_join(scag_county_total_walk_bike_public,scag_total_walk_bike_public)

# Full join all scag_race tables, then left join scag_total_no_veh_table by county:
scag_walk_bike_public_table <- full_join(scag_county_race_walk_bike_public,scag_race_walk_bike_public) %>% left_join(.,scag_total_walk_bike_public_table, by = join_by(county))
scag_walk_bike_public_table

# Write out table to .csv in "output/tables" folder and once the file exists remove from current environment all tibbles used to make the final table:
write_csv(scag_walk_bike_public_table, here(tables_fp, "scag_walk_bike_public_table.csv"))
if (file.exists(here(tables_fp, 'scag_walk_bike_public_table.csv'))) {rm(list = ls(pattern = "walk_bike_public"))}

```

### Figure 6. Householders without a Vehicle by Race and Ethnicity

```{r fig 6}
### 
# Figure 6. Householders without a Vehicle by Race and Ethnicity:
# Filter to only housing data(RELSHIPP == 20) and Use household weights- WGTP:
# sum over VEH == 0
# 
# Get no_veh percentages by race for all SCAG:
scag_race_no_veh <- ca_pums_scag %>% filter(RELSHIPP == 20) %>% select(WGTP, race,VEH) %>%  
                                         group_by(race) %>% 
                                         summarize(
                                           total_pop = sum(WGTP),
                                           no_veh = sum(WGTP[VEH == 0]),  
                                           no_veh_prop = no_veh / total_pop, # divide by total_pop for proportion
                                           no_veh_perc = round(no_veh_prop*100, 2)
                                         ) %>% mutate(county = "SCAG") %>% select(county, race, no_veh_perc) %>% 
                                         pivot_wider(names_from = race, values_from = no_veh_perc) # make into wide table to match excel file table.

# Get no_veh percentages by race and by county:
scag_county_race_no_veh <- ca_pums_scag %>% filter(RELSHIPP == 20) %>% select(WGTP, county, race, VEH) %>%  
                                         group_by(county, race) %>% 
                                         summarize(
                                           total_pop = sum(WGTP),
                                           no_veh = sum(WGTP[VEH == 0]), 
                                           no_veh_prop = no_veh / total_pop, # divide by total_pop for proportion
                                           no_veh_perc = round(no_veh_prop*100, 2)
                                         ) %>% select(county, race, no_veh_perc) %>% 
                                         pivot_wider(names_from = race, values_from = no_veh_perc)
# Get no_veh percentages by county for all SCAG:
scag_county_total_no_veh <- ca_pums_scag %>% filter(RELSHIPP == 20) %>% select(WGTP, county, VEH) %>%  
                                         group_by(county) %>% 
                                         summarize(
                                           total_pop = sum(WGTP),
                                           no_veh = sum(WGTP[VEH == 0]),
                                           no_veh_prop = no_veh / total_pop, # divide by total_pop for proportion
                                           no_veh_perc = round(no_veh_prop*100, 2)
                                         ) %>% select(county, no_veh_perc) %>% rename(Total = no_veh_perc) 
# Get no_veh percentages for all SCAG:
scag_total_no_veh <- ca_pums_scag %>% filter(RELSHIPP == 20) %>% select(WGTP, VEH) %>%  
                                         summarize(
                                           total_pop = sum(WGTP),
                                           no_veh = sum(WGTP[VEH == 0]), 
                                           no_veh_prop = no_veh / total_pop, # divide by total_pop for proportion
                                           no_veh_perc = round(no_veh_prop*100, 2)
                                         ) %>% mutate(county = "SCAG") %>% select(county, no_veh_perc) %>% rename(Total = no_veh_perc)

# Full join all scag_total tables:
scag_total_no_veh_table <- full_join(scag_county_total_no_veh,scag_total_no_veh)

# Full join all scag_race tables, then left join scag_total_no_veh_table by county:
scag_no_veh_table <- full_join(scag_county_race_no_veh,scag_race_no_veh) %>% left_join(.,scag_total_no_veh_table, by = join_by(county))
scag_no_veh_table

# Write out table to .csv in "output/tables" folder and once the file exists remove from current environment all tibbles used to make the final table:
write_csv(scag_no_veh_table, here(tables_fp, "scag_no_veh_table.csv"))
if (file.exists(here(tables_fp, 'scag_no_veh_table.csv'))) {rm(list = ls(pattern = "no_veh"))}

```

### Figure 7. Workers’ Commute Times (Minutes) by Mode and Race and Ethnicity

```{r fig 7}
# Figure 7. Figure 7. Workers’ Commute Times (Minutes) by Mode and Race and Ethnicity:
# Use person level weights- PWGTP:
# Grouped by all_transport and race
# Get weighted means based on non-home workers- drop all if JWTRNS respond == 11 (use filter not equal to 11 like this (filter(JWTRNS != 11)))
# Get all_transport means by race for all SCAG non-home workers:
scag_race_transport_mean <- ca_pums_scag %>% select(PWGTP, race, all_transport, JWMNP) %>% drop_na() %>% 
                                         group_by(race, all_transport) %>%
                                         summarize(
                                           mean_transit = weighted.mean(JWMNP, PWGTP, na.rm = TRUE) # weighted mean 
                                         ) %>% mutate(county = "SCAG") %>% relocate(county) %>% 
                                         pivot_wider(names_from = all_transport, values_from = mean_transit) # make into wide table to match excel file table.
# Get all_transport means for all SCAG non-home workers- Any Transport:
scag_race_any_transport_mean <- ca_pums_scag %>% filter(JWTRNS != 11) %>%  select(PWGTP, race, all_transport, JWMNP) %>% 
                                         group_by(race) %>%
                                         summarize(
                                           `Any Transportation` = weighted.mean(JWMNP, PWGTP, na.rm = TRUE) # weighted mean 
                                         ) %>% mutate(county = "SCAG") %>% select(county, race, `Any Transportation`)
# Left Join scag_transport_mean and scag_any_transport_mean
scag_race_transport_mean <- left_join(scag_race_transport_mean, scag_race_any_transport_mean)

# Get all_transport means for all SCAG non-home workers:
scag_transport_mean <- ca_pums_scag %>% filter(JWTRNS != 11) %>%  select(PWGTP, all_transport, JWMNP) %>% 
                                         group_by(all_transport) %>%
                                         summarize(
                                           mean_transit = weighted.mean(JWMNP, PWGTP, na.rm = TRUE) # weighted mean 
                                         ) %>% mutate(county = "SCAG", race = "SCAG Region") %>% relocate(county) %>% 
                                         pivot_wider(names_from = all_transport, values_from = mean_transit) # make into wide table to match excel file table.
# Get all_transport means for all SCAG non-home workers- Any Transport:
scag_any_transport_mean <- ca_pums_scag %>% filter(JWTRNS != 11) %>%  select(PWGTP, all_transport, JWMNP) %>% 
                                         summarize(
                                           `Any Transportation` = weighted.mean(JWMNP, PWGTP, na.rm = TRUE) # weighted mean 
                                         ) %>% mutate(county = "SCAG", race = "SCAG Region") %>% select(county, race, `Any Transportation`)
# Left Join scag_transport_mean and scag_any_transport_mean
scag_transport_mean_totals <- left_join(scag_transport_mean, scag_any_transport_mean)
# Full join scag_race_transport_mean and cag_transport_mean_overall to get full totals table for SCAG and by race:
scag_transport_mean <- scag_race_transport_mean %>% full_join(scag_transport_mean_totals)

###########
# Next, do the same as above by broken down by county and join the full county table to scag_race_transport_mean
# By county
# Get all_transport means by race for all SCAG non-home workers:
scag_race_county_transport_mean <- ca_pums_scag %>% select(PWGTP, race, county, all_transport, JWMNP) %>% drop_na() %>% 
                                         group_by(race, county, all_transport) %>%
                                         summarize(
                                           mean_transit = weighted.mean(JWMNP, PWGTP, na.rm = TRUE) # weighted mean 
                                         ) %>% relocate(county)  %>% 
                                         pivot_wider(names_from = all_transport, values_from = mean_transit) %>% # make into wide table to match excel file table.
                                         mutate(Public = replace_na(Public,0)) # Replace NA with 0.

# Get all_transport means for all SCAG non-home workers- Any Transport:
scag_race_county_any_transport_mean <- ca_pums_scag %>% filter(JWTRNS != 11) %>%  select(PWGTP, county, race, all_transport, JWMNP) %>% 
                                         group_by(race, county) %>%
                                         summarize(
                                           `Any Transportation` = weighted.mean(JWMNP, PWGTP, na.rm = TRUE) # weighted mean 
                                         ) %>% select(county, race, `Any Transportation`)
# Left Join scag_transport_mean and scag_any_transport_mean
scag_race_county_transport_mean <- left_join(scag_race_county_transport_mean, scag_race_county_any_transport_mean)


# Full join scag_race_transport_mean and cag_transport_mean_overall to get full totals table for SCAG and by race:
scag_transport_mean_table <- scag_transport_mean %>% full_join(scag_race_county_transport_mean) %>% ungroup()
# Round all means to 2 digits:
scag_transport_mean_table <- scag_transport_mean_table %>% mutate(across(where(is.numeric), round, 2))
scag_transport_mean_table

# Write out table to .csv in "output/tables" folder and once the file exists remove from current environment all tibbles used to make the final table:
write_csv(scag_transport_mean_table, here(tables_fp, "scag_transport_mean_table.csv"))
if (file.exists(here(tables_fp, 'scag_transport_mean_table.csv'))) {rm(list = ls(pattern = "transport_mean"))}

```

### Figure 19. Renters and Homeowners Experiencing Housing Cost Burden by Race and Ethnicity 

```{r fig_19}
# Figure 19. Renters and Homeowners Experiencing Housing Cost Burden by Race and Ethnicity 
# Filter to only housing data and renters (filter(RELSHIPP == 20, own_home == "Non-Homeowner")) and Use household weights- WGTP, sum if renter_burden == "Yes":
# Get renter burden percentages by race for all SCAG:
scag_race_renter_burden <- ca_pums_scag %>% filter(RELSHIPP == 20, own_home == "Non-Homeowner") %>% select(WGTP, race, renter_burden) %>%  
                                         group_by(race) %>% 
                                         summarize(
                                           total_pop = sum(WGTP),
                                           renter = sum(WGTP[renter_burden == "Yes"]), # sum up only those that own homes.
                                           renter_prop = renter / total_pop, # divide by total_pop for proportion
                                           renter_perc = round(renter_prop*100, 2)
                                         ) %>% mutate(county = "SCAG") %>% select(county, race, renter_perc) %>% 
                                         pivot_wider(names_from = race, values_from = renter_perc) # make into wide table to match excel file table.

# Get renter burden percentages by race and by county:
scag_county_race_renter_burden <- ca_pums_scag %>% filter(RELSHIPP == 20, own_home == "Non-Homeowner") %>% select(WGTP, race, county, renter_burden) %>%  
                                         group_by(county, race) %>% 
                                         summarize(
                                           total_pop = sum(WGTP),
                                           renter = sum(WGTP[renter_burden == "Yes"]), # sum up only those that own homes.
                                           renter_prop = renter / total_pop, # divide by total_pop for proportion
                                           renter_perc = round(renter_prop*100, 2)
                                         ) %>% select(county, race, renter_perc) %>% 
                                         pivot_wider(names_from = race, values_from = renter_perc)

# Get renter burden percentages  by county for all SCAG:
scag_county_total_renter_burden <- ca_pums_scag %>% filter(RELSHIPP == 20, own_home == "Non-Homeowner") %>% select(WGTP, race, county, renter_burden) %>%  
                                         group_by(county) %>% 
                                         summarize(
                                           total_pop = sum(WGTP),
                                           renter = sum(WGTP[renter_burden == "Yes"]), # sum up only those that own homes.
                                           renter_prop = renter / total_pop, # divide by total_pop for proportion
                                           renter_perc = round(renter_prop*100, 2)
                                         ) %>% select(county, renter_perc) %>% rename(Total = renter_perc) 
# Get renter burden percentages for all SCAG:
scag_total_renter_burden <- ca_pums_scag %>% filter(RELSHIPP == 20, own_home == "Non-Homeowner") %>% select(WGTP, race, county, renter_burden) %>%  
                                         summarize(
                                           total_pop = sum(WGTP),
                                           renter = sum(WGTP[renter_burden == "Yes"]), # sum up only those that own homes.
                                           renter_prop = renter / total_pop, # divide by total_pop for proportion
                                           renter_perc = round(renter_prop*100, 2)
                                         ) %>% mutate(county = "SCAG") %>% select(county, renter_perc) %>% rename(Total = renter_perc)

# Full join all scag_total tables:
scag_total_renter_burden_table <- full_join(scag_county_total_renter_burden,scag_total_renter_burden)

# Full join all scag_race tables, then left join scag_total_homeownership_table by county:
scag_renter_burden_table <- full_join(scag_county_race_renter_burden,scag_race_renter_burden) %>% left_join(.,scag_total_renter_burden_table)
# Create new column household_type to denote Renters for type of housing burden for this part of table:
scag_renter_burden_table <- scag_renter_burden_table %>% mutate(household_type = "Renters") %>% select(household_type, everything())

########
# Repeat above steps for own_home == "Homeowner" and join with "Renters" table
# Get housing burden percentages by race for all SCAG:
scag_race_housing_burden <- ca_pums_scag %>% filter(RELSHIPP == 20, own_home == "Homeowner") %>% select(WGTP, race, housing_burden) %>%  
                                         group_by(race) %>% 
                                         summarize(
                                           total_pop = sum(WGTP),
                                           housing = sum(WGTP[housing_burden == "Yes"]), # sum up only those that own homes.
                                           housing_prop = housing / total_pop, # divide by total_pop for proportion
                                           housing_perc = round(housing_prop*100, 2)
                                         ) %>% mutate(county = "SCAG") %>% select(county, race, housing_perc) %>% 
                                         pivot_wider(names_from = race, values_from = housing_perc) # make into wide table to match excel file table.

# Get housing burden percentages by race and by county:
scag_county_race_housing_burden <- ca_pums_scag %>% filter(RELSHIPP == 20, own_home == "Homeowner") %>% select(WGTP, race, county, housing_burden) %>%  
                                         group_by(county, race) %>% 
                                         summarize(
                                           total_pop = sum(WGTP),
                                           housing = sum(WGTP[housing_burden == "Yes"]), # sum up only those that own homes.
                                           housing_prop = housing / total_pop, # divide by total_pop for proportion
                                           housing_perc = round(housing_prop*100, 2)
                                         ) %>% select(county, race, housing_perc) %>% 
                                         pivot_wider(names_from = race, values_from = housing_perc)

# Get housing burden percentages  by county for all SCAG:
scag_county_total_housing_burden <- ca_pums_scag %>% filter(RELSHIPP == 20, own_home == "Homeowner") %>% select(WGTP, race, county, housing_burden) %>%  
                                         group_by(county) %>% 
                                         summarize(
                                           total_pop = sum(WGTP),
                                           housing = sum(WGTP[housing_burden == "Yes"]), # sum up only those that own homes.
                                           housing_prop = housing / total_pop, # divide by total_pop for proportion
                                           housing_perc = round(housing_prop*100, 2)
                                         ) %>% select(county, housing_perc) %>% rename(Total = housing_perc) 
# Get housing burden percentages for all SCAG:
scag_total_housing_burden <- ca_pums_scag %>% filter(RELSHIPP == 20, own_home == "Homeowner") %>% select(WGTP, race, county, housing_burden) %>%  
                                         summarize(
                                           total_pop = sum(WGTP),
                                           housing = sum(WGTP[housing_burden == "Yes"]), # sum up only those that own homes.
                                           housing_prop = housing / total_pop, # divide by total_pop for proportion
                                           housing_perc = round(housing_prop*100, 2)
                                         ) %>% mutate(county = "SCAG") %>% select(county, housing_perc) %>% rename(Total = housing_perc)

# Full join all scag_total tables:
scag_total_housing_burden_table <- full_join(scag_county_total_housing_burden,scag_total_housing_burden)

# Full join all scag_race tables, then left join scag_total_homeownership_table by county:
scag_housing_burden_table <- full_join(scag_county_race_housing_burden,scag_race_housing_burden) %>% left_join(.,scag_total_housing_burden_table)
# Create new column household_type to denote Homeowners for type of housing burden for this part of table:
scag_housing_burden_table <- scag_housing_burden_table %>% mutate(household_type = "Homeowners") %>% select(household_type, everything())

###
# Join renters and Homeowners tables:
full_housing_burden_table <- full_join(scag_renter_burden_table, scag_housing_burden_table)
full_housing_burden_table

# Write out table to .csv in "output/tables" folder and once the file exists remove from current environment all tibbles used to make the final table:
write_csv(full_housing_burden_table, here(tables_fp, "full_housing_burden_table.csv"))
if (file.exists(here(tables_fp, 'full_housing_burden_table.csv'))) {
    rm(list = ls(pattern = "renter_burden"))
    rm(list = ls(pattern = "housing_burden"))
}

```

### Figure 20. People Living in Households Without Kitchen and Plumbing Facilities by Race and Ethnicity

```{r fig 20}
### 
# TODO: NOT Matching up with figure 20 from EA report and figure workbook...Most within 0.01 or matches
# 
# Figure 20. People Living in Households Without Kitchen and Plumbing Facilities by Race and Ethnicity
# Filter to only housing data filter(RELSHIPP == 20) and Use household weights- WGTP: sum if no_kitchen_plumbing == "Yes"
# Get no_kitchen_plumbing percentages by race for all SCAG:
scag_race_no_kitchen_plumbing <- ca_pums_scag %>% select(WGTP, race, no_kitchen_plumbing) %>%  drop_na(no_kitchen_plumbing) %>%  
                                         group_by(race) %>% 
                                         summarize(
                                           total_pop = sum(WGTP),
                                           no_kitchen_plumbing_sum = sum(WGTP[no_kitchen_plumbing == "Yes"]), # sum up only those that own homes.
                                           no_kitchen_plumbing_prop = no_kitchen_plumbing_sum / total_pop, # divide by total_pop for proportion
                                           no_kitchen_plumbing_perc = round(no_kitchen_plumbing_prop*100, 2)
                                         ) %>% mutate(county = "SCAG") %>% select(county, race, no_kitchen_plumbing_perc) %>% 
                                         pivot_wider(names_from = race, values_from = no_kitchen_plumbing_perc) # make into wide table to match excel file table.

# Get no_kitchen_plumbing percentages by race and by county:
scag_county_race_no_kitchen_plumbing <- ca_pums_scag %>% select(WGTP, race, no_kitchen_plumbing, county) %>%  drop_na(no_kitchen_plumbing) %>%
                                         group_by(county, race) %>% 
                                         summarize(
                                           total_pop = sum(WGTP),
                                           no_kitchen_plumbing_sum = sum(WGTP[no_kitchen_plumbing == "Yes"]), # sum up only those that own homes.
                                           no_kitchen_plumbing_prop = no_kitchen_plumbing_sum / total_pop, # divide by total_pop for proportion
                                           no_kitchen_plumbing_perc = round(no_kitchen_plumbing_prop*100, 2)
                                         ) %>% select(county, race, no_kitchen_plumbing_perc) %>% 
                                         pivot_wider(names_from = race, values_from = no_kitchen_plumbing_perc)
# Get no_kitchen_plumbing percentages by county for all SCAG:
scag_county_total_no_kitchen_plumbing <- ca_pums_scag %>%  select(WGTP, county, no_kitchen_plumbing) %>% drop_na(no_kitchen_plumbing) %>%
                                         group_by(county) %>% 
                                         summarize(
                                           total_pop = sum(WGTP),
                                           no_kitchen_plumbing_sum = sum(WGTP[no_kitchen_plumbing == "Yes"]), # sum up only those that own homes.
                                           no_kitchen_plumbing_prop = no_kitchen_plumbing_sum / total_pop, # divide by total_pop for proportion
                                           no_kitchen_plumbing_perc = round(no_kitchen_plumbing_prop*100, 2)
                                         ) %>% select(county, no_kitchen_plumbing_perc) %>% rename(Total = no_kitchen_plumbing_perc) 

# Get no_kitchen_plumbing percentages for all SCAG:
scag_total_no_kitchen_plumbing <- ca_pums_scag %>% select(WGTP, no_kitchen_plumbing) %>% drop_na(no_kitchen_plumbing) %>%
                                        summarize(
                                           total_pop = sum(WGTP),
                                           no_kitchen_plumbing_sum = sum(WGTP[no_kitchen_plumbing == "Yes"]), # sum up only those that own homes.
                                           no_kitchen_plumbing_prop = no_kitchen_plumbing_sum / total_pop, # divide by total_pop for proportion
                                           no_kitchen_plumbing_perc = round(no_kitchen_plumbing_prop*100, 2)
                                         ) %>% mutate(county = "SCAG") %>% select(county, no_kitchen_plumbing_perc) %>% rename(Total = no_kitchen_plumbing_perc)

# Full join all scag_total tables:
scag_total_no_kitchen_plumbing_table <- full_join(scag_county_total_no_kitchen_plumbing,scag_total_no_kitchen_plumbing)

# Full join all scag_race tables, then left join scag_total_no_kitchen_plumbing_table by county:
scag_no_kitchen_plumbing_table <- full_join(scag_county_race_no_kitchen_plumbing,scag_race_no_kitchen_plumbing) %>% left_join(.,scag_total_no_kitchen_plumbing_table)
scag_no_kitchen_plumbing_table

# Write out table to .csv in "output/tables" folder and once the file exists remove from current environment all tibbles used to make the final table:
write_csv(scag_no_kitchen_plumbing_table, here(tables_fp, "scag_no_kitchen_plumbing_table.csv"))
if (file.exists(here(tables_fp, 'scag_no_kitchen_plumbing_table.csv'))) {rm(list = ls(pattern = "no_kitchen_plumbing"))}

```

### Figure 21. Households with Severe Overcrowding by Race and Ethnicity

```{r fig 21}
### 
# Figure 22. Households with Severe Overcrowding by Race and Ethnicity:
# Filter to only housing data (filter(RELSHIPP == 20)) and Use household weights- WGTP, count if "overcrowded" == "Yes":
# Get overcrowding percentages by race for all SCAG:
scag_race_overcrowded <- ca_pums_scag %>% filter(RELSHIPP == 20) %>% select(WGTP, race, overcrowded) %>%  
                                         group_by(race) %>% 
                                         summarize(
                                           total_pop = sum(WGTP),
                                           overcrowd = sum(WGTP[overcrowded == "Yes"]), # sum up only those that
                                           overcrowd_prop = overcrowd / total_pop, # divide by total_pop for proportion
                                           overcrowd_perc = round(overcrowd_prop*100, 2)
                                         ) %>% mutate(county = "SCAG") %>% select(county, race, overcrowd_perc) %>% 
                                         pivot_wider(names_from = race, values_from = overcrowd_perc) # make into wide table to match excel file table.

# Get overcrowded percentages by race and by county:
scag_county_race_overcrowded <- ca_pums_scag %>% filter(RELSHIPP == 20) %>% select(WGTP, county, race, overcrowded) %>%  
                                         group_by(county, race) %>% 
                                         summarize(
                                           total_pop = sum(WGTP),
                                           overcrowd = sum(WGTP[overcrowded == "Yes"]), # sum up only those that
                                           overcrowd_prop = overcrowd / total_pop, # divide by total_pop for proportion
                                           overcrowd_perc = round(overcrowd_prop*100, 2)
                                         ) %>% select(county, race, overcrowd_perc) %>% 
                                         pivot_wider(names_from = race, values_from = overcrowd_perc)
# Get overcrowded percentages by county for all SCAG:
scag_county_total_overcrowded <- ca_pums_scag %>% filter(RELSHIPP == 20) %>% select(WGTP, county, overcrowded) %>%  
                                         group_by(county) %>% 
                                         summarize(
                                           total_pop = sum(WGTP),
                                           overcrowd = sum(WGTP[overcrowded == "Yes"]), # sum up only those that
                                           overcrowd_prop = overcrowd / total_pop, # divide by total_pop for proportion
                                           overcrowd_perc = round(overcrowd_prop*100, 2)
                                         ) %>% select(county, overcrowd_perc) %>% rename(Total = overcrowd_perc) 
# Get overcrowded percentages for all SCAG:
scag_total_overcrowded <- ca_pums_scag %>% filter(RELSHIPP == 20) %>% select(WGTP, overcrowded) %>%  
                                         summarize(
                                           total_pop = sum(WGTP),
                                           overcrowd = sum(WGTP[overcrowded == "Yes"]), # sum up only those that
                                           overcrowd_prop = overcrowd / total_pop, # divide by total_pop for proportion
                                           overcrowd_perc = round(overcrowd_prop*100, 2)
                                         ) %>% mutate(county = "SCAG") %>% select(county, overcrowd_perc) %>% rename(Total = overcrowd_perc)

# Full join all scag_total tables:
scag_total_overcrowded_table <- full_join(scag_county_total_overcrowded,scag_total_overcrowded)

# Full join all scag_race tables, then left join scag_total_overcrowded_table by county:
scag_overcrowded_table <- full_join(scag_county_race_overcrowded,scag_race_overcrowded) %>% left_join(.,scag_total_overcrowded_table) 
scag_overcrowded_table

# Write out table to .csv in "output/tables" folder and once the file exists remove from current environment all tibbles used to make the final table:
write_csv(scag_overcrowded_table, here(tables_fp, "scag_overcrowded_table.csv"))
if (file.exists(here(tables_fp, 'scag_overcrowded_table.csv'))) {rm(list = ls(pattern = "_overcrowded"))}

```

### Figure 22. Homeownership by Race and Ethnicity

```{r fig 22}
### 
# Figure 22. Homeownership by Race and Ethnicity:
# Filter to only housing data () and Use household weights- WGTP:
# Get homeownership percentages by race for all SCAG:
scag_race_homeownership <- ca_pums_scag %>% filter(RELSHIPP == 20) %>% select(WGTP, race,own_home) %>%  
                                         group_by(race) %>% 
                                         summarize(
                                           total_pop = sum(WGTP),
                                           ownership = sum(WGTP[own_home == "Homeowner"]), # sum up only those that own homes.
                                           ownership_prop = ownership / total_pop, # divide by total_pop for proportion
                                           ownership_perc = round(ownership_prop*100, 2)
                                         ) %>% mutate(county = "SCAG") %>% select(county, race, ownership_perc) %>% 
                                         pivot_wider(names_from = race, values_from = ownership_perc) # make into wide table to match excel file table.

# Get homeownership percentages by race and by county:
scag_county_race_homeownership <- ca_pums_scag %>% filter(RELSHIPP == 20) %>% select(WGTP, county, race,own_home) %>%  
                                         group_by(county, race) %>% 
                                         summarize(
                                           total_pop = sum(WGTP),
                                           ownership = sum(WGTP[own_home == "Homeowner"]), # sum up only those that own homes.
                                           ownership_prop = ownership / total_pop, # divide by total_pop for proportion
                                           ownership_perc = round(ownership_prop*100, 2) 
                                         ) %>% select(county, race, ownership_perc) %>% 
                                         pivot_wider(names_from = race, values_from = ownership_perc)
# Get homeownership percentages by county for all SCAG:
scag_county_total_homeownership <- ca_pums_scag %>% filter(RELSHIPP == 20) %>% select(WGTP, county, own_home) %>%  
                                         group_by(county) %>% 
                                         summarize(
                                           total_pop = sum(WGTP),
                                           ownership = sum(WGTP[own_home == "Homeowner"]), # sum up only those that own homes.
                                           ownership_prop = ownership / total_pop, # divide by total_pop for proportion
                                           ownership_perc = round(ownership_prop*100, 2) 
                                         ) %>% select(county, ownership_perc) %>% rename(Total = ownership_perc) 
# Get homeownership percentages for all SCAG:
scag_total_homeownership <- ca_pums_scag %>% filter(RELSHIPP == 20) %>% select(WGTP, own_home) %>%  
                                         summarize(
                                           total_pop = sum(WGTP),
                                           ownership = sum(WGTP[own_home == "Homeowner"]), # sum up only those that own homes.
                                           ownership_prop = ownership / total_pop, # divide by total_pop for proportion
                                           ownership_perc = round(ownership_prop*100, 2) 
                                         ) %>% mutate(county = "SCAG") %>% select(county, ownership_perc) %>% rename(Total = ownership_perc)

# Full join all scag_total tables:
scag_total_homeownership_table <- full_join(scag_county_total_homeownership,scag_total_homeownership)

# Full join all scag_race tables, then left join scag_total_homeownership_table by county:
scag_homeownership_table <- full_join(scag_county_race_homeownership,scag_race_homeownership) %>% left_join(.,scag_total_homeownership_table)
scag_homeownership_table

# Write out table to .csv in "output/tables" folder and once the file exists remove from current environment all tibbles used to make the final table:
write_csv(scag_homeownership_table, here(tables_fp, "scag_homeownership_table.csv"))
if (file.exists(here(tables_fp, 'scag_homeownership_table.csv'))) {rm(list = ls(pattern = "_homeownership"))}

```

### Figure 28. People without Health Insurance by Race and Ethnicity

```{r fig 28}
### 
# Figure 28. People without Health Insurance by Race and Ethnicity:
# # Health insurance coverage
# *------- P4.Health Insurance  -------------;
# *HICOV Character 1
# Health insurance coverage recode
# 1 .With health insurance coverage
# 2 .No health insurance coverage;
# ca_pums_scag %>% select(HICOV) 
# 
# Use person level weights- PWGTP:
# sum over those without health insurance coverage HICOV ==  2
# 
# Get People without Health Insurance percentages by race for all SCAG:
scag_race_no_hicov <- ca_pums_scag %>% select(PWGTP, race, HICOV) %>%  
                                         group_by(race) %>% 
                                         summarize(
                                           total_pop = sum(PWGTP),
                                           no_hicov = sum(PWGTP[HICOV == 2]),  
                                           no_hicov_prop = no_hicov / total_pop, # divide by total_pop for proportion
                                          no_hicov_perc = round(no_hicov_prop*100, 2)
                                         ) %>% mutate(county = "SCAG") %>% select(county, race, no_hicov_perc) %>% 
                                         pivot_wider(names_from = race, values_from = no_hicov_perc) # make into wide table to match excel file table.

# Get People without Health Insurance percentages by race for all by race and county:
scag_county_race_no_hicov <- ca_pums_scag %>% select(PWGTP, county, race, HICOV) %>%  
                                         group_by(county, race) %>% 
                                         summarize(
                                           total_pop = sum(PWGTP),
                                           no_hicov = sum(PWGTP[HICOV == 2]),  
                                           no_hicov_prop = no_hicov / total_pop, # divide by total_pop for proportion
                                          no_hicov_perc = round(no_hicov_prop*100, 2)
                                         ) %>% select(county, race, no_hicov_perc) %>% 
                                         pivot_wider(names_from = race, values_from = no_hicov_perc)

# Get People without Health Insurance  percentages by county for all SCAG:
scag_county_total_no_hicov <- ca_pums_scag %>% select(PWGTP, county, HICOV)  %>%  
                                               group_by(county) %>% 
                                               summarize(
                                                 total_pop = sum(PWGTP),
                                                 no_hicov = sum(PWGTP[HICOV == 2]),  
                                                 no_hicov_prop = no_hicov / total_pop, # divide by total_pop for proportion
                                                no_hicov_perc = round(no_hicov_prop*100, 2)
                                               ) %>% select(county, no_hicov_perc) %>% rename(Total = no_hicov_perc) 
# Get People without Health Insurance  percentages for all SCAG:
scag_total_no_hicov <- ca_pums_scag %>% select(PWGTP, HICOV) %>%  
                                         summarize(
                                           total_pop = sum(PWGTP),
                                           no_hicov = sum(PWGTP[HICOV == 2]),  
                                           no_hicov_prop = no_hicov / total_pop, # divide by total_pop for proportion
                                          no_hicov_perc = round(no_hicov_prop*100, 2)
                                         ) %>% mutate(county = "SCAG") %>% select(county, no_hicov_perc) %>% rename(Total = no_hicov_perc)

# Full join all scag_total tables:
scag_total_no_hicov_table <- full_join(scag_county_total_no_hicov,scag_total_no_hicov)

# Full join all scag_race tables, then left join scag_total_no_veh_table by county:
scag_no_hicov_table <- full_join(scag_county_race_no_hicov,scag_race_no_hicov) %>% left_join(.,scag_total_no_hicov_table, by = join_by(county))
scag_no_hicov_table

# Write out table to .csv in "output/tables" folder and once the file exists remove from current environment all tibbles used to make the final table:
write_csv(scag_no_hicov_table, here(tables_fp, "scag_no_hicov_table.csv"))
if (file.exists(here(tables_fp, 'scag_no_hicov_table.csv'))) {rm(list = ls(pattern = "_no_hicov"))}

```

### Figure 39. Median Hourly Wage by Race and Ethnicity

```{r fig 39}
### 
# Figure 39. Median Hourly Wage by Race and Ethnicity
# Use person level weights- PWGTP:

# Get Median Hourly Wage by race for all SCAG:
scag_race_med_hr_wage <- ca_pums_scag %>% filter(ESR %in% c(1:2) & AGEP %in% c(25:64)) %>% 
                                       select(PWGTP, race, hourly_wage)  %>% 
                                       group_by(race) %>% 
                                       summarize(
                                         med_hr_wage = round(weighted.median(hourly_wage, PWGTP, na.rm = TRUE),2)
                                       ) %>% mutate(county = "SCAG") %>% select(county, race, med_hr_wage) %>% 
                                       pivot_wider(names_from = race, values_from = med_hr_wage) # make into wide table to match excel file table.

# Get Median Hourly Wage by race for all by race and county:
scag_county_race_med_hr_wage <- ca_pums_scag %>% filter(ESR %in% c(1:2) & AGEP %in% c(25:64)) %>% 
                                       select(PWGTP, county, race, hourly_wage) %>% 
                                         group_by(county, race) %>% 
                                         summarize(
                                         med_hr_wage = round(weighted.median(hourly_wage, PWGTP, na.rm = TRUE),2)
                                         ) %>% select(county, race, med_hr_wage) %>% 
                                         pivot_wider(names_from = race, values_from = med_hr_wage)

# Get Median Hourly Wage by county for all SCAG:
scag_county_total_med_hr_wage <- ca_pums_scag %>% filter(ESR %in% c(1:2) & AGEP %in% c(25:64)) %>% 
                                       select(PWGTP, county, race, hourly_wage) %>%  
                                               group_by(county) %>% 
                                               summarize(
                                           med_hr_wage = round(weighted.median(hourly_wage, PWGTP, na.rm = TRUE),2)
                                         ) %>% select(county, med_hr_wage) %>% rename(Total = med_hr_wage) 
# Get Median Hourly Wage for all SCAG:
scag_total_med_hr_wage <- ca_pums_scag %>% filter(ESR %in% c(1:2) & AGEP %in% c(25:64)) %>% 
                                       select(PWGTP, race, hourly_wage) %>%  
                                         summarize(
                                           med_hr_wage = round(weighted.median(hourly_wage, PWGTP, na.rm = TRUE),2)
                                           ) %>% mutate(county = "SCAG") %>% select(county, med_hr_wage) %>% rename(Total = med_hr_wage)

# Full join all scag_total tables:
scag_total_med_hr_wage_table <- full_join(scag_county_total_med_hr_wage,scag_total_med_hr_wage)

# Full join all scag_race tables, then left join scag_total_no_veh_table by county:
scag_med_hr_wage_table <- full_join(scag_county_race_med_hr_wage,scag_race_med_hr_wage) %>% left_join(.,scag_total_med_hr_wage_table, by = join_by(county))
scag_med_hr_wage_table

# Write out table to .csv in "output/tables" folder and once the file exists remove from current environment all tibbles used to make the final table:
write_csv(scag_med_hr_wage_table, here(tables_fp, "scag_med_hr_wage_table.csv"))
if (file.exists(here(tables_fp, 'scag_med_hr_wage_table.csv'))) {rm(list = ls(pattern = "_med_hr_wage"))}

```

### Figure 40. Unemployment by Race and Ethnicity

```{r fig 40.}
### 
# Figure 40. Unemployment by Race and Ethnicity
# Use person level weights- PWGTP:

# Get unemployed percentage by race for all SCAG:
scag_race_unemployed <- ca_pums_scag %>% select(PWGTP, race, unemployed,ESR) %>% drop_na(unemployed) %>% 
                                       group_by(race) %>% 
                                       summarize(
                                           total_labor = sum(PWGTP[ESR != 6]), # excludes not in labor force from ESR variable
                                           unemployed_sum = sum(PWGTP[unemployed == "Yes"]),  
                                           unemployed_prop = unemployed_sum / total_labor, # divide by total_labor for proportion
                                           unemployed_perc = round(unemployed_prop*100, 2)
                                         )  %>% mutate(county = "SCAG") %>% select(county, race, unemployed_perc) %>% 
                                       pivot_wider(names_from = race, values_from = unemployed_perc) # make into wide table to match excel file table.
# TODO: above works need to finish rest of code chuck for figure 40
# # Get Median Hourly Wage by race for all by race and county:
# scag_county_race_med_hr_wage <- ca_pums_scag %>% filter(ESR %in% c(1:2) & AGEP %in% c(25:64)) %>% 
#                                        select(PWGTP, county, race, hourly_wage) %>% 
#                                          group_by(county, race) %>% 
#                                          summarize(
#                                          med_hr_wage = round(weighted.median(hourly_wage, PWGTP, na.rm = TRUE),2)
#                                          ) %>% select(county, race, med_hr_wage) %>% 
#                                          pivot_wider(names_from = race, values_from = med_hr_wage)
# 
# # Get Median Hourly Wage by county for all SCAG:
# scag_county_total_med_hr_wage <- ca_pums_scag %>% filter(ESR %in% c(1:2) & AGEP %in% c(25:64)) %>% 
#                                        select(PWGTP, county, race, hourly_wage) %>%  
#                                                group_by(county) %>% 
#                                                summarize(
#                                            med_hr_wage = round(weighted.median(hourly_wage, PWGTP, na.rm = TRUE),2)
#                                          ) %>% select(county, med_hr_wage) %>% rename(Total = med_hr_wage) 
# # Get Median Hourly Wage for all SCAG:
# scag_total_med_hr_wage <- ca_pums_scag %>% filter(ESR %in% c(1:2) & AGEP %in% c(25:64)) %>% 
#                                        select(PWGTP, race, hourly_wage) %>%  
#                                          summarize(
#                                            med_hr_wage = round(weighted.median(hourly_wage, PWGTP, na.rm = TRUE),2)
#                                            ) %>% mutate(county = "SCAG") %>% select(county, med_hr_wage) %>% rename(Total = med_hr_wage)
# 
# # Full join all scag_total tables:
# scag_total_med_hr_wage_table <- full_join(scag_county_total_med_hr_wage,scag_total_med_hr_wage)
# 
# # Full join all scag_race tables, then left join scag_total_no_veh_table by county:
# scag_med_hr_wage_table <- full_join(scag_county_race_med_hr_wage,scag_race_med_hr_wage) %>% left_join(.,scag_total_med_hr_wage_table, by = join_by(county))
# scag_med_hr_wage_table

# # Write out table to .csv in "output/tables" folder and once the file exists remove from current environment all tibbles used to make the final table:
# write_csv(scag_med_hr_wage_table, here(tables_fp, "scag_med_hr_wage_table.csv"))
# if (file.exists(here(tables_fp, 'scag_med_hr_wage_table.csv'))) {rm(list = ls(pattern = "_med_hr_wage"))}

```

--- 

### Write out excel file with all sheets:
-
```{r write excel, eval=FALSE, include=FALSE}
# Read in completed tables and set to tibbles in current global env:
# Read in all the tables from the folder "output/tables" and keep names from the files:
table_file_list <- lapply(list.files(here(tables_fp),full.names=TRUE), function(x) { read_csv(x, show_col_types = FALSE) } )

# set names of each list element to the actual file name without path and file.extension
table_file_list <- set_names(table_file_list, file_path_sans_ext(path_file(list.files(here(tables_fp),full.names=TRUE))))

# convert each list item into a tibble and save to the current global env:
table_file_list %>% 
  map(as_tibble) %>%
  list2env(envir = .GlobalEnv)

### Create tabbed excel workbook for SCAG:
# Set up up a tibble to use as a table of contents (toc) for output tabbed excel workbook named "scag_tabbed.xlsx":
toc <- tribble(~sheet_name, ~ figure_name,
              "Figure_5",  "Figure 5. Workers who Commute by Walk, Bike, or Public Transit by Race and Ethnicity",
              "Figure_6",  "Figure 6. Householders without a Vehicle by Race and Ethnicity",
              "Figure_7",  "Figure 7. Workers’ Commute Times (Minutes) by Mode and Race and Ethnicity",
              "Figure_19", "Figure 19. Renters and Homeowners Experiencing Housing Cost Burden by Race and Ethnicity",
              "Figure_20", "Figure 20. People Living in Households Without Kitchen and Plumbing Facilities by Race and Ethnicity",
              "Figure_21",  "Figure 21. Households with Severe Overcrowding by Race and Ethniciy",
              "Figure_22",  "Figure 22. Homeownership by Race and Ethniciy",
              "Figure_28",  "Figure 28. People without Health Insurance by Race and Ethnicity",
              "Figure_39", "Figure 39. Median Hourly Wage by Race and Ethnicity",
              "Figure_40", "Figure 40. Unemployment by Race and Ethnicity",
              "Figure_41", "Figure 41. Working Poor by Race and Ethnicity")

# Write out table to new sheet in excel file for tabbed SCAG output, list is this format: ("name of new sheet" = df/tibble)
# Make a list that has the name or each sheets and the df/tibble that will populate it- e.g below "scag_homeownership_table" is a tibble that will populate the sheet named "Figure_22".
sheets <- list("TOC" = toc,
               "Figure_5" = scag_walk_bike_public_table,
               "Figure_6" = scag_no_veh_table,
               "Figure_7" = scag_transport_mean_table,
               "Figure_19" = full_housing_burden_table,
               "Figure_20" = scag_no_kitchen_plumbing_table,
               "Figure_21" = scag_overcrowded_table,
               "Figure_22" = scag_homeownership_table, 
               "Figure_28" = scag_no_hicov_table,
               "Figure_39" = scag_med_hr_wage_table
               ) 

# Create an output folder if it does NOT exist already:
if (!dir.exists("output")) {dir.create("output")}

# Pass sheet list to write_xlsx() and destination "path/filename.xlsx", write to "output/scag_tabbed.xlsx":
write_xlsx(sheets, "output/scag_tabbed.xlsx")

```

--- 


```{r new_tab, eval=FALSE}

# Figure 19. Renters and Homeowners Experiencing Housing Cost Burden by Race and Ethnicity 
# Filter to only housing data and renters (filter(RELSHIPP == 20, own_home == "Non-Homeowner")) and Use household weights- WGTP, sum if renter_burden == "Yes":
# Get renter burden percentages by race for all SCAG:
scag_race_renter_burden <- ca_pums_scag %>% filter(RELSHIPP == 20, own_home == "Non-Homeowner") %>% select(WGTP, race, renter_burden) %>%  
                                         group_by(race) %>% 
                                         summarize(
                                           total_pop = sum(WGTP),
                                           renter = sum(WGTP[renter_burden == "Yes"]), # sum up only those that own homes.
                                           renter_prop = renter / total_pop, # divide by total_pop for proportion
                                           renter_perc = round(renter_prop*100, 2)
                                         ) %>% mutate(county = "SCAG") %>% select(county, race, renter_perc) %>% 
                                         pivot_wider(names_from = race, values_from = renter_perc) # make into wide table to match excel file table.

# Get renter burden percentages by race and by county:
scag_county_race_renter_burden <- ca_pums_scag %>% filter(RELSHIPP == 20, own_home == "Non-Homeowner") %>% select(WGTP, race, county, renter_burden) %>%  
                                         group_by(county, race) %>% 
                                         summarize(
                                           total_pop = sum(WGTP),
                                           renter = sum(WGTP[renter_burden == "Yes"]), # sum up only those that own homes.
                                           renter_prop = renter / total_pop, # divide by total_pop for proportion
                                           renter_perc = round(renter_prop*100, 2)
                                         ) %>% select(county, race, renter_perc) %>% 
                                         pivot_wider(names_from = race, values_from = renter_perc)

# Get renter burden percentages  by county for all SCAG:
scag_county_total_renter_burden <- ca_pums_scag %>% filter(RELSHIPP == 20, own_home == "Non-Homeowner") %>% select(WGTP, race, county, renter_burden) %>%  
                                         group_by(county) %>% 
                                         summarize(
                                           total_pop = sum(WGTP),
                                           renter = sum(WGTP[renter_burden == "Yes"]), # sum up only those that own homes.
                                           renter_prop = renter / total_pop, # divide by total_pop for proportion
                                           renter_perc = round(renter_prop*100, 2)
                                         ) %>% select(county, renter_perc) %>% rename(Total = renter_perc) 
# Get renter burden percentages for all SCAG:
scag_total_renter_burden <- ca_pums_scag %>% filter(RELSHIPP == 20, own_home == "Non-Homeowner") %>% select(WGTP, race, county, renter_burden) %>%  
                                         summarize(
                                           total_pop = sum(WGTP),
                                           renter = sum(WGTP[renter_burden == "Yes"]), # sum up only those that own homes.
                                           renter_prop = renter / total_pop, # divide by total_pop for proportion
                                           renter_perc = round(renter_prop*100, 2)
                                         ) %>% mutate(county = "SCAG") %>% select(county, renter_perc) %>% rename(Total = renter_perc)

# Full join all scag_total tables:
scag_total_renter_burden_table <- full_join(scag_county_total_renter_burden,scag_total_renter_burden)

# Full join all scag_race tables, then left join scag_total_homeownership_table by county:
scag_renter_burden_table <- full_join(scag_county_race_renter_burden,scag_race_renter_burden) %>% left_join(.,scag_total_renter_burden_table)
# Create new column household_type to denote Renters for type of housing burden for this part of table:
scag_renter_burden_table <- scag_renter_burden_table %>% mutate(household_type = "Renters") %>% select(household_type, everything())

########
# Repeat above steps for own_home == "Homeowner" and join with "Renters" table
# Get housing burden percentages by race for all SCAG:
scag_race_housing_burden <- ca_pums_scag %>% filter(RELSHIPP == 20, own_home == "Homeowner") %>% select(WGTP, race, housing_burden) %>%  
                                         group_by(race) %>% 
                                         summarize(
                                           total_pop = sum(WGTP),
                                           housing = sum(WGTP[housing_burden == "Yes"]), # sum up only those that own homes.
                                           housing_prop = housing / total_pop, # divide by total_pop for proportion
                                           housing_perc = round(housing_prop*100, 2)
                                         ) %>% mutate(county = "SCAG") %>% select(county, race, housing_perc) %>% 
                                         pivot_wider(names_from = race, values_from = housing_perc) # make into wide table to match excel file table.

# Get housing burden percentages by race and by county:
scag_county_race_housing_burden <- ca_pums_scag %>% filter(RELSHIPP == 20, own_home == "Homeowner") %>% select(WGTP, race, county, housing_burden) %>%  
                                         group_by(county, race) %>% 
                                         summarize(
                                           total_pop = sum(WGTP),
                                           housing = sum(WGTP[housing_burden == "Yes"]), # sum up only those that own homes.
                                           housing_prop = housing / total_pop, # divide by total_pop for proportion
                                           housing_perc = round(housing_prop*100, 2)
                                         ) %>% select(county, race, housing_perc) %>% 
                                         pivot_wider(names_from = race, values_from = housing_perc)

# Get housing burden percentages  by county for all SCAG:
scag_county_total_housing_burden <- ca_pums_scag %>% filter(RELSHIPP == 20, own_home == "Homeowner") %>% select(WGTP, race, county, housing_burden) %>%  
                                         group_by(county) %>% 
                                         summarize(
                                           total_pop = sum(WGTP),
                                           housing = sum(WGTP[housing_burden == "Yes"]), # sum up only those that own homes.
                                           housing_prop = housing / total_pop, # divide by total_pop for proportion
                                           housing_perc = round(housing_prop*100, 2)
                                         ) %>% select(county, housing_perc) %>% rename(Total = housing_perc) 
# Get housing burden percentages for all SCAG:
scag_total_housing_burden <- ca_pums_scag %>% filter(RELSHIPP == 20, own_home == "Homeowner") %>% select(WGTP, race, county, housing_burden) %>%  
                                         summarize(
                                           total_pop = sum(WGTP),
                                           housing = sum(WGTP[housing_burden == "Yes"]), # sum up only those that own homes.
                                           housing_prop = housing / total_pop, # divide by total_pop for proportion
                                           housing_perc = round(housing_prop*100, 2)
                                         ) %>% mutate(county = "SCAG") %>% select(county, housing_perc) %>% rename(Total = housing_perc)

# Full join all scag_total tables:
scag_total_housing_burden_table <- full_join(scag_county_total_housing_burden,scag_total_housing_burden)

# Full join all scag_race tables, then left join scag_total_homeownership_table by county:
scag_housing_burden_table <- full_join(scag_county_race_housing_burden,scag_race_housing_burden) %>% left_join(.,scag_total_housing_burden_table)
# Create new column household_type to denote Homeowners for type of housing burden for this part of table:
scag_housing_burden_table <- scag_housing_burden_table %>% mutate(household_type = "Homeowners") %>% select(household_type, everything())

###
# Join renters and Homeowners tables:
full_housing_burden_table <- full_join(scag_renter_burden_table, scag_housing_burden_table)
full_housing_burden_table
```
