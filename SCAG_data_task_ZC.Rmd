---
title: "SCAG Data Task"
author: "Zack Crowley"
date: "`r format(Sys.Date(), '%B %d, %Y')`"
output: 
    html_document:
        df_print: paged
---

```{r setup, include=FALSE}
# Set R chunk options:
## Set default options for R code chunks:
knitr::opts_chunk$set(
    echo = FALSE, 
    warning = FALSE, 
    message = FALSE,
    rows.print = 20 # display 20 rows inline and in document
    # fig.width = 6.5,
    # fig.height = 4
    )
# Prevents sci notation and sets the output of decimals to 4 (0.0000), suppresses warnings/info for tidyverse:
options(scipen = 999,
        tidyverse.quiet = TRUE,
        dplyr.summarise.inform = FALSE,
        pillar.print_min = 40
        )

# Un-comment next two lines to install/update all necesary packages:
# install.packages("remotes") # first install remotes to use update_packages()
# remotes::update_packages(c("here", "rstudioapi", "magrittr", "janitor", "fs", "tools" "spatstat", "readxl", "openxlsx2", "data.table", "tidycensus", "tidyverse")) # un-comment to install/update packages

# Set here() location- working directory will be based on the project folder that this Rmd file is inside of currently (if you re-name this file, also change inside this if using an .Rproj/R project:
here::i_am("SCAG_data_task_ZC.Rmd")

# Load libraries:
library(here) # package to manage file paths
library(rstudioapi) # package accessing Rstudio API 
library(magrittr) # pipe function package
library(spatstat) # package for weighted.median() function
library(readxl) # reading excel files
library(openxlsx2) # writing excel files and manipulating excel workbooks.
library(data.table) # package for data manipulation and reads in large files faster using fread()
library(tidycensus) # API for US Census- can access ACS PUMS directly from API- key set in .Renviron- to see use: usethis::edit_r_environ()
library(tidyverse) # package loads all tidyverse packages like dplyr, tidyselect, stringR, etc.


#### Functions ----
### weight_perc_table()
# Function to return full table of weighted percentages by group and filtered to one value of a variable: weight_perc_table()
# For use when you want to return weighted percentages of one value of a variable and by one group- e.g. people with disability (%) by county
# df = dataframe of all data, var = variable to sum over,  weight = weights, group = grouping variable, filter_value = value of a variable to filter output to, NULL by default, and 
# group_label_totals = "SCAG" - this is the label for the group total of the grouped variable, defaults to "SCAG".
weight_perc_table <- function(df, var, weight, group, filter_value = NULL, group_label_totals = "SCAG") {
    # If filter_value is not NULL:
    if (!is.null(filter_value)) {
    # Get var percentages for all:
    overall_perc <- df %>% select({{weight}}, {{var}})  %>% count(!!sym((var)), wt = !!sym((weight))) %>% mutate(total_pop = sum(n)) %>% 
                                            group_by(!!sym((var))) %>% summarize(percentage = round( (n / total_pop)*100, 2)) %>% filter(!!sym((var)) == filter_value) %>% ungroup() %>% 
                                            mutate({{group}} := group_label_totals) %>% select({{group}}, percentage)
                                            

    # Get var percentages for by group:
    group_perc <- df %>% select({{weight}}, {{var}}, {{group}}) %>% group_by(!!sym((group))) %>% count(!!sym((var)), wt = !!sym((weight))) %>% mutate(total_pop = sum(n)) %>% 
                                            group_by(!!sym((var)), !!sym((group))) %>% summarize(percentage = round( (n / total_pop)*100, 2)) %>% filter(!!sym((var)) == filter_value) %>% ungroup() %>% 
                                             select({{group}}, percentage)

    # Full join group_perc and overall_perc by group, percentage and re-order the columns:
    full_table <- full_join(group_perc, overall_perc, by = join_by({{group}}, percentage)) %>% 
                     select({{group}}, percentage)

    return(full_table)
    
    } else { # else filter_value is NULL:
        
    # Get var percentages for all:
    overall_perc <- df %>% select({{weight}}, {{var}})  %>% count(!!sym((var)), wt = !!sym((weight))) %>% mutate(total_pop = sum(n)) %>% 
                                            group_by(!!sym((var))) %>% summarize(percentage = round( (n / total_pop)*100, 2)) %>% ungroup() %>% 
                                            mutate({{group}} := group_label_totals) %>% select({{var}}, {{group}}, percentage)
                                            

    # Get var percentages for by group:
    group_perc <- df %>% select({{weight}}, {{var}}, {{group}}) %>% group_by(!!sym((group))) %>% count(!!sym((var)), wt = !!sym((weight))) %>% mutate(total_pop = sum(n)) %>% 
                                            group_by(!!sym((var)), !!sym((group))) %>% summarize(percentage = round( (n / total_pop)*100, 2)) %>% ungroup() %>% 
                                             select({{var}}, {{group}}, percentage)

    # Full join group_perc and overall_perc by var, group, percentage and re-order the columns:
    full_table <- full_join(group_perc, overall_perc, by = join_by({{var}}, {{group}}, percentage)) %>% 
                    select({{group}}, {{var}}, percentage)

    return(full_table)
    }
}

### 
### weight_perc_2groups() 
# Function to return full table of weighted percentages by two groups and also able to be filtered to one value of a variable if specified: weight_perc_2groups()
# # For use when you want to return weighted percentages by two groups- e.g. HH without a vehicle (%) by county and race.
# df = dataframe of all data, var = variable to sum over,  weight = weights, group1 = grouping variable 1 (county), group2 = grouping variable 2 (race),
#  filter_value = value of a variable to filter output to, group1_levels = levels (vector) to change group1 to a factor, group2_levels = levels to change group2 to a factor
# has and if statement to drop filter_value if NULL, which it is by default group_by(across(variables_2)), group1_label_totals = "SCAG" - this is the label for the group1 total of the grouped variable, defaults to "SCAG", group2_label_totals = "All Races" - this is the label for the group1 total of the grouped variable, defaults to "All Races". IMPORTANT if you change group1_label_totals or group2_label_totals, then respective group1_levels and group2_levels need to be changed to match total label.
weight_perc_2groups <- function(df, var, weight, group1, group2, filter_value = NULL, group1_levels = NULL, group2_levels = NULL, group1_label_totals = "SCAG", group2_label_totals = "All Races") {
    # If filter_value is not NULL:
    if (!is.null(filter_value)) {
    # Get percent for group1 (usually county):
    group1_total <-  df %>% select({{weight}}, {{var}}, {{group1}}) %>% group_by(!!sym((group1))) %>% count(!!sym((var)), wt = !!sym((weight))) %>% mutate(total_pop = sum(n)) %>% 
                                                group_by(!!sym((var)), !!sym((group1))) %>% summarize(percentage = round( (n / total_pop)*100, 2)) %>% 
                                                filter(!!sym((var)) == filter_value) %>% ungroup() %>% mutate({{group2}} := group2_label_totals) %>% select({{group1}}, {{group2}},  percentage)

    # Get percent for group2 (usually county):
    group2_total <-  df %>% select({{weight}}, {{var}}, {{group2}}) %>% group_by(!!sym((group2))) %>% count(!!sym((var)), wt = !!sym((weight))) %>% mutate(total_pop = sum(n)) %>% 
                                                group_by(!!sym((var)), !!sym((group2))) %>% summarize(percentage = round( (n / total_pop)*100, 2)) %>% 
                                                filter(!!sym((var)) == filter_value) %>% ungroup() %>% mutate({{group1}} := group1_label_totals) %>% select({{group1}}, {{group2}},  percentage)

    # Get percent for group2 (usually county):
    group1_by_group2_total <-  df %>% select({{weight}}, {{var}}, {{group1}}, {{group2}}) %>% group_by(!!sym((group1)), !!sym((group2))) %>% 
                                              count(!!sym((var)), wt = !!sym((weight))) %>% mutate(total_pop = sum(n)) %>% 
                                                group_by(!!sym((var)), !!sym((group1)), !!sym((group2))) %>% summarize(percentage = round( (n / total_pop)*100, 2)) %>% 
                                                filter(!!sym((var)) == filter_value) %>% ungroup() %>% 
                                                 select({{group1}}, {{group2}},  percentage)

    # Get percent for group2 (usually county):
    total_overall <-  df %>% select({{weight}}, {{var}}) %>% count(!!sym((var)), wt = !!sym((weight))) %>% mutate(total_pop = sum(n)) %>% 
                                              group_by(!!sym((var))) %>%  summarize(percentage = round( (n / total_pop)*100, 2)) %>% 
                                                filter(!!sym((var)) == filter_value) %>% ungroup() %>%  mutate({{group1}} := group1_label_totals) %>% 
                                                 select({{group1}}, percentage)

    # Full join two total tables- group1_total and total_overall- then create a group2_label_totals for column group2:
    group1_total_overall_tbl <- full_join(group1_total, total_overall, by = join_by({{group1}}, percentage)) %>% mutate({{group2}} := group2_label_totals)

    # Full join group1_by_group2_total and group1_total_overall_tbl tables, then full_join join group2_total, re-order columns = {{group1}}, {{group2}}, percentage:
    full_table <- full_join(group1_by_group2_total,group1_total_overall_tbl, by = join_by({{group1}}, {{group2}}, percentage)) %>% 
                        full_join(.,group2_total, by = join_by({{group1}}, {{group2}}, percentage)) %>% 
                            select({{group1}}, {{group2}}, percentage)
        
        # If both group1_levels and group2_levels are NOT NULL:
        if (!is.null(group1_levels) & !is.null(group2_levels)) {
            
        # If levels are provided for both group1_levels and group2_levels- set each as a factor with levels and then arrange by group1,group2:
        full_table <- full_table %>% mutate({{group1}} := factor(!!sym((group1)), levels = group1_levels),
                                            {{group2}} := factor(!!sym((group2)), levels = group2_levels)) %>% 
                                     arrange(!!sym((group1)),!!sym((group2))) %>% 
                                     select({{group1}}, {{group2}}, percentage)
        } 
    
    } else { # else filter_value is NULL:
        
    # Get percent for group1 (usually county):
    group1_total <-  df %>% select({{weight}}, {{var}}, {{group1}}) %>% group_by(!!sym((group1))) %>% count(!!sym((var)), wt = !!sym((weight))) %>% mutate(total_pop = sum(n)) %>% 
                                                group_by(!!sym((var)), !!sym((group1))) %>% summarize(percentage = round( (n / total_pop)*100, 2)) %>% ungroup() %>% 
                                                mutate({{group2}} := group2_label_totals) %>% select({{var}}, {{group1}}, {{group2}},  percentage)

    # Get percent for group2 (usually county):
    group2_total <-  df %>% select({{weight}}, {{var}}, {{group2}}) %>% group_by(!!sym((group2))) %>% count(!!sym((var)), wt = !!sym((weight))) %>% mutate(total_pop = sum(n)) %>% 
                                                group_by(!!sym((var)), !!sym((group2))) %>% summarize(percentage = round( (n / total_pop)*100, 2)) %>% ungroup() %>% 
                                                mutate({{group1}} := group1_label_totals) %>% select({{var}}, {{group1}}, {{group2}},  percentage)

    # Get percent for group2 (usually county):
    group1_by_group2_total <-  df %>% select({{weight}}, {{var}}, {{group1}}, {{group2}}) %>% group_by(!!sym((group1)), !!sym((group2))) %>% 
                                              count(!!sym((var)), wt = !!sym((weight))) %>% mutate(total_pop = sum(n)) %>% 
                                                group_by(!!sym((var)), !!sym((group1)), !!sym((group2))) %>% 
                                                summarize(percentage = round( (n / total_pop)*100, 2)) %>% ungroup() %>% 
                                                 select({{var}}, {{group1}}, {{group2}},  percentage)

    # Get percent for group2 (usually county):
    total_overall <-  df %>% select({{weight}}, {{var}}) %>% count(!!sym((var)), wt = !!sym((weight))) %>% mutate(total_pop = sum(n)) %>% 
                                              group_by(!!sym((var))) %>%  summarize(percentage = round( (n / total_pop)*100, 2)) %>% ungroup() %>%  
                                                mutate({{group1}} := group1_label_totals) %>% select({{var}}, {{group1}}, percentage)

    # Full join two total tables- group1_total and total_overall- then create a group2_label_totals for column group2:
    group1_total_overall_tbl <- full_join(group1_total, total_overall, by = join_by({{var}}, {{group1}}, percentage)) %>% mutate({{group2}} := group2_label_totals)

    # Full join group1_by_group2_total and group1_total_overall_tbl tables, then full_join join group2_total, re-order columns = {{group1}}, {{group2}}, percentage:
    full_table <- full_join(group1_by_group2_total,group1_total_overall_tbl, by = join_by({{var}}, {{group1}}, {{group2}}, percentage)) %>% 
                        full_join(.,group2_total, by = join_by({{var}}, {{group1}}, {{group2}}, percentage)) %>% 
                            select({{group1}}, {{group2}}, {{var}}, percentage)
        
        # If both group1_levels and group2_levels are NOT NULL:
        if (!is.null(group1_levels) & !is.null(group2_levels)) {
            
        # If levels are provided for both group1_levels and group2_levels- set each as a factor with levels and then arrange by group1,group2:
        full_table <- full_table %>% mutate({{group1}} := factor(!!sym((group1)), levels = group1_levels),
                                            {{group2}} := factor(!!sym((group2)), levels = group2_levels)) %>% 
                                     arrange(!!sym((group1)), !!sym((var)), !!sym((group1))) %>% 
                                     select({{group1}}, {{group2}}, {{var}}, percentage)
        } 
    
    } # End of main if/else.
    
    
    return(full_table)
} # end of weight_perc_2groups()

##### Variables/lists for functions
# Set up county and race levels to use later on to convert each to factors and arrange tables:
# county_levels:
county_levels <- c("Imperial", "Los Angeles", "Orange", "Riverside", "San Bernardino", "Ventura", "SCAG")

# race_levels:
race_levels <-  c("Asian/Pacific Islander", "Black", "Hispanic/Latino", "Multiracial/Other", "Native American", "White", "All Races")

#### Data Dictionaries ----
### 2021 ACS: 
## Get data dictionary as tibble from tidycensus for 2021:
# pums_vars_acs5 <- pums_variables %>%
#   filter(year == 2021, survey == "acs5")
# # person level
# pums_vars_acs5_person <- pums_variables %>%
#   filter(year == 2021, survey == "acs5", level == "person")
# # housing level:
# pums_vars_acs5_housing <- pums_variables %>%
#    filter(year == 2021, survey == "acs5", level == "housing")
# 
# # Write out data dicts for all vars, person and housing vars:
# write_csv(pums_vars_acs5, "data_dicts_ACS_PUMS/pums_vars_acs5.csv")
# write_csv(pums_vars_acs5_person, "data_dicts_ACS_PUMS/pums_vars_acs5_person.csv")
# write_csv(pums_vars_acs5_housing, "data_dicts_ACS_PUMS/pums_vars_acs5_housing.csv")
# 
# Read in data dicts from person and housing level data:
pums_vars_acs5 <- read_csv("data_dicts_ACS_PUMS/pums_vars_acs5.csv")
pums_vars_acs5_person <- read_csv("data_dicts_ACS_PUMS/pums_vars_acs5_person.csv")
pums_vars_acs5_housing <- read_csv("data_dicts_ACS_PUMS/pums_vars_acs5_housing.csv")

### 2022 ACS: Needed to scrape from website 
# library(rvest) # package for webscraping
# # Pull data dictionary from 2018-2022 ACS PUMS from website that has the data dict in a html table:
# acs_data_dict_22 <- "https://api.census.gov/data/2022/acs/acs5/pums/variables.html" %>% 
#   read_html() %>%
#   html_element("table") %>% 
#   html_table(convert = TRUE) %>% 
#   janitor::clean_names() 
# 
# # Drop first row- was incorrectly pulled in from footer of table ("525 variables") :
# acs_data_dict_22 <- acs_data_dict_22 %>% filter(name != "525 variables")
# 
# # write to csv called "acs_data_dict_22.csv:
# acs_data_dict_22 %>% write_csv(file = "data_dicts_ACS_PUMS/acs_data_dict_22.csv")

# Read in acs_data_dict_22
pums_vars_acs5_22 <- read_csv("data_dicts_ACS_PUMS/acs_data_dict_22.csv")


################# Setup file paths ----
# Set up all file paths:
# file path for all raw data:
data_fp <- here('data')
# list.files(data_fp)

### IMPORTS filepaths 
# file path for 2021 5-year ACS PUMS Data:
acs_2021_fp <- here(data_fp, '2017_2021_ACS_PUMS')
# list.files(acs_2021_fp) 

# file path for 2021 person level data
person_2021_fp <- here(acs_2021_fp, "csv_pca", "psam_p06.csv")

# file path for 2021 household level data
hh_2021_fp <- here(acs_2021_fp, "csv_hca", "psam_h06.csv")

# Set up file path for 2022 5-year ACS PUMS Data:
acs_2022_fp <- here(data_fp, '2018_2022_ACS_PUMS')
# list.files(acs_2022_fp)

# file path for 2022 person level data
person_2022_fp <- here(acs_2022_fp, "csv_pca", "psam_p06.csv")

# file path for 2022 household level data
hh_2022_fp <- here(acs_2022_fp, "csv_hca", "psam_h06.csv")

### CLEAN DATA filepaths
# File paths and directories for clean data- 
# Creates a new folder called "clean_data" if it doesn't already exist in working directory:
if (!dir.exists("clean_data")) {dir.create("clean_data")}
# file path for clean_data
clean_data_fp <- here("clean_data")
# list.files(clean_data_fp)

# Clean 21 data
# Creates a new folder called "acs_data_21" (if it doesn't already exist in working directory)- this will be where the clean data for the 2021 ACS will be stored:
if (!dir.exists(here(clean_data_fp, "acs_data_21"))) {dir.create(here(clean_data_fp, "acs_data_21"))}
# file path for clean_data acs_data_21
acs_data_21_fp <- here(clean_data_fp, "acs_data_21")

# Clean 22 data
# Creates a new folder called "acs_data_22" (if it doesn't already exist in working directory)- this will be where the clean data for the 2022 ACS will be stored:
if (!dir.exists(here(clean_data_fp, 'acs_data_22'))) {dir.create(here(clean_data_fp, 'acs_data_22'))}
# file path for clean_data acs_data_22
acs_data_22_fp <- here(clean_data_fp, "acs_data_22")

# Clean ACS API data
# Creates a new folder called "acs_api" (if it doesn't already exist in working directory)- this will be where the clean data for API datawill be stored:
if (!dir.exists(here(clean_data_fp, 'acs_api'))) {dir.create(here(clean_data_fp, 'acs_api'))}
# file path for clean_data acs_data_22
acs_api_fp <- here(clean_data_fp, "acs_api")

### OUTPUTS filepaths
# output folder
# Creates a new folder called "output" (if it doesn't already exist in working directory)- this will be where the outputs from the R script will be stored:
if (!dir.exists(here('output'))) {dir.create(here('output'))}
# file path for clean_data acs_data_22
output_fp <- here("output")

# Creates a new folder called "acs_api" (if it doesn't already exist in working directory)- this will be where the individual tables for 
# the tabbed output from the R script will be stored as separate .csv's:
if (!dir.exists(here(output_fp, 'tables'))) {dir.create(here(output_fp, 'tables'))}
# file path for clean_data acs_data_22
tables_fp <- here(output_fp, 'tables')

```

# Load and Clean data from US Census American Community Survey (ACS) Public Use Microdata Sample (PUMS) File Transfer Protocol (FTP) site:

- Both 5 year estimates from 2017-2021 and 2018-2022 ACS data

### 2017-2021 ACS data from US Census ACS PUMS FTP- Load and Clean raw data:

```{r ACS 2021 FTP data}
# Total list of vars to get from ACS PUMS HHT
vars_list_pums <- c("SERIALNO", "PUMA", "ST", "SPORDER", "RELSHIPP", "PWGTP", "WGTP", "SEX", "AGEP", "HHT", "HHT2", "HISP",
                    "RAC1P", "POVPIP", "NATIVITY", "DIS", "DDRS", "DEAR", "DEYE", "DOUT", "DPHY", "DREM", "SCHL", "ESR", "JWMNP",
                    "JWTRNS", "TEN","KIT", "PLM", "WAGP", "WKHP", "ADJINC","HINCP", "VEH","RMSP", "NP", "GRPIP", "OCPIP", "POVPIP", "HICOV")

### Housing level data raw:
# Variables to pull out of raw housing data:
housing_vars_list <- c("SERIALNO", "PUMA", "ST","WGTP", "HHT", "HHT2", "TEN", "KIT", "PLM", "ADJINC", "HINCP", "VEH", "RMSP", "NP", "GRPIP", "OCPIP")

# Read in the housing level data, select only vars from housing_vars_list, convert to tibble:
housing_data <- fread(here(hh_2021_fp), select = housing_vars_list) %>% as_tibble()

### Person level data raw:
# Variables to pull out of raw housing data:
person_vars_list <- c("SERIALNO", "ST", "PUMA", "SPORDER", "RELSHIPP", "PWGTP", "SEX", "AGEP", "HISP", "RAC1P", "ENG", "NATIVITY",
                      "DIS", "DDRS", "DEAR", "DEYE", "DOUT", "DPHY", "DREM", "SCHL", "ESR", "JWMNP", "JWTRNS", "WAGP", "WKHP", "ADJINC", "POVPIP", "HICOV")
# Set up type list for read_csv:

# Read in the person level data:
person_data <- fread(here(person_2021_fp), select = person_vars_list) %>% as_tibble()

# # Merge the person level data and the housing level data- using the variable `SERIALNO`; left_join on person_data- to only keep data in person-level data:
merged_data <- person_data %>% left_join(., housing_data, by = c("SERIALNO", "ST", "PUMA", "ADJINC"))

# Write out to .csv for the raw data from ACS Data call to folder named "clean_data/acs_data_21": 1826332 obs. with 40 variables
write_csv(merged_data, here(acs_data_21_fp, "merged_acs_data.csv"))

# SCAG County list- need to convert PUMA codes to county and then filter whole raw ACS PUMS data set to only these counties:
scag_county_list <- c("Imperial",
                      "Los Angeles",
                      "Orange",
                      "Riverside",
                      "San Bernardino",
                      "Ventura")

# Mutate/case_when to replicate SAS code above for creating "county" var-
# Create couny variable with SCAG counties and filter to only those rows in SCAG Counties using scag_county_list from above:
merged_data_scag <- merged_data %>% mutate(county = case_when(PUMA == 2500 ~ "Imperial", # 25 prefix
                                                              PUMA %in% (3701:3799) ~ "Los Angeles", # 37 prefix
                                                              PUMA %in% (5901:5999) ~ "Orange", # 59 prefix
                                                              PUMA %in% (6501:6599) ~ "Riverside", # 65 prefix
                                                              PUMA %in% (7101:7199) ~ "San Bernardino", # 71 prefix
                                                              PUMA %in% (11101:11199) ~ "Ventura" # 111 prefix
                                                              )) %>%
                                          filter(county %in% scag_county_list) %>%
                                          select(SERIALNO, ST,PUMA,county, everything())

# Write out to .csv for the raw data from ACS Data call to folder named "clean_data/acs_data_21": 879241 obs. (same as API call) with 34 variables
write_csv(merged_data_scag, here(acs_data_21_fp, "merged_acs_data_scag.csv"))

# check variables from the merged_data using str() and summary():
str(merged_data)
#
# Remove all large files if no longer needed:
rm(housing_data, person_data, merged_data_scag, merged_data)

```


### 2018-2022 ACS data from US Census ACS PUMS FTP- Load and Clean raw data:

```{r ACS 2022 FTP data}
# Total list of vars to get from ACS PUMS 22- change from 21 is PUMA is in 2010 and 2020 census columns: "PUMA10" and "PUMA20"
vars_list_pums_22 <- c("SERIALNO", "PUMA10", "PUMA20", "ST", "SPORDER", "RELSHIPP", "PWGTP", "WGTP", "SEX", "AGEP", "HHT", "HHT2", "HISP",
                    "RAC1P", "POVPIP", "NATIVITY", "DIS", "DDRS", "DEAR", "DEYE", "DOUT", "DPHY", "DREM", "SCHL", "ESR", "JWMNP", "JWTRNS",
                    "TEN","KIT", "PLM", "WAGP", "WKHP", "ADJINC","HINCP", "VEH","RMSP", "NP", "GRPIP", "OCPIP", "POVPIP", "HICOV")

### Housing level data raw:
# Variables to pull out of raw housing data:
housing_vars_list_22 <- c("SERIALNO", "PUMA10", "PUMA20", "ST","WGTP", "HHT", "HHT2", "TEN", "KIT", "PLM", "ADJINC", "HINCP", "VEH", "RMSP", "NP", "GRPIP", "OCPIP")

# Read in the housing level data, select only vars from housing_vars_list, convert to tibble:
housing_data_22 <- fread(here(hh_2022_fp), select = housing_vars_list_22) %>% as_tibble()

### Person level data raw:
# Variables to pull out of raw housing data:
person_vars_list_22 <- c("SERIALNO", "ST", "PUMA10", "PUMA20", "SPORDER", "RELSHIPP", "PWGTP", "SEX", "AGEP", "HISP", "RAC1P", "ENG",
                      "NATIVITY", "DIS", "DDRS", "DEAR", "DEYE", "DOUT", "DPHY", "DREM", "SCHL", "ESR", "JWMNP", "JWTRNS", "WAGP", "WKHP", "ADJINC", "POVPIP", "HICOV")
# Set up type list for read_csv:

# Read in the person level data:
person_data_22 <- fread(here(person_2022_fp), select = person_vars_list_22) %>% as_tibble()

# # Merge the person level data and the housing level data- using the variable `SERIALNO`; left_join on person_data- to only keep data in person-level data:
merged_data_22 <- person_data_22 %>% left_join(., housing_data_22, by = c("SERIALNO", "ST", "PUMA10", "PUMA20", "ADJINC"))

# Create single PUMA code that merges the columns "PUMA10" and "PUMA20", use PUMA10 and if -9 then take in PUMA20 to replace:
merged_data_22 <- merged_data_22 %>% mutate(PUMA = case_when(PUMA10 == -9 ~ PUMA20,
                                                                     TRUE ~ PUMA10))

# Write out to .csv for the raw data from ACS Data call to folder named "clean_data/acs_data_22": 1839928 obs. with 31 variables
# write_csv(merged_data_22, here(acs_data_22_fp, "merged_acs_22.csv"))

# SCAG County list- need to convert PUMA codes to county and then filter whole raw ACS PUMS data set to only these counties:
scag_county_list <- c("Imperial",
                      "Los Angeles",
                      "Orange",
                      "Riverside",
                      "San Bernardino",
                      "Ventura")

# Mutate/case_when to replicate SAS code above for creating "county" var-
# Create couny variable with SCAG counties and filter to only those rows in SCAG Counties using scag_county_list from above:
merged_data_22_scag <- merged_data_22 %>% mutate(county = case_when(PUMA == 2500 ~ "Imperial", # 25 prefix
                                                                    PUMA %in% (3701:3799) ~ "Los Angeles", # 37 prefix
                                                                    PUMA %in% (5901:5999) ~ "Orange", # 59 prefix
                                                                    PUMA %in% (6501:6599) ~ "Riverside", # 65 prefix
                                                                    PUMA %in% (7101:7199) ~ "San Bernardino", # 71 prefix
                                                                    PUMA %in% (11101:11199) ~ "Ventura" # 111 prefix
                                                                    )) %>%
                                          filter(county %in% scag_county_list) %>%
                                          select(SERIALNO, ST,PUMA,county, everything())

# Write out to .csv for the raw data from ACS Data call to folder named "clean_data/acs_data_22":  881207 obs.  with 34 variables
# write_csv(merged_data_22_scag, here(acs_data_22_fp, "merged_acs_22_scag.csv"))

# Read in merged_data_22_scag from  here(acs_data_22_fp, "merged_acs_22_scag.csv")
merged_data_22_scag <- read_csv(here(acs_data_22_fp, "merged_acs_22_scag.csv"))

# check variables from the merged_data_22_scag using str() and summary():
# str(merged_data_22_scag)
# 
# # Remove all large files if no longer needed:
# rm(housing_data_22, person_data_22, merged_data_22_scag, merged_data_22)

```


--- 


# Data Recoding: 

## SCAG Data Recoding variables for use in ACS PUMS Analysis:

```{r read recode SCAG data}
### Read in dataset -----

# 2017-2021 ACS PUMS merged data
# If you want to use 2017-2021 ACS PUMS merged data use the next line otherwise comment out/don't run the next line and go the next line:
# Read in merged ACS data SCAG from 2017-2021:
ca_pums_scag <- read_csv(here(acs_data_21_fp, "merged_acs_data_scag.csv"), show_col_types = FALSE)

# 2018-2022 ACS PUMS merged data
# Un-comment the next line (and comment out the above line)if you want to use the merged 2018-2022 ACS PUMS data file
# Read in merged ACS data SCAG from 2018-2022:
# ca_pums_scag <- read_csv(here(acs_data_22_fp, "merged_acs_22_scag.csv"), show_col_types = FALSE)

### Recode/Create New Variables for analysis -----
# Code county as a factor variable:
ca_pums_scag <- ca_pums_scag %>% mutate(county = factor(county, levels = c("Imperial", "Los Angeles", "Orange", "Riverside", "San Bernardino", "Ventura")))

# Race and Ethnicity: named var "race" for brevity:
# Create "race" var based on the following conditions for 6 total categories, and convert to factor: 
# If HISP is NOT equal to 1, then  "Hispanic/Latino"
# For the rest- if HISP is equal to 1 and
# If RAC1P = 1 "White", If RAC1P = 2 "Black", If RAC1P = 6 or 7 "Asian/Pacific Islander", If If RAC1P = 3,4 or 5  "Native American", If RAC1P = 8 or 9 "Multiracial/Other":
ca_pums_scag <- ca_pums_scag %>% mutate(race = factor(case_when(HISP != 1  ~ "Hispanic/Latino",
                                                         HISP == 1 & RAC1P == 1 ~ "White", 
                                                         HISP == 1 & RAC1P == 2 ~ "Black", 
                                                         HISP == 1 & RAC1P %in% c(6,7) ~ "Asian/Pacific Islander", 
                                                         HISP == 1 & RAC1P %in% c(3:5) ~ "Native American", 
                                                         HISP == 1 & RAC1P %in% c(8,9) ~ "Multiracial/Other"
                                                         ), levels = c("Asian/Pacific Islander", "Black", "Hispanic/Latino", "Multiracial/Other", "Native American", "White"))
                                        ) 

# Age Categories: named var "age_3_cat"
# Create "age_3_cat" var based on the following conditions for 3 total categories, and convert to factor: 
# If AGEP < 18 "<18 years", If AGEP is greater than or equal to 18 and less than or equal to 64 "18 - 64 years", If AGEP > 64 ~ "65+ years"
ca_pums_scag <- ca_pums_scag %>% mutate(age_3_cat = factor(case_when(AGEP < 18  ~ "<18 years",
                                                                     AGEP %in% c(18:64) ~ "18 - 64 years",
                                                                     AGEP > 64 ~ "65+ years"
                                                                     ), levels = c("<18 years", "18 - 64 years","65+ years"))
                                        ) 

# Education Categories: named var "edu"
# Create "edu" var based on the following conditions for 6 total categories, and convert to factor: 
# If SCHL is greater than or equal to 1 and less than or equal 15) "Less than HS Diploma", If SCHL is equal to 16 or 17 "HS Diploma", If SCHL is equal to 18 or 19 "Some College", 
# If SCHL equal to 20 "AA Degree", If SCHL equal to 21 "BA degree", If SCHL equal to 22, 23 or 24 "MA degree or higher":
ca_pums_scag <- ca_pums_scag %>% mutate(edu = factor(case_when(SCHL %in% c(1:15)  ~ "Less than HS Diploma",
                                                               SCHL %in% c(16:17) ~ "HS Diploma",
                                                               SCHL %in% c(18:19) ~ "Some College",
                                                               SCHL == 20 ~ "AA Degree",
                                                               SCHL == 21 ~ "BA degree",
                                                               SCHL %in% c(22:24) ~ "MA degree or higher"
                                                               ), 
                                                     levels = c("Less than HS Diploma", "HS Diploma", "Some College", "AA Degree", "BA degree", "MA degree or higher"))
                                        )

# Homeownership: named var "own_home"
# Create "own_home" var based on the following conditions for 2 total categories, and convert to factor: 
# If TEN is in (1 2) then "Homeowner"; If TEN in (3 4) then "Non-Homeowner";
ca_pums_scag <- ca_pums_scag %>% mutate(own_home = factor(case_when(TEN %in% c(1:2) ~ "Homeowner",
                                                                    TEN %in% c(3:4) ~ "Non-Homeowner"), 
                                                          levels = c("Homeowner", "Non-Homeowner"))
                                        )


# Means of transportation to work for Workers who Commute by Walk, Bike, or Public Transit: named var "walk_bike_public_transport":
# Create "walk_bike_public_transport" var based on the following conditions for 2 total categories, and convert to factor: 
# If JWTRNS is eqaul to any of the following 2,3,4,5,9, or 10 then "Walk/Bike/Public"; otherwise "Other Transport":
ca_pums_scag <- ca_pums_scag %>% mutate(walk_bike_public_transport = factor(case_when(JWTRNS %in% c(2:5,9,10)  ~ "Walk/Bike/Public",
                                                         TRUE ~ "Other Transport"), levels = c("Walk/Bike/Public", "Other Transport"))
                                                         ) 
# Means of transportation to work: named var "all_transport"- Public, Private or Other
# Create "all_transport" var based on the following conditions for 3 total categories, and convert to factor: 
#  Workers who Commute by bus, rail, taxi, or ferry: coded level "Public": JWTRNS %in% c(2:7)
#  Workers who Commute by Car or Motorcycle: coded level "Private": JWTRNS %in% c(1,8)
#  Workers who Commute by Walk, Bike, or Other: coded level "Other": JWTRNS %in% c(9,10,12)
ca_pums_scag <- ca_pums_scag %>% mutate(all_transport = factor(case_when(JWTRNS %in% c(1,8) ~ "Private",
                                                                  JWTRNS %in% c(2:7) ~  "Public",
                                                                  JWTRNS %in% c(9,10,12) ~ "Other"
                                                                 ), levels = c("Other", "Public","Private"))
                                        ) 


# Housing and Renter Burden: Two variables
# Housing Burden is named "housing_burden" coded "Yes" if 
# Homeowner, owner costs as a percentage of household income (housing cost burden) 30% or more (OCPIP), and 200 below percent poverty line (POVPIP):
# own_home == "Homeowner" & OCPIP >= 30 & POVPIP %in% c(0:199) Then "Yes"; otherwise "No"
# Renter Burden is named "renter_burden" coded "Yes" if 
# Rent a home, Gross rent as a percentage of household income (Rent burden) 30% or more (GRPIP) and 200 below percent poverty line (POVPIP):
# own_home == "Non-Homeowner" & GRPIP >= 30 & POVPIP %in% c(0:199) Then "Yes"; otherwise "No"
# Housing and Rent burdens: variable for homeowner burden named: "housing_burden"; variable for homeowner burden named: "renter_burden"
ca_pums_scag <- ca_pums_scag %>% mutate(housing_burden = factor(case_when(own_home == "Homeowner" & OCPIP >= 30 & POVPIP %in% c(0:199) ~ "Yes",
                                                          TRUE ~ "No",), levels = c("Yes","No")),
                                        renter_burden = factor(case_when(own_home == "Non-Homeowner" & GRPIP >= 30 & POVPIP %in% c(0:199) ~ "Yes",
                                                          TRUE ~ "No",), levels = c("Yes","No"))
                                                         ) 

# Poverty - Create "poverty" var based on the following conditions for 2 total categories, and convert to factor: 
# If POVPIP less than 200 then "Yes"; otherwise "No"
# If poverty == "Yes", the HH income is below 200 percent of the poverty line:
ca_pums_scag <- ca_pums_scag %>% mutate(poverty = factor(case_when(POVPIP %in% c(0:199) ~ "Yes",
                                                                   POVPIP >= 200 ~ "No",), levels = c("Yes","No"))
                                                         )

# No kitchen and no plumbing facilities in home: named var "no_kitchen_plumbing"
# Create "no_kitchen_plumbing" var based on the following conditions for 2 total categories, and convert to factor: 
# If KIT == 2 AND PLM == 2 then "Yes"; KIT == 1 OR PLM == 1 then "No"
ca_pums_scag <- ca_pums_scag %>% mutate(no_kitchen_plumbing = factor(case_when(KIT == 2 & PLM == 2 ~ "Yes",
                                                                   KIT == 1 | PLM == 1 ~ "No",), levels = c("Yes","No"))
                                                         )

### 
# Overcrowding of households: defined as "severe overcrowding is measured as the percentage of householders that have more than 1.5 persons per room"
# named variable: "overcrowded" if "Yes", greater than or equal to 1.5 people per room, "No" otherwise. 
# First define the number of occupants/number or rooms and name "crowd" if RMSP is greater than 0- NP/RMSP = "crowd", if "crowd is greater than or equal to 1.5 then "overcrowded" = "Yes" and "No" if less than 1.5:
ca_pums_scag <- ca_pums_scag %>% mutate(crowd = case_when(RMSP > 0  ~ NP/RMSP,
                                                           TRUE ~ NA),
                                        overcrowded = factor(case_when(crowd >= 1.5  ~ "Yes",
                                                           crowd < 1.5 ~ "No"), levels = c("Yes","No"))
                                                         ) 

## Hourly wage: variable named "hourly_wage"
# First, adjust the wages with the Adjust Income for the correct year named "wage";
# Second, get the weekly wages by dividing by 52 named "weekly_wage", then divide by WKHP (usual hours worked per week)
# Finally: get hourly wage by dividing weekly_wage by WKHP (usual hours worked per week) if  WKHP > 0: 
ca_pums_scag <- ca_pums_scag %>% mutate(wage = case_when(ADJINC == 1117630 ~ WAGP * 1.011189 * 1.10526316, # 2017 Adjust Income
                                                         ADJINC == 1093093 ~ WAGP * 1.013097 * 1.07896160, # 2018 Adjust Income
                                                         ADJINC == 1070512 ~ WAGP * 1.010145 * 1.05976096, # 2019 Adjust Income
                                                         ADJINC == 1053131 ~ WAGP * 1.006149 * 1.04669465, # 2020 Adjust Income
                                                         ADJINC == 1029928 ~ WAGP * 1.029928 * 1.00000000, # 2021 Adjust Income
                                        ),
                        weekly_wage = wage/52,
                        hourly_wage = if_else(WKHP > 0,weekly_wage/WKHP, NA_real_)
                        )

# Unemployment -named variable "unemployed"- if "Yes", unemployed, "No" otherwise. 
# Unemployment -named variable "unemployed"- if ESR (Employment status recode) == 3 then "Yes" (unemployed), or "No" otherwise if ESR does not equal 3 and set as a factor. 
ca_pums_scag <- ca_pums_scag %>% mutate(unemployed = factor(case_when(ESR == 3  ~ "Yes",
                                                           ESR != 3 ~ "No"), levels = c("Yes","No"))
                                                         )
###
# Single Parent Households by gender: Use HHT2 to create new variable named "single_hh"
# If HHT2 == 06	   Female householder, no spouse/partner present, with children of the householder less than 18
# # Then single_hh == "female_hh"
# If HHT2 == 10	   Male householder, no spouse/partner present, with children of the householder less than 18
# Then single_hh == "male_hh"
# Otherwise, single_hh == "cohabit_or_nokids"
ca_pums_scag <- ca_pums_scag %>% mutate(single_hh = factor(case_when(HHT2 == 6  ~ "female_hh",
                                                                     HHT2 == 10  ~ "male_hh",
                                                                     HHT2 %in% c(1:5,7:9,11:12) ~ "cohabit_or_nokids"
                                                                     ), levels = c("female_hh", "male_hh","cohabit_or_nokids"))
                                        )

# Limited English Proficiency: New variable named "lep"
# lep == "limited_english_proficiency" if ENG == 3 | if ENG == 4
# lep == "english_proficient" if ENG == 3 | if ENG == 4
# lep == "<5yos_or_no_eng" if is.na(ENG) or TRUE
ca_pums_scag <- ca_pums_scag %>% mutate(lep = factor(case_when(ENG %in% c(3:4) ~ "limited_english_proficiency",
                                                               ENG %in% c(1:2) ~ "english_proficient",
                                                               TRUE ~ "<5yos_or_no_eng"),
                                                    levels = c("limited_english_proficiency","english_proficient","<5yos_or_no_eng")
                                                    )
                                        )

# Household Income:
# # Create new variable "housing_income" by multiplying HINCP (household income) by ADJINC for correct year:
ca_pums_scag <- ca_pums_scag %>% mutate(housing_income = case_when(ADJINC == 1117630 ~ HINCP * 1.011189 * 1.10526316, # 2017 Adjust Income
                                                                   ADJINC == 1093093 ~ HINCP * 1.013097 * 1.07896160, # 2018 Adjust Income
                                                                   ADJINC == 1070512 ~ HINCP * 1.010145 * 1.05976096, # 2019 Adjust Income
                                                                   ADJINC == 1053131 ~ HINCP * 1.006149 * 1.04669465, # 2020 Adjust Income
                                                                   ADJINC == 1029928 ~ HINCP * 1.029928 * 1.00000000, # 2021 Adjust Income
                                                                  )
                                        ) 

# Set up county and race levels to use to convert each to factors and arrange tables:
# county_levels:
county_levels <-  c("Imperial", "Los Angeles", "Orange", "Riverside", "San Bernardino", "Ventura", "SCAG")

# race_levels:
race_levels <-  c("Asian/Pacific Islander", "Black", "Hispanic/Latino", "Multiracial/Other", "Native American", "White", "All Races")

```

# Analysis and Replication of Tables and Figures for SCAG

## Tables and Figures from Equity Analysis Technical Report- (EA report)

### Figure 5. Workers who Commute by Walk, Bike, or Public Transit by Race and Ethnicity

```{r fig_5}
# Figure 5. Workers who Commute by Walk, Bike, or Public Transit by Race and Ethnicity:
# Use person level weights- PWGTP; walk_bike_public_transport ==  "Walk/Bike/Public"
# Get percentages based on non-home workers- drop all if JWTRNS respond == 11 (use filter not equal to 11 like this (filter(JWTRNS != 11)))
# Use weight_perc_2groups():
# Pass in data filtered to only hh (filter(RELSHIPP == 20)), calculate weighted percentages using hh level weights- "WGTP", for variable "poverty" and filter to "poverty" == "Yes": 
walk_bike_public_scag_table <- ca_pums_scag %>% filter(JWTRNS != 11) %>% 
    weight_perc_2groups(var = "walk_bike_public_transport", weight = "PWGTP", group1 = "county", group2 = "race", filter_value = "Walk/Bike/Public",
                        group1_levels = county_levels, group2_levels = race_levels) %>% rename(walk_bike_public_percentage = percentage)
walk_bike_public_scag_table

# Write out table to .csv in "output/tables" folder and once the file exists remove from current environment all tibbles used to make the final table:
write_csv(walk_bike_public_scag_table, here(tables_fp, "walk_bike_public_scag_table.csv"))
if (file.exists(here(tables_fp, 'walk_bike_public_scag_table.csv'))) {rm(list = ls(pattern = "walk_bike_public"))}
```


### Figure 6. Householders without a Vehicle by Race and Ethnicity

```{r fig_6}
# Figure 6. Householders without a Vehicle by Race and Ethnicity:
# Filter to only housing data(RELSHIPP == 20) and Use household weights- WGTP; sum over VEH == 0; Use weight_perc_2groups():
# Pass in data filtered to only hh (filter(RELSHIPP == 20)), calculate weighted percentages using hh level weights- "WGTP", for variable "VEH" and filter to "VEH" = 0: 
no_veh_scag_table <- ca_pums_scag %>% filter(RELSHIPP == 20) %>% 
    weight_perc_2groups(var = "VEH", weight = "WGTP", group1 = "county", group2 = "race", filter_value = 0,
                        group1_levels = county_levels, group2_levels = race_levels) %>% rename(no_vehicle_percentage = percentage)
no_veh_scag_table

# Write out table to .csv in "output/tables" folder and once the file exists remove from current environment all tibbles used to make the final table:
write_csv(no_veh_scag_table, here(tables_fp, "no_veh_scag_table.csv"))
if (file.exists(here(tables_fp, 'no_veh_scag_table.csv'))) {rm(list = ls(pattern = "no_veh"))}
```

### Figure 7. Workers’ Commute Times (Minutes) by Mode and Race and Ethnicity

```{r fig_7}
# Figure 7. Figure 7. Workers’ Commute Times (Minutes) by Mode and Race and Ethnicity: Use person level weights- PWGTP:
# Grouped by all_transport and race
# Get weighted means based on non-home workers- drop if JWTRNS respond == 11 (use filter not equal to 11 like this (filter(JWTRNS != 11)))
# Get all_transport means by race for all SCAG non-home workers:
scag_race_transport_mean <- ca_pums_scag %>% filter(JWTRNS != 11) %>% select(PWGTP, race, all_transport, JWMNP) %>% drop_na() %>% 
                                         group_by(race, all_transport) %>%
                                         summarize(
                                           mean_transit_times_in_minutes = weighted.mean(JWMNP, PWGTP, na.rm = TRUE) # weighted mean 
                                         ) %>% mutate(county = "SCAG") %>% relocate(county) 


# Get all_transport means for all SCAG non-home workers- Any Transport:
scag_race_any_transport_mean <- ca_pums_scag %>% filter(JWTRNS != 11) %>%  select(PWGTP, race, all_transport, JWMNP) %>% 
                                         group_by(race) %>%
                                         summarize(
                                           mean_transit_times_in_minutes = weighted.mean(JWMNP, PWGTP, na.rm = TRUE) # weighted mean 
                                         ) %>% mutate(county = "SCAG", all_transport = "Any Transportation") %>% select(county, race, all_transport, mean_transit_times_in_minutes)

# Full Join scag_transport_mean and scag_any_transport_mean
scag_race_transport_mean <- full_join(scag_race_transport_mean, scag_race_any_transport_mean)

# Get all_transport means for all SCAG non-home workers:
scag_transport_mean <- ca_pums_scag %>% filter(JWTRNS != 11) %>%  select(PWGTP, all_transport, JWMNP) %>% 
                                         group_by(all_transport) %>%
                                         summarize(
                                           mean_transit_times_in_minutes = weighted.mean(JWMNP, PWGTP, na.rm = TRUE) # weighted mean 
                                         ) %>% mutate(county = "SCAG", race = "All Races") %>% relocate(county) %>% 
                                         select(county, race, all_transport, mean_transit_times_in_minutes)

# Get all_transport means for all SCAG non-home workers- Any Transport:
scag_any_transport_mean <- ca_pums_scag %>% filter(JWTRNS != 11) %>%  select(PWGTP, all_transport, JWMNP) %>% 
                                         summarize(
                                           mean_transit_times_in_minutes = weighted.mean(JWMNP, PWGTP, na.rm = TRUE) # weighted mean 
                                         ) %>% mutate(county = "SCAG", race = "All Races", all_transport = "Any Transportation") %>% 
                                         select(county, race, all_transport, mean_transit_times_in_minutes)

# Full Join scag_transport_mean and scag_any_transport_mean
scag_transport_mean_totals <- full_join(scag_transport_mean, scag_any_transport_mean)

# Full join scag_race_transport_mean and cag_transport_mean_overall to get full totals table for SCAG and by race:
scag_transport_mean <- scag_race_transport_mean %>% full_join(scag_transport_mean_totals)

# Next, do the same as above by broken down by county and join the full county table to scag_race_transport_mean
# By county
# Get all_transport means by race for all SCAG non-home workers:
scag_race_county_transport_mean <- ca_pums_scag %>% filter(JWTRNS != 11) %>% select(PWGTP, race, county, all_transport, JWMNP) %>% drop_na() %>% 
                                         group_by(county, race, all_transport) %>%
                                         summarize(
                                           mean_transit_times_in_minutes = weighted.mean(JWMNP, PWGTP, na.rm = TRUE) # weighted mean 
                                         ) %>% ungroup() %>% complete(county, race, all_transport) %>% relocate(county)  %>% 
                                         mutate(mean_transit_times_in_minutes = replace_na(mean_transit_times_in_minutes,0)) # Replace NA with 0.

# Get all_transport means for all SCAG non-home workers- Any Transport:
scag_race_county_any_transport_mean <- ca_pums_scag %>% filter(JWTRNS != 11) %>%  select(PWGTP, county, race, all_transport, JWMNP) %>% 
                                         group_by(race, county) %>%
                                         summarize(
                                           mean_transit_times_in_minutes = weighted.mean(JWMNP, PWGTP, na.rm = TRUE) # weighted mean 
                                         ) %>% mutate(all_transport = "Any Transportation") %>% 
                                        select(county, race, all_transport, mean_transit_times_in_minutes)

# Get all_transport means by county for all races combined name "All Races" for all SCAG non-home workers:
scag_all_races_county_transport_mean <- ca_pums_scag %>% filter(JWTRNS != 11) %>% select(PWGTP, county, all_transport, JWMNP) %>% drop_na() %>% 
                                         group_by(county, all_transport) %>%
                                         summarize(
                                           mean_transit_times_in_minutes = weighted.mean(JWMNP, PWGTP, na.rm = TRUE) # weighted mean 
                                         ) %>% ungroup() %>% complete(county, all_transport) %>% relocate(county)  %>% 
                                         mutate(race = "All Races", mean_transit_times_in_minutes = replace_na(mean_transit_times_in_minutes,0)) # Replace NA with 0.

# Get all_transport means by county for all races combined name "All Races"  for all SCAG non-home workers- Any Transport:
scag_all_races_county_any_transport_mean <- ca_pums_scag %>% filter(JWTRNS != 11) %>%  select(PWGTP, county, all_transport, JWMNP) %>% 
                                         group_by(county) %>%
                                         summarize(
                                           mean_transit_times_in_minutes = weighted.mean(JWMNP, PWGTP, na.rm = TRUE) # weighted mean 
                                         ) %>% mutate(race = "All Races", all_transport = "Any Transportation") %>% 
                                        select(county, race, all_transport, mean_transit_times_in_minutes)

# Left Join scag_transport_mean and scag_any_transport_mean
scag_race_county_transport_mean <- full_join(scag_race_county_transport_mean, scag_race_county_any_transport_mean) %>% 
                                        full_join(.,scag_all_races_county_transport_mean) %>% 
                                            full_join(.,scag_all_races_county_any_transport_mean)

# Full join scag_race_transport_mean and cag_transport_mean_overall to get full totals table for SCAG and by race:
transport_mean_scag_table <- scag_transport_mean %>% full_join(scag_race_county_transport_mean) %>% ungroup()
# Round all means to 2 digits and arrange the table by county, race, and transportation_type:
transport_mean_scag_table <- transport_mean_scag_table %>% 
                                mutate(across(where(is.numeric), round, 2),
                                       county = factor(county, levels = county_levels),
                                       race = factor(race, levels = race_levels),
                                       all_transport = factor(all_transport, levels = c("Any Transportation","Private","Public", "Other"))) %>%
                                arrange(county, race, all_transport) %>% ungroup() %>% rename(transportation_type = all_transport)
transport_mean_scag_table

# Write out table to .csv in "output/tables" folder and once the file exists remove from current environment all tibbles used to make the final table:
write_csv(transport_mean_scag_table, here(tables_fp, "transport_mean_scag_table.csv"))
if (file.exists(here(tables_fp, 'transport_mean_scag_table.csv'))) {rm(list = ls(pattern = "transport_mean"))}
```

### Figure 19. Renters and Homeowners Experiencing Housing Cost Burden by Race and Ethnicity 

```{r fig_19}
# Figure 19. Renters and Homeowners Experiencing Housing Cost Burden by Race and Ethnicity 
# Filter to only housing data and renters (filter(RELSHIPP == 20, own_home == "Non-Homeowner")) and Use household weights- WGTP, sum if renter_burden == "Yes":
#### Use  weight_perc_2groups() twice, once for own_home == "Non-Homeowner" on variable "renter_burden" for Renters and again with own_home == "Homeowner" on variable "housing_burden" for Homeowners:
# Get renter_burden by using weight_perc_2groups() and add a column called household_type = "Renters":
scag_renter_burden_table <- ca_pums_scag %>% filter(RELSHIPP == 20, own_home == "Non-Homeowner") %>% 
    weight_perc_2groups(var = "renter_burden", weight = "WGTP", group1 = "county", group2 = "race", filter_value = "Yes",
                        group1_levels = county_levels, group2_levels = race_levels) %>% mutate(household_type = "Renters")
scag_renter_burden_table

# Get housing_burden by using weight_perc_2groups() and add a column called household_type = "Homeowners":
scag_housing_burden_table <- ca_pums_scag %>% filter(RELSHIPP == 20, own_home == "Homeowner") %>% 
    weight_perc_2groups(var = "housing_burden", weight = "WGTP", group1 = "county", group2 = "race", filter_value = "Yes",
                        group1_levels = county_levels, group2_levels = race_levels) %>% mutate(household_type = "Homeowners")
scag_housing_burden_table

# Join renters and Homeowners tables, add all complete cases to bring back any NA's in percentage and turn into 0, then re-order columns:
housing_burden_scag_table <- full_join(scag_renter_burden_table, scag_housing_burden_table, by = join_by(county, race, percentage, household_type)) %>% 
                                mutate(household_type = factor(household_type, levels = c("Renters","Homeowners"))) %>% 
                                 complete(household_type, county, race) %>% mutate(percentage = replace_na(percentage, 0)) %>% 
                                    rename(burden_percentage = percentage) %>% 
                                      select(county, race, household_type, burden_percentage) 
housing_burden_scag_table

# Write out table to .csv in "output/tables" folder and once the file exists remove from current environment all tibbles used to make the final table:
write_csv(housing_burden_scag_table, here(tables_fp, "housing_burden_scag_table.csv"))
if (file.exists(here(tables_fp, 'housing_burden_scag_table.csv'))) {
    rm(list = ls(pattern = "renter_burden"))
    rm(list = ls(pattern = "housing_burden"))
}
```

### Figure 20. People Living in Households Without Kitchen and Plumbing Facilities by Race and Ethnicity

```{r fig_20}
# Figure 20. People Living in Households Without Kitchen and Plumbing Facilities by Race and Ethnicity
# Filter to only housing data filter(RELSHIPP == 20) and Use household weights- WGTP: sum if no_kitchen_plumbing == "Yes"
# Get no_kitchen_plumbing percentages by using weight_perc_2groups() and expand to all complete cases of county and race, then convert NA's to 0's:
no_kitchen_plumbing_scag_table <- ca_pums_scag %>% filter(RELSHIPP == 20) %>% 
    weight_perc_2groups(var = "no_kitchen_plumbing", weight = "WGTP", group1 = "county", group2 = "race", filter_value = "Yes",
                        group1_levels = county_levels, group2_levels = race_levels) %>% 
                                 complete(county, race) %>% mutate(percentage = replace_na(percentage, 0)) %>% 
                                    rename(no_kitchen_plumbing_percentage = percentage)
no_kitchen_plumbing_scag_table 

# Write out table to .csv in "output/tables" folder and once the file exists remove from current environment all tibbles used to make the final table:
write_csv(no_kitchen_plumbing_scag_table, here(tables_fp, "no_kitchen_plumbing_scag_table.csv"))
if (file.exists(here(tables_fp, 'no_kitchen_plumbing_scag_table.csv'))) {rm(list = ls(pattern = "no_kitchen_plumbing"))}
```

### Figure 21. Households with Severe Overcrowding by Race and Ethnicity

```{r fig_21}
# Figure 21. Households with Severe Overcrowding by Race and Ethnicity:
# Filter to only housing data (filter(RELSHIPP == 20)) and Use household weights- WGTP, count if "overcrowded" == "Yes":
# Get overcrowded percentages by using weight_perc_2groups(), var = "overcrowded", and filter_value = "Yes":
overcrowded_scag_table <- ca_pums_scag %>% filter(RELSHIPP == 20) %>% 
    weight_perc_2groups(var = "overcrowded", weight = "WGTP", group1 = "county", group2 = "race", filter_value = "Yes",
                        group1_levels = county_levels, group2_levels = race_levels) %>% 
                            rename(overcrowded_percentage = percentage)
overcrowded_scag_table 

# Write out table to .csv in "output/tables" folder and once the file exists remove from current environment all tibbles used to make the final table:
write_csv(overcrowded_scag_table, here(tables_fp, "overcrowded_scag_table.csv"))
if (file.exists(here(tables_fp, 'overcrowded_scag_table.csv'))) {rm(list = ls(pattern = "overcrowded"))}
```

### Figure 22. Homeownership by Race and Ethnicity

```{r fig_22}
# Figure 22. Homeownership by Race and Ethnicity:
# Filter to only housing data (filter(RELSHIPP == 20)) and Use household weights- WGTP, filter "own_home" to "Homeowner":
# Get Homeownership percentages by using weight_perc_2groups():
homeownership_scag_table <- ca_pums_scag %>% filter(RELSHIPP == 20) %>% 
    weight_perc_2groups(var = "own_home", weight = "WGTP", group1 = "county", group2 = "race", filter_value = "Homeowner",
                        group1_levels = county_levels, group2_levels = race_levels) %>% 
                            rename(homeownership_percentage = percentage)
homeownership_scag_table 

# Write out table to .csv in "output/tables" folder and once the file exists remove from current environment all tibbles used to make the final table:
write_csv(homeownership_scag_table, here(tables_fp, "homeownership_scag_table.csv"))
if (file.exists(here(tables_fp, 'homeownership_scag_table.csv'))) {rm(list = ls(pattern = "homeownership"))}
```

### Figure 28. People without Health Insurance by Race and Ethnicity

```{r fig_28}
# Figure 28. People without Health Insurance by Race and Ethnicity:
# Use person level weights- PWGTP; sum over those without health insurance coverage HICOV ==  2
# Get People without Health Insurance percentages by using weight_perc_2groups():
no_hicov_scag_table <- ca_pums_scag  %>% 
    weight_perc_2groups(var = "HICOV", weight = "PWGTP", group1 = "county", group2 = "race", filter_value = 2,
                        group1_levels = county_levels, group2_levels = race_levels) %>% 
                            rename(no_health_insurance_percentage = percentage)
no_hicov_scag_table 

# Write out table to .csv in "output/tables" folder and once the file exists remove from current environment all tibbles used to make the final table:
write_csv(no_hicov_scag_table, here(tables_fp, "no_hicov_scag_table.csv"))
if (file.exists(here(tables_fp, 'no_hicov_scag_table.csv'))) {rm(list = ls(pattern = "no_hicov"))}
```

### Figure 39. Median Hourly Wage by Race and Ethnicity

```{r fig_39}
# Figure 39. Median Hourly Wage by Race and Ethnicity
# Use person level weights- PWGTP; Filter to age 25-64 and a civilian worker; if AGEP greater than or equal to 25 and AGEP less than or equal to 64 AND if ESR in (1 2); *Civilian worker;
# Then use weighted.median of hourly_wage

# Get Median Hourly Wage by race for all SCAG:
scag_race_med_hr_wage <- ca_pums_scag %>% filter(ESR %in% c(1:2) & AGEP %in% c(25:64)) %>% 
                                       select(PWGTP, race, hourly_wage)  %>% 
                                       group_by(race) %>% 
                                       summarize(
                                         med_hr_wage = round(weighted.median(hourly_wage, PWGTP, na.rm = TRUE),2)
                                       ) %>% mutate(county = "SCAG") %>% select(county, race, med_hr_wage) 

# Get Median Hourly Wage by race for all by race and county:
scag_county_race_med_hr_wage <- ca_pums_scag %>% filter(ESR %in% c(1:2) & AGEP %in% c(25:64)) %>% 
                                       select(PWGTP, county, race, hourly_wage) %>% 
                                         group_by(county, race) %>% 
                                         summarize(
                                         med_hr_wage = round(weighted.median(hourly_wage, PWGTP, na.rm = TRUE),2)
                                         ) %>% select(county, race, med_hr_wage) 

# Get Median Hourly Wage by county for all SCAG:
scag_county_total_med_hr_wage <- ca_pums_scag %>% filter(ESR %in% c(1:2) & AGEP %in% c(25:64)) %>% 
                                       select(PWGTP, county, race, hourly_wage) %>%  
                                               group_by(county) %>% 
                                               summarize(
                                           med_hr_wage = round(weighted.median(hourly_wage, PWGTP, na.rm = TRUE),2)
                                         ) %>% select(county, med_hr_wage) %>% mutate(race = "All Races")
# Get Median Hourly Wage for all SCAG:
scag_total_med_hr_wage <- ca_pums_scag %>% filter(ESR %in% c(1:2) & AGEP %in% c(25:64)) %>% 
                                       select(PWGTP, race, hourly_wage) %>%  
                                         summarize(
                                           med_hr_wage = round(weighted.median(hourly_wage, PWGTP, na.rm = TRUE),2)
                                           ) %>% mutate(county = "SCAG", race = "All Races") %>% select(county, race, med_hr_wage)

# Full join all scag_total tables:
scag_total_med_hr_wage_table <- full_join(scag_county_total_med_hr_wage,scag_total_med_hr_wage)

# Full join all scag_race tables, then left join scag_total_no_veh_table by county:
med_hr_wage_scag_table <- full_join(scag_county_race_med_hr_wage,scag_race_med_hr_wage) %>% full_join(.,scag_total_med_hr_wage_table) %>% 
                            mutate(county = factor(county, levels = county_levels),
                                   race = factor(race, levels = race_levels)) %>% 
                            arrange(county, race)

med_hr_wage_scag_table

# Write out table to .csv in "output/tables" folder and once the file exists remove from current environment all tibbles used to make the final table:
write_csv(med_hr_wage_scag_table, here(tables_fp, "med_hr_wage_scag_table.csv"))
if (file.exists(here(tables_fp, 'med_hr_wage_scag_table.csv'))) {rm(list = ls(pattern = "med_hr_wage"))}
```

### Figure 40. Unemployment by Race and Ethnicity

```{r fig_40}
# Figure 40. Unemployment by Race and Ethnicity
# Use person level weights- PWGTP; total_labor (denominator) is if ESR != 6
# Get unemployed percentage by race for all SCAG:
scag_race_unemployed <- ca_pums_scag %>% select(PWGTP, race, unemployed,ESR) %>% drop_na(unemployed) %>% 
                                       group_by(race) %>% 
                                       summarize(
                                           total_labor = sum(PWGTP[ESR != 6]), # excludes not in labor force from ESR variable
                                           unemployed_sum = sum(PWGTP[unemployed == "Yes"]),  
                                           unemployed_prop = unemployed_sum / total_labor, # divide by total_labor for proportion
                                           unemployed_perc = round(unemployed_prop*100, 2)
                                         )  %>% mutate(county = "SCAG") %>% select(county, race, unemployed_perc) 

# Get unemployed percentage by all by race and county:
scag_county_race_unemployed <- ca_pums_scag %>%  select(PWGTP, county, race, unemployed,ESR) %>% drop_na(unemployed) %>%
                                         group_by(county, race) %>%
                                         summarize(
                                           total_labor = sum(PWGTP[ESR != 6]), # excludes not in labor force from ESR variable
                                           unemployed_sum = sum(PWGTP[unemployed == "Yes"]),
                                           unemployed_prop = unemployed_sum / total_labor, # divide by total_labor for proportion
                                           unemployed_perc = round(unemployed_prop*100, 2)
                                         ) %>% select(county, race, unemployed_perc) 


# Get unemployed percentage by county for all SCAG:
scag_county_total_unemployed <- ca_pums_scag %>% select(PWGTP, county, unemployed,ESR) %>% drop_na(unemployed) %>%
                                               group_by(county) %>%
                                               summarize(
                                                       total_labor = sum(PWGTP[ESR != 6]), # excludes not in labor force from ESR variable
                                                       unemployed_sum = sum(PWGTP[unemployed == "Yes"]),
                                                       unemployed_prop = unemployed_sum / total_labor, # divide by total_labor for proportion
                                                       unemployed_perc = round(unemployed_prop*100, 2)
                                                     ) %>% mutate(race = "All Races") %>% select(county, race, unemployed_perc) 

# # Get Median Hourly Wage for all SCAG:
scag_total_unemployed <- ca_pums_scag %>%  select(PWGTP, county, unemployed,ESR) %>% drop_na(unemployed) %>%
                                               summarize(
                                                       total_labor = sum(PWGTP[ESR != 6]), # excludes not in labor force from ESR variable
                                                       unemployed_sum = sum(PWGTP[unemployed == "Yes"]),
                                                       unemployed_prop = unemployed_sum / total_labor, # divide by total_labor for proportion
                                                       unemployed_perc = round(unemployed_prop*100, 2)
                                                     ) %>% mutate(county = "SCAG", race = "All Races") %>% select(county, race, unemployed_perc) 

# Full join all scag_total tables:
scag_total_unemployed_table <- full_join(scag_county_total_unemployed,scag_total_unemployed)

# Full join all scag_race tables, then left join scag_total_no_veh_table by county:
unemployed_scag_table <- full_join(scag_county_race_unemployed,scag_race_unemployed) %>% full_join(.,scag_total_unemployed_table) %>% 
                            mutate(county = factor(county, levels = county_levels),
                                   race = factor(race, levels = race_levels)) %>% 
                            arrange(county, race) %>% rename(unemployed_percentage = unemployed_perc)
unemployed_scag_table

# Write out table to .csv in "output/tables" folder and once the file exists remove from current environment all tibbles used to make the final table:
write_csv(unemployed_scag_table, here(tables_fp, "unemployed_scag_table.csv"))
if (file.exists(here(tables_fp, 'unemployed_scag_table.csv'))) {rm(list = ls(pattern = "unemployed"))}
```

### Figure 41. Working Poor by Race and Ethnicity

```{r fig_41}
# Figure 41. Working Poor by Race and Ethnicity
# Use person level weights- PWGTP; Filter to age 25-64 and a civilian worker; if AGEP greater than or equal to 25 and AGEP less than or equal to 64 AND if ESR in (1 2); *Civilian worker;
# if poverty == "Yes"- this is if the respondent is less than 200 percent below the poverty line
# Get working_poor percentages by using weight_perc_2groups(), use person level weights and filter to civilian workers aged 25-64:
working_poor_scag_table <- ca_pums_scag %>% filter(ESR %in% c(1:2) & AGEP %in% c(25:64)) %>% drop_na(poverty) %>% 
    weight_perc_2groups(var = "poverty", weight = "PWGTP", group1 = "county", group2 = "race", filter_value = "Yes",
                        group1_levels = county_levels, group2_levels = race_levels) %>% 
                            rename(working_poor_percentage = percentage)
working_poor_scag_table 

# Write out table to .csv in "output/tables" folder and once the file exists remove from current environment all tibbles used to make the final table:
write_csv(working_poor_scag_table, here(tables_fp, "working_poor_scag_table.csv"))
if (file.exists(here(tables_fp, 'working_poor_scag_table.csv'))) {rm(list = ls(pattern = "working_poor"))}
```

## Tables and Figures from Racial Equity Baseline Conditions Report (REBCR)

### Total Population by County and SCAG

```{r total_pop}
# Total Population by County and SCAG:
# Use person level weights- PWGTP; sum over everyone
# Get Total Population for all SCAG:
scag_total_pop <- ca_pums_scag %>% select(PWGTP) %>% summarize(total_population = sum(PWGTP)) %>% 
                                    mutate(county = "SCAG") %>% select(county, total_population)
# Get Total Population by county:
scag_county_total_pop <- ca_pums_scag %>% select(PWGTP, county) %>%  
                                group_by(county) %>% summarize(total_population = sum(PWGTP)) %>% select(county, total_population)
# Full join all scag_total tables:
total_pop_scag_table <- full_join(scag_county_total_pop, scag_total_pop, by = join_by(county, total_population)) 
total_pop_scag_table

# Write out table to .csv in "output/tables" folder and once the file exists remove from current environment all tibbles used to make the final table:
write_csv(total_pop_scag_table, here(tables_fp, "total_pop_scag_table.csv"))
if (file.exists(here(tables_fp, 'total_pop_scag_table.csv'))) {rm(list = ls(pattern = "total_pop"))}
```


### Race/Ethnicity Distribution (%) by County and SCAG Region

```{r race_ethnicity}
# Race/Ethnicity Distribution (%) by County and SCAG Region:
# Use person level weights- PWGTP; Percentages of race by county and SCAG
# race = c("Asian/Pacific Islander", "Black", "Hispanic/Latino", "Multiracial/Other", "Native American", "White")
# Use weight_perc_table():
# Pass in data and calculate weighted percentages using person level weights- "PWGTP", for variable "race", set county to factor, arrange by "race" and "county", 
# then rename "percentage" to "race_percentage", move county to first column: 
# 
race_perc_scag_table <- ca_pums_scag %>% weight_perc_table(var = "race", weight = "PWGTP", group = "county") %>% 
                                            mutate(county = factor(county, levels = county_levels)) %>% 
                                            arrange(county, race) %>% rename(race_percentage = percentage) %>% 
                                            select(county, everything())
race_perc_scag_table
# Write out table to .csv in "output/tables" folder and once the file exists remove from current environment all tibbles used to make the final table:
write_csv(race_perc_scag_table, here(tables_fp, "race_perc_scag_table.csv"))
if (file.exists(here(tables_fp, 'race_perc_scag_table.csv'))) {rm(list = ls(pattern = "race_perc"))}
```


### Age Distribution (%) by County and SCAG Region

```{r age_dist}
# Age Distribution (%) by County and SCAG Region:
# Use person level weights- PWGTP; Percentages of age categories by county and SCAG
# Age Categories- Use "age_3_cat" to get percentages of each category for each SCAG County and the whole SCAG Region: 
# Use weight_perc_table():
# Function to return full table of weighted percentages by group and filtered to one value of a variable: weight_perc_table()
# df = dataframe of all data, var = variable to sum over,  weight = weights, group = grouping variable, filter_value = value of a variable to filter output to.
# has and if statement to drop filter_value if NULL, which it is by default
# 
# Pass in data and calculate weighted percentages using person level weights- "PWGTP", for variable "age_3_cat", set county to factor, arrange by "age_3_cat" and "county", 
# then rename "age_3_cat" to "age_categories": 
age_perc_scag_table <- ca_pums_scag %>% weight_perc_table(var = "age_3_cat", weight = "PWGTP", group = "county") %>% 
                                            mutate(county = factor(county, levels = county_levels)) %>% 
                                            arrange(age_3_cat, county) %>% rename(age_categories = age_3_cat) 
age_perc_scag_table

# Write out table to .csv in "output/tables" folder and once the file exists remove from current environment all tibbles used to make the final table:
write_csv(age_perc_scag_table, here(tables_fp, "age_perc_scag_table.csv"))
if (file.exists(here(tables_fp, 'age_perc_scag_table.csv'))) {rm(list = ls(pattern = "age_perc"))}
```


### Single Parent Households (%) by Gender of Head of Household and then by County and SCAG Region

```{r singe_parent}
### 
# Single Parent Households (%) by Gender of Head of Household and then by County and SCAG Region:
# Use household level weights- WGTP: Percentages of Single Parent Household categories by gender of Head of Household by county and SCAG
# Use weight_perc_table():
# Pass in data and calculate weighted percentages using hh level weights- "WGTP", for variable "single_hh", set county to factor, arrange by "single_hh" and "county", 
# then rename columns: 
single_hh_scag_table <- ca_pums_scag %>% weight_perc_table(var = "single_hh", weight = "WGTP", group = "county") %>% 
                                            filter(single_hh %in% c("female_hh","male_hh")) %>% 
                                            mutate(county = factor(county, levels = county_levels)) %>% 
                                            arrange(single_hh, county) %>% rename(gender_head_of_household = single_hh, single_parent_hh_percentage = percentage) 
single_hh_scag_table

# Write out table to .csv in "output/tables" folder and once the file exists remove from current environment all tibbles used to make the final table:
write_csv(single_hh_scag_table, here(tables_fp, "single_hh_scag_table.csv"))
if (file.exists(here(tables_fp, 'single_hh_scag_table.csv'))) {rm(list = ls(pattern = "single_hh"))}
```

### National Origin (% Foreign born) by County and SCAG Region

```{r natl_origin}
# National Origin (% Foreign born) by County and SCAG Region
# Use person level weights- PWGTP: Percentages of Foreign born by county and SCAG: sum over if NATIVITY == 2 

# Use weight_perc_table():
# Pass in data and calculate weighted percentages using person level weights- "PWGTP", for variable "NATIVITY", filter_value = 2, set county to factor, arrange by "age_3_cat" and "county", 
# then rename "percentage" to "foreign_born_percentage": 
natl_origin_scag_table <- ca_pums_scag %>% weight_perc_table(var = "NATIVITY", weight = "PWGTP", group = "county", filter_value = 2) %>% 
                                            mutate(county = factor(county, levels = county_levels)) %>% 
                                            rename(foreign_born_percentage = percentage) 
natl_origin_scag_table

# Write out table to .csv in "output/tables" folder and once the file exists remove from current environment all tibbles used to make the final table:
write_csv(natl_origin_scag_table, here(tables_fp, "natl_origin_scag_table.csv"))
if (file.exists(here(tables_fp, 'natl_origin_scag_table.csv'))) {rm(list = ls(pattern = "natl_origin"))}
```


### Limited English Proficiency (%) by County and SCAG Region

```{r LEP}
# Limited English Proficiency (LEP %) by County and SCAG Region
# Use person level weights- PWGTP:Percentages of LEP by county and SCAG
# Use weight_perc_table():
# Pass in data and calculate weighted percentages using person level weights- "PWGTP", for variable "lep", filter_value = "limited_english_proficiency", set county to factor,  
# then rename "percentage" to "limited_english_proficiency_percentage": 
lep_scag_table <- ca_pums_scag %>% weight_perc_table(var = "lep", weight = "PWGTP", group = "county", filter_value = "limited_english_proficiency") %>% 
                                            mutate(county = factor(county, levels = county_levels)) %>% 
                                            rename(limited_english_proficiency_percentage = percentage) 
lep_scag_table

# Write out table to .csv in "output/tables" folder and once the file exists remove from current environment all tibbles used to make the final table:
write_csv(lep_scag_table, here(tables_fp, "lep_scag_table.csv"))
if (file.exists(here(tables_fp, 'lep_scag_table.csv'))) {rm(list = ls(pattern = "lep"))}

```

### People with Disabilities (%) by County and SCAG Region

```{r disablities}
# People with Disabilities (%) by County and SCAG Region
# Use person level weights- PWGTP; Percentages of LEP by county and SCAG; Filter to DIS == 1 
# Use weight_perc_table():
# Pass in data and calculate weighted percentages using person level weights- "PWGTP", for variable "DIS", filter_value = 1, set county to factor,  
# then rename "percentage" to "disabilities_percentage": 
dis_scag_table <- ca_pums_scag %>% weight_perc_table(var = "DIS", weight = "PWGTP", group = "county", filter_value = 1) %>% 
                                            mutate(county = factor(county, levels = county_levels)) %>% 
                                            rename(disabilities_percentage = percentage) 
dis_scag_table

# Write out table to .csv in "output/tables" folder and once the file exists remove from current environment all tibbles used to make the final table:
write_csv(dis_scag_table, here(tables_fp, "dis_scag_table.csv"))
if (file.exists(here(tables_fp, 'dis_scag_table.csv'))) {rm(list = ls(pattern = "dis"))}
```

### Disabilites by category (%) by County and SCAG Region

- 6 categories of disabilities: Self-care, Hearing, Vision, Independent, Ambulatory, Cognitive

```{r disablities_cat}
# Disabilites by category (%) by County and SCAG Region: Use person level weights- PWGTP:
# Percentages of Disabilities broken down into 6 categories and also by county and SCAG
# Title: var_code
# Value     Label
# Self-care difficulty  == DDRS
# b	N/A (Less than 5 years old)
# 1	Yes
# 2	No
# Hearing difficulty == DEAR	
# 1	Yes
# 2	No
# Vision difficulty == DEYE	
# 1	Yes
# 2	No
# Independent living difficulty == DOUT		
# b	N/A (Less than 15 years old)
# 1	Yes
# 2	No
# Ambulatory difficulty == DPHY		
# b	N/A (Less than 5 years old)
# 1	Yes
# 2	No
# Cognitive difficulty == DREM		
# b	N/A (Less than 5 years old)
# 1	Yes
# 2	2	No

# Function to return full table of weighted percentages by group and filtered to one value of a variable: weight_perc_table()
# df = dataframe of all data, var = variable to sum over,  weight = weights, group = grouping variable, filter_value = value of a variable to filter output to.
# has and if statement to drop filter_value if NULL, which it is by default

# Vector of variable names and a vector of text to add as disability_type to each tibble for each disability_var_names:
disability_var_names <- c("DDRS", "DEAR", "DEYE", "DOUT", "DPHY", "DREM")
disability_text_vars <- c("Self-care difficulty", "Hearing difficulty","Vision difficulty", "Independent living", "Ambulatory difficulty", "Cognitive difficulty")

# use map2(), to iterate over both elements of disability_list- the x = "var_names" and y ="text_vars", pass to function and use bind_rows() to turn the list of tibbles into a single tibble that is the full
# table of each disablity_type percentage by county and all of SCAG 
categories_dis_scag_table <- map2(.x = disability_var_names, .y =  disability_text_vars, 
                                  function(x,y) weight_perc_table(df = ca_pums_scag, var = x, weight = "PWGTP", group = "county", filter_value = 1) %>% 
                                                mutate(disability_type = y) %>% 
                                                select(county, disability_type, percentage)
                                  ) %>% bind_rows()
categories_dis_scag_table

# Write out table to .csv in "output/tables" folder and once the file exists remove from current environment all tibbles used to make the final table:
write_csv(categories_dis_scag_table, here(tables_fp, "categories_dis_scag_table.csv"))
if (file.exists(here(tables_fp, 'categories_dis_scag_table.csv'))) {rm(list = ls(pattern = "categories_dis"))}
```

### Educational Attainment (%) by Race/ethincity and whole SCAG Region

- 6 categories of disabilities: Self-care, Hearing, Vision, Independent, Ambulatory, Cognitive

```{r education}
# Educational Attainment (%) by Race/ethincity and whole SCAG Region
# Variable "edu", Use person level weights- PWGTP; Filter to people over 25, filter(AGEP > 25)

# Use weight_perc_table():
# Pass in data and calculate weighted percentages using person level weights- "PWGTP", for variable "edu",  
# then rename "edu" to "education_level": 
edu_perc_scag_table <- ca_pums_scag %>% filter(AGEP > 25) %>% drop_na(edu) %>% 
                            weight_perc_2groups(var = "edu", weight = "PWGTP", group1 = "county", group2 = "race",
                                                group1_levels = county_levels, group2_levels = race_levels) %>% 
                                rename(education_level = edu)
edu_perc_scag_table

# Write out table to .csv in "output/tables" folder and once the file exists remove from current environment all tibbles used to make the final table:
write_csv(edu_perc_scag_table, here(tables_fp, "edu_perc_scag_table.csv"))
if (file.exists(here(tables_fp, 'edu_perc_scag_table.csv'))) {rm(list = ls(pattern = "edu_perc"))}
```

### Median Household Income by Race/ethincity and whole SCAG Region

```{r med_hh_incom}
# Median Household Income by Race/ethincity and whole SCAG Region
# Use person level weights- WGTP; filter(RELSHIPP == 20) Only household level
# use weighted median for only households
# Get median hh income for all races for all SCAG:
scag_med_hh_income_all_races <- ca_pums_scag %>% filter(RELSHIPP == 20) %>% drop_na(housing_income) %>% select(WGTP, housing_income)  %>% 
                                             summarize(
                                               med_hh_income = round(weighted.median(housing_income, WGTP, na.rm = TRUE),2)
                                             ) %>% mutate(county = "SCAG", race = "All Races") %>% select(county, race, med_hh_income)

# Get median hh income for all races by county:
scag_med_hh_income_all_races_county <- ca_pums_scag %>% filter(RELSHIPP == 20) %>% drop_na(housing_income) %>% select(WGTP, county, housing_income) %>% 
                                             group_by(county) %>% 
                                             summarize(
                                               med_hh_income = round(weighted.median(housing_income, WGTP, na.rm = TRUE),2)
                                             ) %>% mutate(race = "All Races") %>% select(county, race, med_hh_income)


# Get median hh income for by race for all SCAG:
scag_med_hh_income_race <- ca_pums_scag %>% filter(RELSHIPP == 20) %>% drop_na(housing_income) %>% select(WGTP, housing_income, race)  %>% 
                                              group_by(race) %>% 
                                              summarize(
                                                med_hh_income = round(weighted.median(housing_income, WGTP, na.rm = TRUE),2)
                                              ) %>% mutate(county = "SCAG") %>%  select(county, race, med_hh_income) 

# Get median hh income for by race and by county:
scag_med_hh_income_race_county <- ca_pums_scag %>% filter(RELSHIPP == 20) %>% drop_na(housing_income) %>% select(WGTP, housing_income, race, county)  %>% 
                                              group_by(county, race) %>% 
                                              summarize(
                                                med_hh_income = round(weighted.median(housing_income, WGTP, na.rm = TRUE),2)
                                              ) %>%  select(county, race, med_hh_income)


# Full join all tables:
med_hh_income_scag_table <- full_join(scag_med_hh_income_all_races, scag_med_hh_income_all_races_county, by = join_by(county, race, med_hh_income)) %>% 
                                full_join(., scag_med_hh_income_race, by = join_by(county, race, med_hh_income)) %>% 
                                    full_join(., scag_med_hh_income_race_county, by = join_by(county, race, med_hh_income)) %>% 
                                        mutate(county = factor(county, levels = county_levels),
                                               race = factor(race, levels = race_levels)) %>% 
                                            arrange(county, race) %>% 
                                                rename(median_household_income = med_hh_income)
med_hh_income_scag_table

# Write out table to .csv in "output/tables" folder and once the file exists remove from current environment all tibbles used to make the final table:
write_csv(med_hh_income_scag_table, here(tables_fp, "med_hh_income_scag_table.csv"))
if (file.exists(here(tables_fp, 'med_hh_income_scag_table.csv'))) {rm(list = ls(pattern = "med_hh_income"))}
```

### Household Poverty (%) by Race/ethincity and whole SCAG Region

```{r poverty_hh}
# if poverty == "Yes"- this is if the respondent is less than 200 percent below the poverty line; Use household level weights- WGTP; Filter only households: filter(RELSHIPP == 20)
# Use weight_perc_table(): Pass in data filtered to only hh (filter(RELSHIPP == 20)), calculate weighted percentages using hh level weights- "WGTP", for variable "poverty" and filter to "poverty" == "Yes" 
poverty_hh_scag_table <- ca_pums_scag %>% filter(RELSHIPP == 20) %>% 
                                weight_perc_2groups(var = "poverty", weight = "WGTP", group1 = "county", group2 = "race", filter_value = "Yes",
                                                    group1_levels = county_levels, group2_levels = race_levels) %>% 
                                                rename(household_poverty_percentage = percentage)
poverty_hh_scag_table

# Write out table to .csv in "output/tables" folder and once the file exists remove from current environment all tibbles used to make the final table:
write_csv(poverty_hh_scag_table, here(tables_fp, "poverty_hh_scag_table.csv"))
if (file.exists(here(tables_fp, 'poverty_hh_scag_table.csv'))) {rm(list = ls(pattern = "poverty_hh"))}
```


--- 


# Write out excel workbook file with all sheets:

```{r write_excel}
# Read in completed tables and set to tibbles in current global env:
# Read in all the tables from the folder "output/tables" to a list and keep names from the files:
table_file_list <- lapply(list.files(here(tables_fp), full.names = TRUE), function(x) { read_csv(x, show_col_types = FALSE) } )

# Set names of each list element to the actual file name without path and file extension:
table_file_list <- set_names(table_file_list, tools::file_path_sans_ext(fs::path_file(list.files(here(tables_fp), full.names = TRUE))))

# Convert each list item into a tibble (map(as_tibble)) and save to the current global env (list2env(envir = .GlobalEnv)):
table_file_list %>% 
  map(as_tibble) %>%
  list2env(envir = .GlobalEnv)

### Create tabbed excel workbook for SCAG:
# Set up up a tibble named "toc" to use as a table of contents (toc) for output tabbed excel workbook named "scag_tabbed.xlsx":
# Two columns: "sheet_name" and "figure_description"
toc <- tribble(~sheet_name, ~ figure_description,
              "Figure_5",  "Figure 5. Workers who Commute by Walk, Bike, or Public Transit by Race and Ethnicity",
              "Figure_6",  "Figure 6. Householders without a Vehicle by Race and Ethnicity",
              "Figure_7",  "Figure 7. Workers’ Commute Times (Minutes) by Mode and Race and Ethnicity",
              "Figure_19", "Figure 19. Renters and Homeowners Experiencing Housing Cost Burden by Race and Ethnicity",
              "Figure_20", "Figure 20. People Living in Households Without Kitchen and Plumbing Facilities by Race and Ethnicity",
              "Figure_21",  "Figure 21. Households with Severe Overcrowding by Race and Ethniciy",
              "Figure_22",  "Figure 22. Homeownership by Race and Ethniciy",
              "Figure_28",  "Figure 28. People without Health Insurance by Race and Ethnicity",
              "Figure_39", "Figure 39. Median Hourly Wage by Race and Ethnicity",
              "Figure_40", "Figure 40. Unemployment by Race and Ethnicity",
              "Figure_41", "Figure 41. Working Poor by Race and Ethnicity",
              "Total_Population", "Total Population by County and SCAG Region",
              "Race_Ethnicity", "Race/Ethnicity Distribution (%) by County and SCAG Region",
              "Age", "Age Distribution (%) by County and SCAG Region",
              "Singe_Parent_HHs", "Single Parent Households (%) by Gender of Head of Household and then by County and SCAG Region",
              "Natl_Origin", "National Origin (% Foreign born) by County and SCAG Region",
              "LEP", "Limited English Proficiency (%) by County and SCAG Region",
              "Disablity", "People with Disabilities (%) by County and SCAG Region",
              "Categories_Disablity", "Disabilites by 6 categories (%) and then by County and SCAG Region: Self-care, Hearing, Vision, Independent, Ambulatory, Cognitive",
              "Education", "Educational Attainment (%) by Race/ethincity and whole SCAG Region",
              "Median_HH_Income", "Median Household Income by Race/ethincity and whole SCAG Region",
              "Poverty_HH","Household Poverty (%) by Race/ethincity and whole SCAG Region") 

# Write out table to new sheet in excel file for tabbed SCAG output, list is this format: ("name of new sheet" = df/tibble)
# Make a list that has the name of each sheet (sheet_name from TOC above) and the df/tibble that will populate it- 
# e.g below "walk_bike_public_scag_table" is a tibble that will populate the sheet named "Figure_5".
sheets <- list("TOC" = toc,
               "Figure_5" = walk_bike_public_scag_table,
               "Figure_6" = no_veh_scag_table,
               "Figure_7" = transport_mean_scag_table,
               "Figure_19" = housing_burden_scag_table,
               "Figure_20" = no_kitchen_plumbing_scag_table,
               "Figure_21" = overcrowded_scag_table,
               "Figure_22" = homeownership_scag_table, 
               "Figure_28" = no_hicov_scag_table,
               "Figure_39" = med_hr_wage_scag_table,
               "Figure_40" = unemployed_scag_table,
               "Figure_41" = working_poor_scag_table,
               "Total_Population" = total_pop_scag_table,
               "Race_Ethnicity" = race_perc_scag_table,
               "Age" = age_perc_scag_table,
               "Singe_Parent_HHs" = single_hh_scag_table,
               "Natl_Origin" = natl_origin_scag_table,
               "LEP" = lep_scag_table,
               "Disablity" = dis_scag_table,
               "Categories_Disablity" = categories_dis_scag_table,
               "Education" = edu_perc_scag_table,
               "Median_HH_Income" = med_hh_income_scag_table,
               "Poverty_HH" = poverty_hh_scag_table) 

# Create an output folder if it does NOT exist already:
if (!dir.exists("output")) {dir.create("output")}

# Save full workbook as an openxlsx2 wb by passing the sheet list ("sheets") to openxlsx2::write_xlsx() and destination "path/filename.xlsx", write to "output/scag_tabbed.xlsx",
# the col_widths = "auto" option will change the column widths to auto (widen them so they are legible):
scag_wb <- openxlsx2::write_xlsx(sheets, "output/scag_tabbed.xlsx", col_widths = "auto")

# use walk()- this applies functions over a vector and is only for the side-affects of the functions, in this case it will use functiosn from the openxlsx2 package to format the workbook "scag_wb":
# This call to walk() will change all sheets in workbook "scag_wb" to have a header row of bold and size 12 font:
walk(names(sheets), ~ wb_add_font(wb = scag_wb, sheet = .x, dims = wb_dims(1, 1:5), bold = TRUE, size = 12))
# This call to walk() will change all sheets in workbook "scag_wb" to have a header row of column names centered horizontally:
walk(names(sheets), ~ wb_add_cell_style(wb = scag_wb, sheet = .x, dims = wb_dims(1, 1:5), horizontal = "center"))

# Save workbook "scag_wb" to file "output/scag_tabbed.xlsx" and  if it exists it will be overwritten:
wb_save(scag_wb, file = "output/scag_tabbed.xlsx", overwrite = TRUE)

# Remove all variables created in this chunk:
rm(list = (names(table_file_list)), table_file_list, sheets, toc, scag_wb)
```

